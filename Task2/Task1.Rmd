---
title: "Proyecto para *IOT Analytics*"
subtitle: 'Tarea 1: Domain Research and Exploratory Data Analysis'
author: "Marta Venegas Pardo"
date: "1/23/2022"
output: 
  html_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
setwd("~/Desktop/UBIQUM/Advanced Data Analytics and Machine Learning/MODULE4_DEEP_ANALYTICS")
```




```{r librerias ,message=FALSE}

library(dplyr)
library(tidyverse)
library(kableExtra)

library(lubridate) # Fechas

library(imputeTS) # Tratamiento de datos faltantes

library(plotly)   # Gráficas
library(ggplot2)  # Gráficas

# install.packages("RMySQL")
library(RMySQL) # Conexión a la BBDD
```


# Plan de proyecto

- Fecha límite de entrega: 23-Feb-22
- Tareas (fechas aproximadas para completarlo):

    - Visualización (6-7 / Feb)
    - Preprocesado y preparación de los datos 
    - Series temporales: (7-12 Feb)
    
        * Forecasting
        * Descomponer
        * Suavizado exponencial (H-W)
    - Report (flexDashboard/ Shiny) (12-23 Feb)
    

# Introducción (definición del problema + objetivos)

Un desarrollador residencial regional está diseñando un gran desarrollo de viviendas de apartamentos 'Smart Home' y está buscando pruebas o razones positivas para **adoptar el uso de dispositivos de medición eléctrica (submeterings eléctricos)** utilizados para la administración de energía en Smart Homes.

Estos submeterings brindan a los propietarios análisis del uso de la energía en tiempo real. Su instalación, haría posible una reducción del consumo de energía y, como resultado, un ahorro monetario (esto es un punto que debo demostrar)

La instalación de submeterings podría ser paso hacia el objetivo del desarrollador de ofrecer hogares inteligentes altamente eficientes que brinden a los propietarios análisis de uso de energía, permitiéndoles conocer su consumo real.

## Objetivos

Los objetivos del estudio son los siguientes:

-   Analizar datos proporcionados para encontrar evidencias que respalden el proyecto de instalar submeterings eléctricos para la medición de la energía en Smart Homes.
-   Demostrar que existe la posibilidad de construir buenos modelos para predecir el consumo de energía futuro a partir de los datos.
-   Desarrollar modelos usando wifi fingerprint para predecir la posición


## Procedimiento para cumplir mis objetivos

Nuestro objetivo es analizar los datos proporcionados y tratar de elaborar un modelo que explique el consumo de energía en función del resto de variables.

# Descripción de los datos

Nuestros datos contienen información sobre mediciones de energía de una casa en Sceaux (7km of Paris, France) en los meses de Diciembre de 2006 a Noviembre de 2010 (47 meses). Contiene un total de 2075259 medidas en 10 varaibles que explicaremos a continuación

Hay demasiados datos y tengo que tomar una decisión. El salto temporal es de minutos. Ahora nos preguntamos: ¿es necesaria tanta precisión? Creo que no, podríamos tener datos mensuales, con una única medición por mes. Como las variables submetering_1, 2 y 3 me están dando energía de los subeterings, podríamos tener un único dato mensual con la suma de todas las mediciones. Quizás también sería conveniente por días

## Variables

Variables que encontramos en el dataset:

1.  Date: Fecha en formato dd/mm/yyyy

2.  Time: Hora en formato hh:mm:ss.

3.  global_active_power: potencia activa media global por minuto en el hogar (kw). Es la potencia "útil", la que consumen lls equípos eléctricos

4.  global_reactive_power:potencia reactiva media global por minuto en el hogar (kw)

5.  voltage: Voltaje medio por minuto (voltios)

6.  global_intensity: Intensidad media de corriente por minuto en el hogar (amperios) household global minute-averaged current intensity (in ampere)

7.  sub_metering_1: energía del subetering 1 (Wh de energía activa). Corresponde a:

    -   Cocina: lavavajillas, horno microondas (no placas de inducción)

8.  sub_metering_2: energía del subetering 2 (Wh de energía avtiva).Corresponde a:

    -   Lavadero: que contiene lavadora, secadora, frigorífico y luz.

9.  sub_metering_3: energía del subetering No. 3 (Wh de energía activa).Corresponde a:

    -   Termo eléctrico y aire acondicionado

10. DateTime: Fecha de la medición, en formato Fecha-Hora(minutos:segundos)

Nota: debemos pasar las variables al mismo formato. Todas son numéricas salvo las de fecha y hora.



## Extracción de los datos desde SQL

```{r}
# Conexión con la Base de datos
con = dbConnect(MySQL(), user='deepAnalytics', password='Sqltask1234!', dbname='dataanalytics2018', host='data-analytics-2018.cbrosir2cswx.us-east-1.rds.amazonaws.com')
```

```{r}
## List the tables contained in the database 
dbListTables(con) #tenemos 6 tablas
```

```{r}
## Atributos de una tabla (variables)
dbListFields(con,'yr_2006')
```

Vamos a visualizar toda la información que existe en la base de datos para entender nuestros datos

```{r}
D2006 <- dbGetQuery(con, "SELECT * FROM  yr_2006")
D2006 %>% head() %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```

Seleccionamos el día, la hora y la información de los contadores

```{r}
## Hacemos querys
yr_2006 <- dbGetQuery(con, "SELECT Date, Time, Sub_metering_1 , Sub_metering_2 , Sub_metering_3 , Global_active_power FROM  yr_2006")
# yr_2006 %>% head() %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
yr_2007 <- dbGetQuery(con, "SELECT Date, Time, Sub_metering_1 , Sub_metering_2 , Sub_metering_3 , Global_active_power FROM  yr_2007")
#yr_2007 %>%  head() %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
yr_2008 <- dbGetQuery(con, "SELECT Date, Time, Sub_metering_1 , Sub_metering_2 , Sub_metering_3 , Global_active_power FROM  yr_2008")
#yr_2008 %>%  head() %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
yr_2009 <- dbGetQuery(con, "SELECT Date, Time, Sub_metering_1 , Sub_metering_2 , Sub_metering_3 , Global_active_power FROM  yr_2009")
yr_2010 <- dbGetQuery(con, "SELECT Date, Time, Sub_metering_1 , Sub_metering_2 , Sub_metering_3 , Global_active_power FROM  yr_2010")
```


```{r}
D2006 <- dbGetQuery(con, "SELECT * FROM  yr_2006")
D2007 <- dbGetQuery(con, "SELECT * FROM  yr_2007")
D2008 <- dbGetQuery(con, "SELECT * FROM  yr_2008")
D2009 <- dbGetQuery(con, "SELECT * FROM  yr_2009")
D2010 <- dbGetQuery(con, "SELECT * FROM  yr_2010")

D2006$Global_active_power<-D2006$Global_active_power*1000/60
D2006$Global_reactive_power<-D2006$Global_reactive_power*1000/60

D2007$Global_active_power<-  D2007$Global_active_power*1000/60
D2007$Global_reactive_power<-D2007$Global_reactive_power*1000/60

D2008$Global_active_power<-  D2008$Global_active_power*1000/60
D2008$Global_reactive_power<-D2008$Global_reactive_power*1000/60

D2009$Global_active_power<-  D2009$Global_active_power*1000/60
D2009$Global_reactive_power<-D2009$Global_reactive_power*1000/60

D2010$Global_active_power<-  D2010$Global_active_power*1000/60
D2010$Global_reactive_power<-D2010$Global_reactive_power*1000/60


# DatosCompletos <- bind_rows(D2006,D2007,D2008,D2009,D2010)
# 
# ## Combinamos columnas Date y Time
# DatosCompletos<-cbind(DatosCompletos,paste(DatosCompletos$Date,DatosCompletos$Time), # stringsAsFactors=FALSE)
# colnames(DatosCompletos)[11] <-"DateTime"
# ## Movemos la nueva columna al inicio
# DatosCompletos<- DatosCompletos[,c(ncol(DatosCompletos), 1:(ncol(DatosCompletos)-1))]
# 
# 
# DatosCompletos$year <-    year(DatosCompletos$DateTime) # extraemos el año
# DatosCompletos$minute<- minute(DatosCompletos$DateTime) # extraemos el minuto
# DatosCompletos$month<-   month(DatosCompletos$DateTime) # extraemos el mes
# DatosCompletos$day<-       day(DatosCompletos$DateTime) # extraemos el día
# DatosCompletos$hour<-     hour(DatosCompletos$DateTime) # extraemos la hora
# DatosCompletos$day<-       day(DatosCompletos$DateTime) # extraemos el día
# DatosCompletos$month<- as.factor(DatosCompletos$month)
```





# Preprocesado de los datos (Limpieza de datos)

## Transformación y creación de variables de variables

Creamos un dataset con la información correspondiente a todos los años

```{r}
## Combine tables into one dataframe using dplyr
newDF <- bind_rows(yr_2006, yr_2007, yr_2008,yr_2009,yr_2010)
str(newDF)
```

Las variables que representan tiempo, deben estar en formato DateTime. Vamos a transformar los datos para poder unir la fila Date y time y así tener los datos en el formato adecuado.




```{r}
## Combinamos columnas Date y Time
Datos2 <-cbind(newDF,paste(newDF$Date,newDF$Time), stringsAsFactors=FALSE)
colnames(Datos2)[7] <-"DateTime"
## Movemos la nueva columna al inicio
Datos2 <- Datos2[,c(ncol(Datos2), 1:(ncol(Datos2)-1))]
head(Datos2)
str(Datos2)
```

Tenemos que convertir la varaible DateTime en formato horario.

```{r}
## Convertimos la variable con la función POSIXct 
## Los datos están en formato: dd/mm/yyyy  hh:mm:ss
## "%Y/%m%d/ %M:%S" obtengo un warning
Datos2$DateTime <- as.POSIXct(Datos2$DateTime, "%Y-%m-%d %M:%S" )
## Añadimos la zona horaria
attr(Datos2$DateTime, "tzone") <- "Europe/Paris"

## Visualizamos los datos
str(Datos2)
```

Formato de la variable DateTime: Fecha-Hora(minutos:segundos)

```{r}
# Creo un dataset donde elimino la variable Time y Date
Datos3 <- Datos2 %>% select(-c(2,3))
Datos3 %>% head()
```

### Extracción de la fecha con Lubridate

```{r}
Datos3$year <- year(Datos3$DateTime) # extraemos el año
Datos3$month<- month(Datos3$DateTime) # extraemos el mes
Datos3$day<-day(Datos3$DateTime) # extraemos el día
Datos3$hour<-hour(Datos3$DateTime) # extraemos la hora
Datos3$minute<- minute(Datos3$DateTime) # extraemos el minuto
Datos3$week<-week(Datos3$DateTime)
Datos3$weekday<-wday(Datos3$DateTime,week_start = 1 )
head(Datos3)
```


```{r}
## ORDENAMOS LAS COLUMNAS
Datos3 <- Datos3[,c(6,7,8,12,9,10,11,1,2,3,4,5)]
head(Datos3)
```




### Creamos una nueva variable (Energia2)

Creación de una nueva variable: Energía activa consumida en el hogar por equipos eléctricos que no han sido medidos en los subcontadores (wh) (global_active_power\*1000/60 - sub_metering_1 - sub_metering_2 - sub_metering_3)

```{r}
# La varaible *global_active_power* está en diferentes unidades que las    
# variables submeterings (Wh)

Datos2$energia2<-
(Datos2$Global_active_power*1000/60 - Datos2$Sub_metering_1 - Datos2$Sub_metering_2 - Datos2$Sub_metering_3)
Datos3$energia2<-Datos2$energia2
```


### Unificar unidades (wh)


Los datos no se encuentran todos en las mismas unidades de energía. En las varaibles correspondientes a los submedidores, la energía viene medida en Varios-hora (Wh), mientras que la energía global (global active power) viene recogida en kilovatios.

Finalmente, la unidad en la que vendrán recogida las mediciones de la energía será varios-hora (Wh)


```{r}
Datos3$Global_active_power<-Datos3$Global_active_power*1000/60
```



```{r , Radiant}
# options(repos = c(RSM = "https://radiant-rstats.github.io/minicran", CRAN = # "https://cloud.r-project.org"))
# install.packages("radiant")
# radiant::radiant()
# radiant::radiant_viewer()
# radiant::radiant_window()
```




## Datos faltantes




```{r , missing values}
# En primer lugar, construimos un dataset con todas las fechas entre la primera fecha y la última de los datos que tenemos
FechasCompletas <- seq(min(Datos3$DateTime), max(Datos3$DateTime), by = "min")
FechasCompletas  <- data.frame(DateTime = FechasCompletas )
# Hacemos Merge al conjunto de datos completo y al Datos3 para añadir NA a aquellos valores faltantes
DatosCompletos <- merge(FechasCompletas, Datos3, by = "DateTime", all.x = TRUE)
### Find missing values in my complete data
DatosCompletos<- DatosCompletos [,c(1,9,10,11,12,13)]
Miss_values <- which(is.na(DatosCompletos$Sub_metering_1) == TRUE)
```


```{r}
cat("Existe un total de :",length(Miss_values), " valores faltantes, que corresponden a un " ,round( (length(Miss_values)/nrow(Datos3))*100 , 2 ) , "% del total de datos." )
```


Vamos a imputar los datos faltantes con el dato del consumo energético existente inmediatamente anterior, ya que, al estar midiendo consumo energético por minuto, la probabilidad de que el consumo energético inmediatamente anterior sea el mismo, es alta.


```{r , imputacion}
# my_complete_data$value <- na.locf(my_complete_data$value) IMPUTACIÓN
DatosCompletos$Sub_metering_1 <-      na_locf(DatosCompletos$Sub_metering_1) 
DatosCompletos$Sub_metering_2 <-      na_locf(DatosCompletos$Sub_metering_2) 
DatosCompletos$Sub_metering_3 <-      na_locf(DatosCompletos$Sub_metering_3) 
DatosCompletos$Global_active_power <- na_locf(DatosCompletos$Global_active_power)
DatosCompletos$energia2 <-            na_locf(DatosCompletos$energia2)
```


```{r , extraemos}
DatosCompletos$year <-    year(DatosCompletos$DateTime) # extraemos el año
DatosCompletos$month<-   month(DatosCompletos$DateTime) # extraemos el mes
DatosCompletos$day<-       day(DatosCompletos$DateTime) # extraemos el día
DatosCompletos$hour<-     hour(DatosCompletos$DateTime) # extraemos la hora
DatosCompletos$minute<- minute(DatosCompletos$DateTime) # extraemos el minuto
DatosCompletos$week<-     week(DatosCompletos$DateTime)
DatosCompletos$weekday<-  wday(DatosCompletos$DateTime,week_start = 1 )
DatosCompletos<- DatosCompletos[,c(1,7,8,9,10,11,12,13,2,3,4,5,6)]
```



```{r}
# which(is.na(DatosCompletos$Sub_metering_1) == TRUE)
# Ya no hay valores faltantes
```






## Datasets con distinta granularidad


Para la correcta visualización y exploración de los datos vamos a extraer distintos conjuntos de datos con granularidad de horas, días y meses.

### Horas


```{r}
Granularidad_horas <- DatosCompletos %>% 
  group_by(year,  month,day,hour) %>%
  summarize(
     Sub_metering_1      = sum(Sub_metering_1),
     Sub_metering_2      = sum(Sub_metering_2),
     Sub_metering_3      = sum(Sub_metering_3),
     Global_active_power = sum(Global_active_power),
     energia2            = sum(energia2)
)

# 2006-12-16
Granularidad_horas<-cbind(Granularidad_horas,paste(Granularidad_horas$year,Granularidad_horas$month,Granularidad_horas$day,sep = "-"),stringsAsFactors=FALSE)
colnames(Granularidad_horas)[10] <-"Date"
Granularidad_horas<-Granularidad_horas[,c(10,1,2,3,4,5,6,7,8,9)]

Granularidad_horas$minute<-rep(1,nrow(Granularidad_horas))
Granularidad_horas <-cbind(Granularidad_horas,paste(Granularidad_horas$hour,Granularidad_horas$minute,sep = ":"),stringsAsFactors=FALSE)
colnames(Granularidad_horas)[12] <-"Time"
Granularidad_horas<-Granularidad_horas[,c(1,12,2,3,4,5,11,6,7,8,9,10)]

# Combino date and time 
Granularidad_horas <-cbind(Granularidad_horas,paste(Granularidad_horas$Date,Granularidad_horas$Time,sep = " "),stringsAsFactors=FALSE)
colnames(Granularidad_horas)[13] <-"DateTime"
Granularidad_horas<-Granularidad_horas[,c(13,1,2,3,4,5,6,7,8,9,10,11,12)]

# Tenemos que tener una columna con formato horario
Granularidad_horas$DateTime <- as.POSIXct(Granularidad_horas$DateTime, "%Y-%m-%d %H:%M" )

## Añadimos la zona horaria
attr(Granularidad_horas$DateTime , "tzone") <- "Europe/Paris"

Granularidad_horas$week<-week(Granularidad_horas$DateTime)
Granularidad_horas$weekday<-wday(Granularidad_horas$DateTime,week_start = 1 )
Granularidad_horas<-Granularidad_horas[,c(1,2,3,4,5,6,7,8,14,15,9,10,11,12,13)]
Granularidad_horas %>% head() %>% 
  kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


### Días

Para obtener granularidad de días, vamos a sumar la energía recogida en las mediciones, y obtendremos así un conjunto de datos donde cada registro corresponde a la energía total consumida ese día. Tendremos distintas variables donde recogeremos la energía de cada submedidor, la total y la total sin contar los submedidores.

```{r}
Granularidad_dias <- DatosCompletos %>% 
  group_by(year,  month,day) %>%
  summarize(
     Sub_metering_1      = sum(Sub_metering_1),
     Sub_metering_2      = sum(Sub_metering_2),
     Sub_metering_3      = sum(Sub_metering_3),
     Global_active_power = sum(Global_active_power),
     energia2            = sum(energia2)
)


Granularidad_dias<-cbind(Granularidad_dias,paste(Granularidad_dias$year,Granularidad_dias$month,Granularidad_dias$day,sep = "-"))
colnames(Granularidad_dias)[9] <-"Date"
Granularidad_dias<-Granularidad_dias[,c(9,1,2,3,4,5,6,7,8)]


# Tenemos que tener una columna con formato horario
Granularidad_dias$Date <- as.POSIXct(Granularidad_dias$Date , "%Y-%m-%d" )
## Añadimos la zona horaria
attr(Granularidad_dias$Date , "tzone") <- "Europe/Paris"

Granularidad_dias$week<-week(Granularidad_dias$Date)
Granularidad_dias$weekday<-wday(Granularidad_dias$Date,week_start = 1 )
Granularidad_dias<-Granularidad_dias[,c(1,2,3,4,10,11,5,6,7,8,9)]




Granularidad_dias %>% head() %>% 
  kable(booktabs=TRUE) %>%
  kable_styling(latex_options = "striped")
```








### Meses

Para este conjunto de datos, tenemos una única medición del consumo energético mensual, que es la suma de todas las mediciones de ese mes. Para poder tener los datos en el formato adecuado, se ha considerado que todas las mediciones corresponden al día 1 de cada mes, pero en realidad es la suma de todas las de ese mes.


```{r}
Granularidad_meses <- DatosCompletos %>% 
  group_by(year,month) %>%
  summarize(
     Sub_metering_1      = sum(Sub_metering_1),
     Sub_metering_2      = sum(Sub_metering_2),
     Sub_metering_3      = sum(Sub_metering_3),
     Global_active_power = sum(Global_active_power),
     energia2            = sum(energia2)
)


Granularidad_meses<-cbind(Granularidad_meses,
                          paste(Granularidad_meses$year,Granularidad_meses$month,
                                rep(1,nrow(Granularidad_meses)),
                                sep = "-"))
colnames(Granularidad_meses)[8] <-"Date-MY"
Granularidad_meses<-Granularidad_meses[,c(8,1,2,3,4,5,6,7)]


# Tenemos que tener una columna con formato horario
Granularidad_meses$`Date-MY` <- as.POSIXct(Granularidad_meses$`Date-MY` , "%Y-%m-%d" )
## Añadimos la zona horaria
attr(Granularidad_meses$`Date-MY` , "tzone") <- "Europe/Paris"


Granularidad_meses %>% head() %>% 
  kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```

## Exportación de los datos

```{r}
# Datos completos, con granularidad de minutos
save(DatosCompletos, file = "DF_Energia_GMinutos.RData")
# Datos con granularidad de horas
save(Granularidad_horas, file = "DF_Energia_GHoras.RData")
# Datos con granularidad diaria
save(Granularidad_dias, file = "DF_Energia_GDiaria.RData")
# Datos con granularidad mensual
save(Granularidad_meses, file = "DF_Energia_GMensual.RData")
```


















# Análisis exploratorio

## Resumen de los datos

```{r}
summary(Datos3[,9:13])
(sm1<-(1.172*100)/(18.517) ) # SBM 1
(sm2<-(1.462*100)/(18.517) ) # SBM 2
(sm3<-(5.945*100)/(18.517) ) # SBM 3
sum(sm1,sm2,sm3)
100-46.3304
```


El submetering3, que es el correspondiente al termo eléctrico y el aire acondicionado, es el que más energía está consumiendo de todos, con una media de 5.94 Wh.
Po el contrario, el submetering 2 y 3 consumen una energía similar, aunque el submetering 1, que corresponde a la cocina (lavavajillas, horno y microondas), 1.172 Wh consume un poco más que el que está en el lavadero (con la secadora, lavadora, el frigorífico y la luz) 1.46 Wh.

Sin embargo, vemos como los submeterings 1 y 2, tienen su máximo en 80 y 70 respectivamente, y el submetering que más consume de media, tiene su máximo en 31 Wh de energía.

Es decir, hay momentos en los que los submeterings 2 y 3 están consumiendo gran cantidad de energía, por ejemplo, el tiempo en que se encuentra funcionando la lavadora, o el lavavajillas y la mayoría del tiempo están apagados sin consumir nada de energía. Esto hace que en media, consuman mucho menos. Sin embargo, los dispositivos correspondientes al submetering 3, consumen menos energía pero al usarse más veces, hace que el consumo medio sea superiror al resto.



## Representaciones gráficas

### Gráfico 1. Granularidad

Debemos ajustar la granularidad de los datos para aprovechar al máximo la información que nos proporcionan los submeterings. 
Los datos han sido recogidos una vez cada minuto durante 4 años. 


```{r}
## Plot all of sub-meter 1
# plot(newDF$Sub_metering_1)
# La granularidad de minutos hace que se representen muchos puntos y que no podamos extraer información útil
```
Vamos a representar la segunda semana del año 2008


```{r}
## Subset the second week of 2008 - All Observations
houseWeek <- filter(Datos3, year == 2008 & week == 2)
## Plot subset houseWeek
plot(houseWeek$Sub_metering_2)

```
Aún tenemos demasiados datos, la granularidad se debería reducir.

```{r}
## Subset the 9th day of January 2008 - All observations
houseDay <- filter(Datos3, year == 2008 & month == 1 & day == 9)
## Plot sub-meter 1
plot_ly(houseDay,
        x = ~houseDay$DateTime,
        y = ~houseDay$Sub_metering_1, 
        type = 'scatter', mode = 'lines')
```

Vemos que el submetering 1, que corresponde a la cocina, ha registrado un consumo de energía mayor en las franjas horarias de 17:15-17:45 y de 18:15-18:30.


```{r}
## Plot sub-meter 1, 2 and 3 with title, legend and labels - All observations 
plot_ly(houseDay,
        x = ~houseDay$DateTime,
        y = ~houseDay$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January 9th, 2008",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```

Comparación de la energía registrada por los tres submeterings.

Vamos a reducir la granularidad mostrando una única observación cada 10 minutos



```{r}
## Subset the 9th day of January 2008 - 10 Minute frequency
houseDay10 <- filter(Datos3, year == 2008 & month == 1 & day == 9 & (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50))

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January 9th, 2008",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```


- Submetering 1: Cocina: ¿Cuántas veces durante este día se utilizan los electrodomésticos de la cocina? 

    * Durante este día, se han utilizado dos veces, en la franja horaria desde las 17:10 a las 18:30, siendo desde las 17:20 a las 17:40 y desde las 18:10 a las 18:30 los momentos donde se ha recogido un mayor consumo de la energía
    * Estos horarios corresponden a la hora de la cena en Francia

- Submetering 2: ¿Qué podría estar pasando en el cuarto de la lavandería?
  
    * Tenemos una lavadora, una secadora y un frigorífico. La lavadora y secadora sólo consumirán energía cuando estén en funcionamiento, es decir, cuando yo decida ponerlas en marcha.
    * Sin embargo, el frigorífico funciona por ciclos, para activar el enfriado
    * En esta gráfica observamos un patrón: se activa durante 30 minutos cada 1h y 50 minutos.
    * Tambien vemos dos tipos de repuntes de energía, uno más acusado que dura 30 minutos y otro menos acusado que dura 40 minutos. Uno podría ser el uso de la lavadora o secadora y el otro al frigorífico

- Submetering3: ¿Qué picos podrían representar el calentador de agua y el aire acondicionado?

    * El primer pico, entre las 6:40 y las 7:40 de la mañana, podría corresponder a la hora de ir al trabajo, donde se encendería el calentador de agua. 
    * Posteriormente, entre las 8:40 y las 14:30, ese pico más alargado podría corresponder al aire acondicionado, donde está la calefacción encendida.
    * Por último, los dos últimos picos entre las 20:30 y las 23, podría corresponder a ambos aparatos, de cara a calentar la casa para ir a dormir y los baños de por la tarde.


- ¿Los datos de estos tres submedidores contienen información útil para el propietario?

    * Un día individual no, habría que representar más días para ver si siempre existe este comportamiento
    

    
### Gráfico 2. Gráfica semanal

Gráfico del consumo medio semanal.

Media de todas las semanas 52 y 1 de los años anteriores y de estas dos semanas del último año.


```{r}
## Subset the 9th day of January 2008 - 10 Minute frequency
houseDay10 <- filter(Granularidad_horas, year == 2009 & week == 3 )


plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption 3rd week, 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
Se trata del consumo energético medio de cada hora.




### No me salen 

```{r}
granula
```


```{r}
SemanalTodo<-filter(Datos3,  week==52  &  year == c(2006:2008) & (hour == 0 | hour == 4 | hour == 8 |  hour == 12 |  hour == 16 | hour == 20 |  hour == 23) )


SemanalUlitmo<-filter(Datos3,  week==52 & year==2009 & (hour == 0 | hour == 4 | hour == 8 |  hour == 12 |  hour == 16 | hour == 20 |  hour == 23))



#SemanalTodo %>% select(-DateTime) %>% group_by( day,hour) %>% 
#  summarize(
#    Sub_metering_1 <- mean(Sub_metering_1),
#    Sub_metering_2 <- mean(Sub_metering_2),
#    Sub_metering_3 <- mean(Sub_metering_3),
#    Global_active_power <- mean(Global_active_power),
#    energia2<- mean(energia2)
#  )

a<-SemanalUlitmo %>% group_by(day,hour)%>%  
  summarize(
Sub_metering_1 =  mean(Sub_metering_1),
Sub_metering_2 =  mean(Sub_metering_2),
Sub_metering_3 =  mean(Sub_metering_3),
Global_active_power  = mean(Global_active_power),
energia2 =  mean(energia2)
  )
a<-a %>% filter(day==24)
```


```{r}
plot_ly(a, 
        x = ~a$hour,
        y = ~a$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~a$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~a$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#add_trace(y = ~SemanalUlitmo$Global_active_power, name = 'Global Active Power', mode = 'lines') %>% 
 layout(title = "Energía consumida. Última semana del año 2009.",
 xaxis = list(title = "Día"),
 yaxis = list (title = "Energía (watt-hours)"))
```


Utilice los tres submedidores y asegúrese de etiquetarlos.
Experimente con la granularidad.



```{r}
## Ultima semana del año 2009
houseDay10 <- filter(Datos3, year == 2009 & week == 1 
   #& (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50)
                     )

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January. Semana 1, 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```

Debemos cambiar la granularidad. 

```{r}
## Ultima semana del año 2009
houseDay10 <- filter(Datos3, year == 2010 & week == 1 
#  & (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50)
   &  minute == 30 )
                #     )

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January. Semana 1, 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```





```{r}
# houseDay10$DateTime

house <- filter(Datos3, (year == 2006 | year == 2007 | year == 2008 | year == 2009) & week == 1 
   & (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50)
                     )

ultimasemana09 <- house %>% group_by(day, minute) %>% 
  summarize(
    Sub_metering_1=mean(Sub_metering_1),
    Sub_metering_2=mean(Sub_metering_2),
    Sub_metering_3=mean(Sub_metering_3),
    Global_active_power=mean(Global_active_power),
    energia2=mean(energia2)
  )

ultimasemana09$x<-rep("2009",nrow(ultimasemana09))


mediaTodos <- houseDay10 %>% group_by(day, minute) %>% 
  summarize(
    Sub_metering_1=mean(Sub_metering_1),
    Sub_metering_2=mean(Sub_metering_2),
    Sub_metering_3=mean(Sub_metering_3),
    Global_active_power=mean(Global_active_power),
    energia2=mean(energia2)
  )

mediaTodos$x<-rep("Todos",nrow(mediaTodos))

df2<-rbind.data.frame(mediaTodos,ultimasemana09)

ggplot(df2, aes(x=day, y=Sub_metering_1, group=x)) +
  geom_line(aes(color=x))+
  geom_point(aes(color=x))
```










### Gráfico 3. Gráfico opcional

Tanto "Día" como "Semana" resaltan patrones típicos en un hogar.

¿Cuál podría ser otro período de tiempo que podría proporcionar información? 

Utilice plotly y experimentar con granularidad.


```{r}
LunesInvierno <- filter(Datos3, weekday == 1 & year==2009 & (month==1 | month==2)  )
plot_ly(Lunes,
        x = ~LunesInvierno$DateTime,
        y = ~LunesInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~LunesInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~LunesInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía de un Lunes en invierno. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
LA cocina no se usa los lunes

Debo cambiar la granularidad. Primero, voy a pintar un unico lunes por horas




```{r}
Lunes25EneroInvierno <- filter(Datos3, weekday == 1 & year==2009 & month==1 & day==26   )
plot_ly(Lunes,
        x = ~Lunes25EneroInvierno$DateTime,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 25 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
Ciclos del submetering 2
Gran consumo del submetering 3


```{r}
Lunes25EneroInvierno <- filter(Datos3, weekday == 1 & year==2009 & month==1 & day==19   )
plot_ly(Lunes,
        x = ~Lunes25EneroInvierno$DateTime,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 19 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
Lunes entre las 00 y las 6 am. Submetering 2


```{r}
Lunes25EneroInvierno <- filter(Datos3, year==2009 & month==1 & day==19 & (hour==0 | hour==2 | hour==3 | hour==4 | hour == 5 | hour ==6)   )
plot_ly(Lunes,
        x = ~Lunes25EneroInvierno$DateTime,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 19 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
A la 1 AM el submetering 3 deja de recoger consumo de energía.

### Gráfico Fin de Semana y entre semana

```{r}
FinDeSemana <- filter(Datos3, year==2009 & (weekday == 6 | weekday == 7) &  month==1 & (minute == 0  | minute == 20 |  minute == 40 | minute == 50)  )
plot_ly(Lunes,
        x = ~FinDeSemana$DateTime,
        y = ~FinDeSemana$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~FinDeSemana$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~FinDeSemana$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía un fin de semana de Enero, año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```

```{r}
EntreSemana <- filter(Datos3, year==2009 & (weekday == 1 | weekday == 2 | weekday == 3 | weekday == 4 | weekday == 5 ) &  month==1 & (minute == 0  | minute == 20 |  minute == 40 | minute == 50)  )
plot_ly(Lunes,
        x = ~FinDeSemana$DateTime,
        y = ~FinDeSemana$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~FinDeSemana$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~FinDeSemana$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía entre semana de Enero, año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```


### Gráficos opcionales


```{r}
energiaTotal<-sum(Datos3$Global_active_power)
sm1<-sum(Datos3$Sub_metering_1)
sm2<-sum(Datos3$Sub_metering_2)
sm3<-sum(Datos3$Sub_metering_3)
en2<-sum(Datos3$energia2)

count.data <- data.frame(
  class = c("Sub_metering_1","Sub_metering_2","Sub_metering_3","EnergiaNoSubmeterizada"),
  n = c(sm1,sm2,sm3,en2),
  prop = 100*c(sm1/energiaTotal,sm2/energiaTotal,sm3/energiaTotal,en2/energiaTotal)
)
# count.data

# Add label position
count.data <- count.data %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
# count.data
mycols <- c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF")

ggplot(count.data, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = paste(round(prop,3),"%") ), color = "white")+
  labs(title = "Porcentaje de energía total")+
  theme_void()
```


Percentage of total use at various times of day by each sub-meter.

```{r}
Tit<-c("Sub_metering_1",
"Sub_metering_2",
"Sub_metering_3",
"energia2")

Uno<-Granularidad_horas  %>% filter(year== 2009 & day==1 & month==1 & (hour==0 | hour==1 | hour==2 | hour==3 | hour==4 | hour==5  ) ) 
Uno<-data.frame(Tit, apply(Uno[,c(10,11,12,14)],2,sum) ) 


Dos<-Granularidad_horas  %>% filter(year== 2009 & day==1 & month==1 & (hour==7 | hour==8 | hour==9 | hour==10 | hour==11 | hour==6) ) 
Dos<-data.frame(Tit, apply(Dos[,c(10,11,12,14)],2,mean) ) 

Tres<-Granularidad_horas  %>% filter(year== 2009 & day==1 & month==1 & (hour==13 | hour==14 | hour==15 | hour==16 | hour==17 | hour==12) ) 
Tres<-data.frame(Tit, apply(Tres[,c(10,11,12,14)],2,mean) ) 


Cuatro<-Granularidad_horas  %>% filter(year== 2009 & day==1 & month==1 & (hour==19 | hour==20 | hour==21 | hour==22 | hour==23 | hour==18) ) 
Cuatro<-data.frame(Tit, apply(Cuatro[,c(10,11,12,14)],2,mean) ) 


colnames(Uno)<-c(1,2)
colnames(Dos)<-c(1,2)
colnames(Tres)<-c(1,2)
colnames(Cuatro)<-c(1,2)



```




Percentage of total power use over a day by each sub-meter.


```{r}
Gda<-Granularidad_dias %>% filter(year== 2009 & day==1 & month==1 ) %>% gather()
data<-Gda[c(6,7,8,10),]
#colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')

fig <- plot_ly(data, labels = ~key, values = ~value, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        hoverinfo = 'text',showlegend = FALSE
       # ,marker = list(colors = colors,line = list(color = '#FFFFFF', width = 1))
        )
fig <- fig %>% layout(title = 'Consumo energético. 1 Enero 2009',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


Percentage of total power use over an entire year by each sub-meter.



```{r}

```



### Otros 



```{r}
# SubMAnual <- Datos3 %>% group_by(year) %>% summarise(
#   Sub_metering_1 = sum(Sub_metering_1),
#   Sub_metering_2 = sum(Sub_metering_2),
#   Sub_metering_3 = sum(Sub_metering_3),
# ) %>%  pivot_longer(cols = -year,
#                names_to = "submetering",
#                values_to = "energia")
# SubMAnual %>% head()
# ggplot(data=SubMAnual, aes(x=year , y =energia , fill= submetering)) + 
#     geom_bar(stat="identity", position="dodge") +
#     labs(title="Energía total consumida a lo largo de los años" ,
#          caption="Fuente: Elaboración propia",
#          xlab="Año", ylab="energía kW")
```




```{r}
hist(Datos3$Sub_metering_1, main = "Energía consumida del submetering 1"  , ylim = c(0,10000))
hist(Datos3$Sub_metering_2, main = "Energía consumida del submetering 2"  , ylim = c(0,10000))
hist(Datos3$Sub_metering_3, main = "Energía consumida del submetering 3"  , ylim = c(0,10000))
```


```{r}
boxplot(Datos3$Sub_metering_1~Datos3$month, main = "Energía del submetering 1 por mes del año", ylim = c(min(Datos3$Sub_metering_1),max(Datos3$Sub_metering_1)), ylab = "kW",xlab="Mes")

boxplot(Datos3$Sub_metering_2~Datos3$month, main = "Energía del submetering 2 por mes del año", ylim = c(min(Datos3$Sub_metering_2),max(Datos3$Sub_metering_2)), ylab = "kW",xlab="Mes")

boxplot(Datos3$Sub_metering_3~Datos3$month, main = "Energía del submetering 3 por mes del año", ylim = c(min(Datos3$Sub_metering_3),max(Datos3$Sub_metering_3)), ylab = "kW",xlab="Mes")
```


```{r}
boxplot(Datos3$Sub_metering_1~Datos3$month, main = "Energía del submetering 1 por mes del año", ylim = c(0,0.5), ylab = "kW",xlab="Mes")

boxplot(Datos3$Sub_metering_2~Datos3$month, main = "Energía del submetering 2 por mes del año", ylim = c(0,1), ylab = "kW",xlab="Mes")

boxplot(Datos3$Sub_metering_3~Datos3$month, main = "Energía del submetering 3 por mes del año", ylim = c(0,2), ylab = "kW",xlab="Mes")
```












## Preparación para analizar los datos. Series temporales

- Submetering 3: 52 observaciones por año, es decir, una única observación diaria los Lunes a las 8 de la tarde. Años 2007, 2008 y 2009



```{r}
Datos3
## Subset to one observation per week on Mondays at 8:00pm for 2007, 2008 and 2009
house070809weekly <- filter(Datos3, weekday == 2 & hour == 20 & minute == 1)
## Create TS object with SubMeter3
tsSM3_070809weekly <- ts(house070809weekly$Sub_metering_3, frequency=52, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot (you may need to install these packages)
library(ggplot2)
library(ggfortify)
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM3_070809weekly, ts.colour = 'red', xlab = "Time", ylab = "Watt Hours", main = "Sub-meter 3")
## Plot sub-meter 3 with plot.ts
plot.ts(tsSM3_070809weekly)
```

- 










# Conclusiones y recomendaciones

## Aspectos destacables

## Conociendo al cliente

¿Cómo es la medición de la electricidad?

-   1.Directa:

    -   la empresa suministra electricidad a cada vivienda
    -   se paga por la cantidad de energía que se consume
    -   Tarifas más caras

-   2.Master (maestra??)

    -   la empresa suministra electricidad a todo un edificio.
    -   Los apartamentos individuales no cuentan con medidores y el consumo real de los apartamentos no se puede determinar ni utilizar como base para facturar los cargos de electricidad
    -   El costo total se divide entre los apartamentos, sin tener en cuenta lo que se consume individualmente
    -   Menos costosa

-   3.Subcontadores individuales (Submetering)

    -   Los edificios tienen un contadores maestro.
    -   Permite la medición del uso de electricidad en apartamentos individuales a través de un medidor de propiedad del edificio instalado para cada apartamento
    -   Menor precio y posibilidad de medir la energía real consumida por cada apartamento

¿Cuáles son los **beneficios** para los consumidores?

-   Ahorro de energía: se ha demostrado que cambio de la medición maestra tradicional a la submetering reduce el consumo de electricidad de los residentes en los apartamentos entre un 10 y un 26 por ciento.
-   Menor coste
-   Asignación más justa de los costos de energía (cada vivienda paga por lo que consume de energía), se benefician todos los vecinos salvo los que consumen en exceso
-   Beneficios para los propietarios
-   Beneficios para la empresa y la sociedad: reducir el desperdicio de energía y aplazar la necesidad de ubicar, construir o adquirir capacidad de generación eléctrica, también al reducir el uso de combustibles fósiles ( ej., petróleo), que siguen siendo la principal fuente de generación de energía en muchos lugares. Reducir el uso de combustibles fósiles es un paso gigante hacia la mejora del medio ambiente al mejorar la calidad del aire

¿Cuáles son los **inconveientes** para el desarrollo o implementación de esta técnica?

-   Costo: su implementación implica una inversión de alrededor de \$500 por punto de implementación y el propietario es responsable de todo el mantenimiento y la facturación a los arrendatarios. No todo el mundo está dispuesto a asumir este coste

-   Cobros por:

    -   Potencia consumida
    -   Alquiler del equipo
