---
title: "Analisis exploratorio. Graficas"
subtitle: "IOT Analytics"
author: "Marta Venegas Pardo"
date: "2/6/2022"
output: 
  rmdformats::readthedown:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
pkgdown:
  as_is: true    
---




```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "80")
knitr::opts_chunk$set(
  echo = FALSE, cache = FALSE, prompt = FALSE,
  tidy = FALSE, comment = NA,
  message = FALSE, warning = FALSE
)
opts_knit$set(width = 80)
setwd("~/Desktop/UBIQUM/Advanced Data Analytics and Machine Learning/MODULE4_DEEP_ANALYTICS")
```



```{r librerias ,message=FALSE}
library(dplyr)
library(tidyverse)
library(kableExtra)
library(DT) # DataTables

library(lubridate) # Fechas

library(imputeTS) # Tratamiento de datos faltantes

library(plotly)   # Gráficas
library(ggplot2)  # Gráficas

# install.packages("RMySQL")
library(RMySQL) # Conexión a la BBDD
```



```{r , cargaDatos}
load(file="Datos/DF_Energia_GMinutos.RData")
load(file="Datos/DF_Energia_GHoras.RData")
load(file="Datos/DF_Energia_GDiaria.RData")
load(file="Datos/DF_Energia_GMensual.RData")
```


# Análisis exploratorio

En este apartado veremos un análisis profundo del consumo energético, además añadiremos gráficas que nos muestren el comportamiento del consumidor.

Trataremos de responder a las siguientes preguntas:

* ¿Cuáles son los patrones típicos de uso de energía para cada submedidor?
* ¿Son ciertos estos patrones "típicos" para el período de tiempo en cuestión? De no ser así, ¿qué se puede usar, si es que se puede usar algo, para ayudar a respaldar el uso de submedidores?
* ¿Hay alguna recomendación para las preguntas que deberíamos estar haciendo?

## Resumen de los datos

```{r}
summary(DatosCompletos[,9:13])
```

Consumo energético medio por minuto (Wh):

- Submedidor 1: 1.11 Wh
- Submedidor 2: 1.28
- Submedidor 3: 6.417
- Energía global: 18.103
- Energía total sin submedidores: 9.287




El submedidor 3, correspondiente al termo eléctrico y el aire acondicionado, es el que más energía está consumiendo de todos, con una media de 6.41 Wh.
Po el contrario, los submedidores 1 y 2 han recogido un consumo de energía similar, aunque el submedidor 1, que corresponde a la cocina (lavavajillas, horno y microondas), 1.172 Wh consume un poco menos que el que está en el lavadero (con la secadora, lavadora, el frigorífico y la luz) 1.28 Wh.

Sin embargo, vemos como los submedidores 1 y 2, registran su máximo de consumo en 88 y 80 Wh respectivamente, y el submedidor que más consume de media, que es el 3, registra su máximo en 31 Wh de energía.

Es decir, hay momentos en los que los submedidores 2 y 3 están consumiendo gran cantidad de energía, por ejemplo, el tiempo en que se encuentra funcionando la lavadora, o el lavavajillas y la mayoría del tiempo están apagados sin consumir nada de energía. Esto hace que en media, consuman mucho menos. Sin embargo, los dispositivos correspondientes al submedidor 3, consumen menos energía pero su consumo cuando se usan hace que la media sea bastante superior.



```{r}
DatosCompletos[which.min(DatosCompletos$energia2),-c(1:8)]
```





## Representaciones gráficas

### Gráfico Granularidad

Debemos ajustar la granularidad de los datos para aprovechar al máximo la información que nos proporcionan los submeterings. 
Los datos han sido recogidos una vez cada minuto durante 4 años, lo que hace que tengamos un total de `r nrow(DatosCompletos)` mediciones de energía, lo que hace que para mostrar la información que queremos, tengamos que utilizar diferentes granularidades.

```{r}
## Plot all of sub-meter 1
# plot(DatosCompletos$Sub_metering_1)
# La granularidad de minutos hace que se representen muchos puntos y que no podamos extraer información útil
```
Vamos a representar gráficamente el consumo energético por minuto del submedidor 1, correspondiente a la cocina. Repreentaremos los datos de la segunda semana del año 2008.


```{r}
## Subset the second week of 2008 - All Observations
houseWeek <- filter(DatosCompletos, year == 2008 & week == 2)
## Plot subset houseWeek
plot(houseWeek$Sub_metering_1)
```
Aún tenemos demasiados datos y no podemos extraer demasiada información, la granularidad se debería reducir.

### Gráfico 1. Energía correspondiente a un único día




```{r}
## Subset the 9th day of January 2008 - All observations
houseDay <- filter(DatosCompletos, year == 2008 & month == 1 & day == 9)
## Plot sub-meter 1
# plot_ly(houseDay,
#         x = ~houseDay$DateTime,
#         y = ~houseDay$Sub_metering_1, 
#         type = 'scatter', mode = 'lines')

# Vemos que el submetering 1, que corresponde a la cocina, ha registrado un consumo de # energía mayor en las franjas horarias de 17:15-17:45 y de 18:15-18:30.

```


Vamos a representar el consumo energético de los submedidores el día 9 de Enero del año 2008.

```{r}
## Plot sub-meter 1, 2 and 3 with title, legend and labels - All observations 
plot_ly(houseDay,
        x = ~houseDay$DateTime,
        y = ~houseDay$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January 9th, 2008",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```



Queremos hacer una comparación de la energía registrada por los tres submeterings, pero para ello, vamos a reducir la granularidad mostrando una única observación cada 10 minutos



```{r}
## Subset the 9th day of January 2008 - 10 Minute frequency
houseDay10 <- filter(DatosCompletos, year == 2008 & month == 1 & day == 9 & (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50))

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January 9th, 2008",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```


- Submetering 1: Cocina: ¿Cuántas veces durante este día se utilizan los electrodomésticos de la cocina? 

    * Durante este día, se han utilizado dos veces, en la franja horaria desde las 17:10 a las 18:30, siendo desde las 17:20 a las 17:40 y desde las 18:10 a las 18:30 los momentos donde se ha recogido un mayor consumo de la energía
    * Estos horarios corresponden a la hora de la cena en Francia

- Submetering 2: ¿Qué podría estar pasando en el cuarto de la lavandería?
  
    * Tenemos una lavadora, una secadora y un frigorífico. La lavadora y secadora sólo consumirán energía cuando estén en funcionamiento, es decir, cuando yo decida ponerlas en marcha.
    * Sin embargo, el frigorífico funciona por ciclos, para activar el enfriado
    * En esta gráfica observamos un patrón: se activa durante 30 minutos cada 1h y 50 minutos.
    * Tambien vemos dos tipos de repuntes de energía, uno más acusado que dura 30 minutos y otro menos acusado que dura 40 minutos. Uno podría ser el uso de la lavadora o secadora y el otro al frigorífico

- Submetering3: ¿Qué picos podrían representar el calentador de agua y el aire acondicionado?

    * El primer pico, entre las 6:40 y las 7:40 de la mañana, podría corresponder a la hora de ir al trabajo, donde se encendería el calentador de agua. 
    * Posteriormente, entre las 8:40 y las 14:30, ese pico más alargado podría corresponder al aire acondicionado, donde está la calefacción encendida.
    * Por último, los dos últimos picos entre las 20:30 y las 23, podría corresponder a ambos aparatos, de cara a calentar la casa para ir a dormir y los baños de por la tarde.


- ¿Los datos de estos tres submedidores contienen información útil para el propietario?

    * Un día individual no, habría que representar más días para ver si siempre existe este comportamiento
    

    
### Gráfico 2. Gráfica semanal

Gráfico del consumo energético medio semanal.

Comparación del consumo energético medio diario del año 2009 y del resto de años. Así veremos si en el último año, el consumo medio diario sigue la misma tendencia que los años anteriores.


```{r}
Media09<-filter(Granularidad_dias, year == 2009  ) %>% group_by(weekday) %>% 
  summarize ( 
    Sub_metering_1 = mean(Sub_metering_1),
    Sub_metering_2 = mean(Sub_metering_2),
    Sub_metering_3 = mean(Sub_metering_3)
    )


EnergiaMedia<-filter(Granularidad_dias, year != 2009  ) %>% group_by(weekday) %>% 
  summarize ( 
    Sub_metering_1 = mean(Sub_metering_1),
    Sub_metering_2 = mean(Sub_metering_2),
    Sub_metering_3 = mean(Sub_metering_3)
    )
plot_ly(EnergiaMedia, 
        x = ~EnergiaMedia$weekday,
        y = ~EnergiaMedia$Sub_metering_1,
        name = 'Cocina',  type = 'bar') %>% 
   add_trace(x~Media09$weekday,
             y = ~Media09$Sub_metering_1,
             name = "Cocina" , line=list(color='blue'), 
             type = 'scatter', 
             mode = 'lines+markers',marker = list(
                 color = "blue"
               )) %>% 
    add_trace(x~EnergiaMedia$weekday,
             y = ~EnergiaMedia$Sub_metering_2,
             name = "Lavadero" ,
             type = 'bar') %>% 
     add_trace(x~Media09$weekday,
             y = ~Media09$Sub_metering_2,
             name = "Lavadero" , line=list(color='green'), 
             type = 'scatter',
             mode = 'lines+markers',marker = list(
                 color = "green"
               )) %>% 
      add_trace(x~EnergiaMedia$weekday,
             y = ~EnergiaMedia$Sub_metering_3,
             name = 'Termo y AC' ,
             type = 'bar') %>% 
     add_trace(x~Media09$weekday,
             y = ~Media09$Sub_metering_3,
             name = 'Termo y AC' ,line=list(color='blueviolet'), 
             type = 'scatter', 
             mode = 'lines+markers',marker = list(
                 color = "blueviolet"
               )) %>% 
  layout(title = "Comparación del consumo energético semanal medio \n Año 2009 vs años 2006-2008",
 xaxis = list(title = "Día de la semana", 
              ticktext=list("Lunes", "Martes", "Miércoles", "Jueves","Viernes","Sábado","Domingo"),
               tickvals=list(1,2,3,4,5,6,7)),
 yaxis = list (title = "Energía media (Vatios-hora)")
 )
```






A continuación vamos a ver un gráfico 
s+dfsgd
sg


```{r}
UltimaSemana09<- filter(Granularidad_dias, year == 2009 & week == 52 )
# Consumo total medio según dia.
UltimaSemana09_OtrosAños <- filter(Granularidad_dias, year != 2009 & week == 52 ) %>% 
  group_by(weekday) %>% 
  summarize ( 
    Sub_metering_1 = mean(Sub_metering_1),
    Sub_metering_2 = mean(Sub_metering_2),
    Sub_metering_3 = mean(Sub_metering_3)
    )
plot_ly(     UltimaSemana09, 
        x = ~UltimaSemana09$Date,
        y = ~UltimaSemana09$Sub_metering_1,
        name = 'Cocina', 
        type = 'scatter', mode = 'lines+markers') %>%
 add_trace(y = ~UltimaSemana09$Sub_metering_2, name = 'Lavadero',
          line=list(color='rgb(254, 237, 108)'),
          marker = list(color =   'rgb(243, 221, 63  )'),
           mode = 'lines+markers') %>%
 add_trace(y = ~UltimaSemana09$Sub_metering_3,
           name = 'Termo y AC', 
           line=list(color='rgb(150, 218, 108)'), 
           marker = list(color = 'rgb(150, 218, 108)'),
           mode = 'lines+markers') %>%
 add_trace(x~UltimaSemana09_OtrosAños$weekday,
             y = ~UltimaSemana09_OtrosAños$Sub_metering_1,
             name = 'Cocina' , marker = list(color = 'rgb(63, 148, 210)'),
             type = 'bar') %>% 
   add_trace(x~UltimaSemana09_OtrosAños$weekday,
             y = ~UltimaSemana09_OtrosAños$Sub_metering_2,
             name = 'Lavadero' ,   marker = list(color = 'rgb(254, 237, 108)'),
             type = 'bar') %>% 
     add_trace(x~UltimaSemana09_OtrosAños$weekday,
             y = ~UltimaSemana09_OtrosAños$Sub_metering_3,
             name = 'Termo y AC' ,   marker = list(color = 'rgb(150, 218, 108)'),
             type = 'bar') %>% 

  
  
  
 layout(title = "Comparación del consumo energético semanal \n Año 2009 vs Años 2006-2008",
 xaxis = list(title = "Día de la semana", 
              ticktext=list("24",
                            "25", 
                            "26", 
                            "27",
                            "28",
                            "29",
                            "30"),
               tickvals=list(
                              "2009-12-24" ,
                              "2009-12-25",
                              "2009-12-26" ,
                              "2009-12-27",
                              "2009-12-28" ,
                              "2009-12-29",
                              "2009-12-30")
              ),
 yaxis = list (title = "Energía (Vatios-Hora)"))
```




















### No me salen 




```{r}
SemanalTodo<-filter(DatosCompletos ,  week==52  &  year == c(2006:2008) & (hour == 0 | hour == 4 | hour == 8 |  hour == 12 |  hour == 16 | hour == 20 |  hour == 23) )


SemanalUlitmo<-filter(DatosCompletos,  week==52 & year==2009 & (hour == 0 | hour == 4 | hour == 8 |  hour == 12 |  hour == 16 | hour == 20 |  hour == 23))


```


```{r}
# plot_ly(a, 
#         x = ~a$hour,
#         y = ~a$Sub_metering_1,
#         name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
#  add_trace(y = ~a$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
#  add_trace(y = ~a$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
# #add_trace(y = ~SemanalUlitmo$Global_active_power, name = 'Global Active Power', mode = # 'lines') %>% 
#  layout(title = "Energía consumida. Última semana del año 2009.",
#  xaxis = list(title = "Día"),
#  yaxis = list (title = "Energía (watt-hours)"))
```


Utilice los tres submedidores y asegúrese de etiquetarlos.
Experimente con la granularidad.



```{r}
## Ultima semana del año 2009
houseDay10 <- filter(DatosCompletos, year == 2009 & week == 1 
   #& (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50)
                     )

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January. Semana 1, 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```

Debemos cambiar la granularidad. 

```{r}
## Ultima semana del año 2009
houseDay10 <- filter(DatosCompletos, year == 2010 & week == 1 
#  & (minute == 0 | minute == 10 | minute == 20 | minute == 30 | minute == 40 | minute == 50)
   &  minute == 30 )
                #     )

## Plot sub-meter 1, 2 and 3 with title, legend and labels - 10 Minute frequency
plot_ly(houseDay10, 
        x = ~houseDay10$DateTime,
        y = ~houseDay10$Sub_metering_1,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~houseDay10$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
 layout(title = "Power Consumption January. Semana 1, 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
















### Gráfico 3. Gráfico opcional

Tanto "Día" como "Semana" resaltan patrones típicos en un hogar.

¿Cuál podría ser otro período de tiempo que podría proporcionar información? 

Utilice plotly y experimentar con granularidad.


```{r}
LunesInvierno <- filter(DatosCompletos, weekday == 1 & year==2009 & (month==1 | month==2)  )
plot_ly(Lunes,
        x = ~LunesInvierno$DateTime,
        y = ~LunesInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~LunesInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~LunesInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía de un Lunes en invierno. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
LA cocina no se usa los lunes

Debo cambiar la granularidad. Primero, voy a pintar un unico lunes por horas




```{r}
Lunes25EneroInvierno <- filter(DatosCompletos, weekday == 1 & year==2009 & month==1 & day==26   )
plot_ly(Lunes,
        x = ~Lunes25EneroInvierno$DateTime,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 25 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
Ciclos del submetering 2
Gran consumo del submetering 3


```{r}
Lunes25EneroInvierno <- filter(DatosCompletos, weekday == 1 & year==2009 & month==1 & day==19   )
plot_ly(Lunes,
        x = ~Lunes25EneroInvierno$DateTime,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 19 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
Lunes entre las 00 y las 6 am. Submetering 2


```{r}
Lunes25EneroInvierno <- filter(Granularidad_dias, year==2009 & month==1 & day==19   )
plot_ly(Lunes25EneroInvierno,
        x = ~Lunes25EneroInvierno$Date,
        y = ~Lunes25EneroInvierno$Sub_metering_3,
        name = 'Kitchen', type = 'scatter', mode = 'lines') %>% 
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_2, name = 'Laundry Room', mode = 'lines') %>%
 add_trace(y = ~Lunes25EneroInvierno$Sub_metering_3, name = 'Water Heater & AC', mode = 'lines') %>%
#  add_trace(y = ~LunesInvierno$Global_active_power, name = 'GlobalActivePower', mode = 'lines') # %>%
 layout(title = "Consumo de energía Lunes 19 de Enero. Año 2009",
 xaxis = list(title = "Time"),
 yaxis = list (title = "Power (watt-hours)"))
```
A la 1 AM el submetering 3 deja de recoger consumo de energía.



### Gráfico de comparación consumo mensual

```{r}
Mensual07 <- Granularidad_meses %>% filter(year==2007)
graf07<-plot_ly(x=~Mensual07$`Date-MY`,type = 'scatter') %>%
   add_trace(y = ~Mensual07$Sub_metering_1, name = 'Cocina', type = 'scatter', mode = 'lines+markers'
           ,
           line=list(color='rgb(199, 0, 57 )'),
           marker = list(color =   'rgb(199, 0, 57  )')) %>% 
 add_trace(y = ~Mensual07$Sub_metering_2, name = 'Lavadero', 
           mode ='lines+markers',
           line=list(color='rgb(254, 237, 108)'),
           marker = list(color =   'rgb(243, 221, 63  )')) %>%
 add_trace(y = ~Mensual07$Sub_metering_3, name = 'Calefacción & AC', mode = 'lines+markers'
           ,
           line=list(color='rgb(150, 218, 108)'),
           marker = list(color ='rgb(150, 218, 108)')) %>%
 layout(title = "Evolución del consumo energético mensual. Año 2007",
 xaxis = list(title = "2007",
              tickvals=list( "2007-01" ,
                             "2007-02"  ,
                             "2007-03" ,
                             "2007-04" ,
                             "2007-05"  ,
                             "2007-06",
                             "2007-07" ,
                             "2007-08"  ,
                             "2007-09",
                             "2007-10" ,
                             "2007-11"  ,
                             "2007-12" )
              ),
 yaxis = list (title = "Energía (Varios-hora)"))


Mensual08 <- Granularidad_meses %>% filter(year==2008)
graf08<-plot_ly(x=~Mensual08$`Date-MY`, type = 'scatter') %>%
   add_trace(y = ~Mensual08$Sub_metering_1, name = 'Cocina', type = 'scatter', mode = 'lines+markers'
           ,
           line=list(color='rgb(199, 0, 57 )'),
           marker = list(color =   'rgb(199, 0, 57  )')) %>% 
 add_trace(y = ~Mensual08$Sub_metering_2, name = 'Lavadero', mode = 'lines+markers'
           ,
           line=list(color='rgb(254, 237, 108)'),
           marker = list(color =   'rgb(243, 221, 63  )')) %>%
 add_trace(y = ~Mensual08$Sub_metering_3, name = 'Calefacción & AC', mode = 'lines+markers'
           ,
           line=list(color='rgb(150, 218, 108)'),
           marker = list(color ='rgb(150, 218, 108)')) %>%
 layout(title = "Año 2008",
 xaxis = list(title = "2008",
              tickvals=list( "2008-01" ,
                             "2008-02"  ,
                             "2008-03" ,
                             "2008-04" ,
                             "2008-05"  ,
                             "2008-06",
                             "2008-07" ,
                             "2008-08"  ,
                             "2008-09",
                             "2008-10" ,
                             "2008-11"  ,
                             "2008-12" )
              ),
 yaxis = list (title = "Energía (Varios-hora)")
)




Mensual09 <- Granularidad_meses %>% filter(year==2009)
graf09<-plot_ly(x=~Mensual09$`Date-MY`,type = 'scatter') %>%
   add_trace(y = ~Mensual09$Sub_metering_1, name = 'Cocina', type = 'scatter', mode = 'lines+markers'
           ,
           line=list(color='rgb(199, 0, 57 )'),
           marker = list(color =   'rgb(199, 0, 57  )')) %>% 
 add_trace(y = ~Mensual09$Sub_metering_2, name = 'Lavadero', mode ='lines+markers'
           ,
           line=list(color='rgb(254, 237, 108)'),
           marker = list(color =   'rgb(243, 221, 63  )')) %>%
 add_trace(y = ~Mensual09$Sub_metering_3, name = 'Calefacción & AC', mode = 'lines+markers'
           ,
           line=list(color='rgb(150, 218, 108)'),
           marker = list(color ='rgb(150, 218, 108)')) %>%
 layout(title = "Evolución del consumo energético mensual. Año 2009",
 xaxis = list(title = "2009",
              ticktext=list("2009"),
               tickvals=list("2009-01" ,
                             "2009-02"  ,
                             "2009-03" ,
                             "2009-04" ,
                             "2009-05"  ,
                             "2009-06",
                             "2009-07" ,
                             "2009-08"  ,
                             "2009-09",
                             "2009-10" ,
                             "2009-11"  ,
                             "2009-12" )
              ),
 yaxis = list (title = "Energía (Varios-hora)"))



Mensual10 <- Granularidad_meses %>% filter(year==2010)
graf10<-plot_ly(x=~Mensual10$`Date-MY`,type = 'scatter') %>%
   add_trace(y = ~Mensual10$Sub_metering_1, name = 'Cocina', type = 'scatter', mode = 'lines+markers'
           ,
           line=list(color='rgb(199, 0, 57 )'),
           marker = list(color =   'rgb(199, 0, 57  )')) %>% 
  
 add_trace(y = ~Mensual10$Sub_metering_2, name = 'Lavadero', mode = 'lines+markers'
           ,
           line=list(color='rgb(254, 237, 108)'),
           marker = list(color =   'rgb(243, 221, 63  )')) %>%
 add_trace(y = ~Mensual10$Sub_metering_3, name = 'Calefacción & AC', mode = 'lines+markers'
           ,
           line=list(color='rgb(150, 218, 108)'),
           marker = list(color ='rgb(150, 218, 108)')) %>%
 layout(
 xaxis = list(title = "2010",
              ticktext=list("2010"),
               tickvals=list("2010-01" ,
                             "2010-02"  ,
                             "2010-03" ,
                             "2010-04" ,
                             "2010-05"  ,
                             "2010-06",
                             "2010-07" ,
                             "2010-08"  ,
                             "2010-09",
                             "2010-10" ,
                             "2010-11"  ,
                             "2010-12" )
              )
 # yaxis = list (title = "Energía (Varios-hora)")
 )


fig <- subplot(graf07, graf08, graf09, graf10, nrows = 2) %>%
  layout( title = 'Evolución del consumo energético mensual, años 2007-2010'
        )
fig
```


### Gráficos opcionales


```{r}
energiaTotal<-sum(DatosCompletos$Global_active_power)
sm1<-sum(DatosCompletos$Sub_metering_1)
sm2<-sum(DatosCompletos$Sub_metering_2)
sm3<-sum(DatosCompletos$Sub_metering_3)
en2<-sum(DatosCompletos$energia2)

count.data <- data.frame(
  class = c("Sub_metering_1","Sub_metering_2","Sub_metering_3","EnergiaNoSubmeterizada"),
  n = c(sm1,sm2,sm3,en2),
  prop = 100*c(sm1/energiaTotal,sm2/energiaTotal,sm3/energiaTotal,en2/energiaTotal)
)
# count.data

# Add label position
count.data <- count.data %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
# count.data
mycols <- c("#0073C2FF", "#EFC000FF", "#868686FF", "#CD534CFF")

ggplot(count.data, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = paste(round(prop,3),"%") ), color = "white")+
  labs(title = "Porcentaje de energía total")+
  theme_void()
```

#### Porcentaje del uso total varias veces de un día
Percentage of total use at various times of day by each sub-meter.

```{r}
Tit<-c("Cocina",
"Lavadero",
"Termo eléctrico",
"global_active_power",
"energia2")


Uno<-Granularidad_horas  %>% filter(year== 2009 & day==2 & month==1 & (hour==0 | hour==1 | hour==2 | hour==3 | hour==4 | hour==5  ) ) 
Uno<-data.frame(Tit, apply(Uno[,c(11,12,13,14,15)],2,sum) )
Uno<-data.frame(key=c("Cocina","Lavadero","Termo eléctrico","No submeterizados"),
           value=c(round((Uno[1,2]/Uno[4,2])*100,2),
                   round((Uno[2,2]/Uno[4,2])*100,2),
                   round((Uno[3,2]/Uno[4,2])*100,2),
                   round((Uno[5,2]/Uno[4,2])*100,2)
  ))
Uno

Dos<-Granularidad_horas  %>% filter(year== 2009 & day==2 & month==1 & (hour==7 | hour==8 | hour==9 | hour==10 | hour==11 | hour==6) ) 
Dos<-data.frame(Tit, apply(Dos[,c(11,12,13,14,15)],2,sum) )
Dos<-data.frame(key=c("Cocina","Lavadero","Termo eléctrico","No submeterizados"),
           value=c(round((Dos[1,2]/Dos[4,2])*100,2),
                   round((Dos[2,2]/Dos[4,2])*100,2),
                   round((Dos[3,2]/Dos[4,2])*100,2),
                   round((Dos[5,2]/Dos[4,2])*100,2)
  ))
Tres<-Granularidad_horas  %>% filter(year== 2009 & day==2 & month==1 & (hour==13 | hour==14 | hour==15 | hour==16 | hour==17 | hour==12) ) 
Tres<-data.frame(Tit, apply(Tres[,c(11,12,13,14,15)],2,mean) ) 
Tres<-data.frame(key=c("Cocina","Lavadero","Termo eléctrico","No submeterizados"),
           value=c(round((Tres[1,2]/Tres[4,2])*100,2),
                   round((Tres[2,2]/Tres[4,2])*100,2),
                   round((Tres[3,2]/Tres[4,2])*100,2),
                   round((Tres[5,2]/Tres[4,2])*100,2)
  ))
Cuatro<-Granularidad_horas  %>% filter(year== 2009 & day==2 & month==1 & (hour==19 | hour==20 | hour==21 | hour==22 | hour==23 | hour==18) ) 
Cuatro<-data.frame(Tit, apply(Cuatro[,c(11,12,13,14,15)],2,mean) ) 
Cuatro<-data.frame(key=c("Cocina","Lavadero","Termo eléctrico","No submeterizados"),
           value=c(round((Cuatro[1,2]/Cuatro[4,2])*100,2),
                   round((Cuatro[2,2]/Cuatro[4,2])*100,2),
                   round((Cuatro[3,2]/Cuatro[4,2])*100,2),
                   round((Cuatro[5,2]/Cuatro[4,2])*100,2)
  ))

fig <- plot_ly()
fig <- fig %>% add_pie(data = Uno, labels = ~key, values = ~value,
                       title = '0-5 h',
                         name = "Cut", domain = list(row = 0, column = 0))
fig <- fig %>% add_pie(data = Dos, labels = ~key, values = ~value, title = '6-12 h',
                       name = "Color", domain = list(row = 0, column = 1))
fig <- fig %>% add_pie(data = Tres, ~key, values = ~value, title = '13-17 h',
                       name = "Clarity", domain = list(row = 1, column = 0))
fig <- fig %>% add_pie(data = Cuatro, ~key, values = ~value, title = '18-23 h',
                       name = "Clarity", domain = list(row = 1, column = 1))
fig <- fig %>% layout(title = 'Consumo energético, 2 de Enero de 2009', showlegend = T,
                      grid=list(rows=2, columns=2),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```


#### Porcentaje del uso total un día

Percentage of total power use over a day by each sub-meter.


```{r}
Gda<-data.frame(Granularidad_dias %>% filter(year== 2009 & day==2 & month==1 ) %>% select(c(7,8,9,10,11) ) %>% gather() ) 
Gda
Porcentaje_2_Enero_09<-data.frame(key=c("Cocina","Lavadero","Termo eléctrico","No submeterizados"),
           value=c(round((Gda[3,2]/Gda[6,2])*100,2),
                   round((Gda[4,2]/Gda[6,2])*100,2),
                   round((Gda[5,2]/Gda[6,2])*100,2),
                   round((Gda[7,2]/Gda[6,2])*100,2)
  ))


fig <- plot_ly(Porcentaje_2_Enero_09, labels = ~key, values = ~value, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        hoverinfo = 'text',showlegend = FALSE
       # ,marker = list(colors = colors,line = list(color = '#FFFFFF', width = 1))
        )
fig <- fig %>% layout(title = 'Consumo energético. 2 Enero 2009',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig
```

#### Porcentaje del uso total durante un año completo

Percentage of total power use over an entire year by each sub-meter.



```{r}
PorcAnual<-Granularidad_meses %>% group_by(year) %>% 
   summarize(
    Sub_metering_1=sum(Sub_metering_1),
    Sub_metering_2=sum(Sub_metering_2),
    Sub_metering_3=sum(Sub_metering_3),
    energia2=sum(energia2)
  )

Anual6<-PorcAnual[1,-1] %>% gather()

fig06 <- plot_ly(Anual6, labels = ~key, values = ~value, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        hoverinfo = 'text',showlegend = FALSE
       # ,marker = list(colors = colors,line = list(color = '#FFFFFF', width = 1))
        )
fig06 <- fig06 %>% layout(title = 'Consumo energético. Año 2006',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))
fig06

Anual7<-PorcAnual[2,-1] %>% gather()
Anual8<-PorcAnual[3,-1] %>% gather()
Anual9<-PorcAnual[4,-1] %>% gather()
Anual10<-PorcAnual[5,-1] %>% gather()

fig <- plot_ly()
fig <- fig %>% add_pie(data = Anual7, labels = ~key, values = ~value,
                       title = 'Año 2007',
                         name = "Cut", domain = list(row = 0, column = 0))
fig <- fig %>% add_pie(data = Anual8, labels = ~key, values = ~value, title = 'Año 2008',
                       name = "Color", domain = list(row = 0, column = 1))
fig <- fig %>% add_pie(data = Anual9, ~key, values = ~value, title = 'Año 2009',
                       name = "Clarity", domain = list(row = 1, column = 0))
fig <- fig %>% add_pie(data = Anual10, ~key, values = ~value, title = 'Año 2010',
                       name = "Clarity", domain = list(row = 1, column = 1))
fig <- fig %>% layout(title = 'Porcentaje del total de consumo energético', showlegend = T,
                      grid=list(rows=2, columns=2),
                      xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
                      yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

fig


```

















