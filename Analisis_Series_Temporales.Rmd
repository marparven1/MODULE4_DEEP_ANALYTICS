---
title: "Análisis de Series Temporales"
subtitle: "IOT Analytics"
author: "Marta Venegas Pardo"
date: "2/9/2022"
output: 
  rmdformats::readthedown:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
pkgdown:
  as_is: true    
---



```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "80")
knitr::opts_chunk$set(
  echo = TRUE, cache = FALSE, prompt = FALSE,
  tidy = FALSE, comment = NA,
  message = FALSE, warning = FALSE
)
opts_knit$set(width = 80)
# setwd("~/Desktop/UBIQUM/Advanced Data Analytics and Machine Learning/MODULE4_DEEP_ANALYTICS")
```



```{r librerias ,message=FALSE}
library(dplyr)
library(tidyverse)
library(kableExtra)
library(DT) # DataTables



library(imputeTS) # Tratamiento de datos faltantes

library(plotly)   # Gráficas
library(ggplot2)  # Gráficas
library(ggfortify)
library(gridExtra)

library(forecast) # Tratamiento de series temporales
```



```{r , cargaDatos}
load(file="Datos/DF_Energia_GMinutos.RData")
load(file="Datos/DF_Energia_GHoras.RData")
load(file="Datos/DF_Energia_GDiaria.RData")
load(file="Datos/DF_Energia_GMensual.RData")
```



# Objetivo

Proyección del consumo energético a través de series temporales.

# Procedimiento

Estudiaremos los datos de consumo energético correspondientes a los años 2007 a 2009 a través de series temporales. 

Haremos proyección de futuro para el año 2010 y compararemos los resultados con los datos reales de este último año (serie real).

Series que vamos a estudiar:

- Evolución mensual del consumo para los años 2007-2009. Predicción para el año 2010
- Evolución diaria del consumo. Años 2007-2009. Predicción para el año 2010
- Evolución semanal del consumo. Años 2007-2009 . Predicción para el año 2010


# Evolución mensual del consumo. Años 2007-2009

## Serie temporal y visualización

Vamos a representar la serie por meses para cada submedidor y tambien para la energía global co granularidad mensual. En este caso, la frecuencia será 12, tenemos una observación por mes para los años 2007,8 y 2009.


```{r}
seriesMensuales <- Granularidad_meses %>% filter(year != 2006 & year != 2010)
## Creamos un objeto TS
tsSM1_Mensual<- ts(seriesMensuales$Sub_metering_1, frequency=12, start=c(2007,1))
tsSM2_Mensual<- ts(seriesMensuales$Sub_metering_2, frequency=12, start=c(2007,1))
tsSM3_Mensual<- ts(seriesMensuales$Sub_metering_3, frequency=12, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Mensual, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la cocina \n Años 2007-2009")# + scale_x_date(date_labels = '%b%')
autoplot(tsSM2_Mensual, xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Mensual, ts.colour = 'blue', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
```


Parece que los datos tienen estacionariedad (movimientos que se repiten cada año), esto ocurre para todas las variables.






## Predicción del año 2010 antes de descomponer la serie


Vamos a plicar regresión lineal a cada serie temporal, y veremos el valor de $R^2$ y del error cuadrático medio.



### SM1. Cocina

#### Modelo

```{r}
fitSM1_Mensual <- tslm(tsSM1_Mensual ~ trend + season) 
summary(fitSM1_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.5796. Es un valor bajo, el modelo únicamente explica el 58% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

#### Predicción IC

Predicción para los próximos 20 días

```{r}
forecastfitSM1_Mensual <- forecast(fitSM1_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM1_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```








### SM2. Lavadero
#### Modelo

```{r}
fitSM2_Mensual <- tslm(tsSM2_Mensual ~ trend + season) 
summary(fitSM2_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.6541. Es un valor bajo, el modelo únicamente explica el 65% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

#### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM2_Mensual <- forecast(fitSM2_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM2_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo










### SM3. AC y termo
#### Modelo

```{r}
fitSM3_Mensual <- tslm(tsSM3_Mensual ~ trend + season) 
summary(fitSM3_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.7577. Es un valor que podría ser aceptable, el modelo únicamente explica el 76% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

#### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM3_Mensual <- forecast(fitSM3_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM3_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo







### Comparación de los coeficientes y resultados de cada modelo



```{r}
DatosRealesSeriesMensuales <- Granularidad_meses %>% filter(year == 2010 )

RMSE_SM1_GranMensual<-accuracy(forecastfitSM1_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
R2_SM1_GranMensual<-0.5796
MASE_SM1_GranMensual<-accuracy(forecastfitSM1_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_1)[12]

RMSE_SM2_GranMensual<-accuracy(forecastfitSM2_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
R2_SM2_GranMensual<-0.6541
MASE_SM2_GranMensual<-accuracy(forecastfitSM2_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_2)[12]



RMSE_SM3_GranMensual<-accuracy(forecastfitSM3_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_3)[4]
R2_SM3_GranMensual<-0.7577
MASE_SM3_GranMensual<-accuracy(forecastfitSM3_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_3)[12]

ResEvolMensual<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensual,RMSE_SM2_GranMensual,RMSE_SM3_GranMensual),
     # MASE = c(MASE_SM1_GranMensual,MASE_SM2_GranMensual,MASE_SM3_GranMensual),
      R2 = c(R2_SM1_GranMensual,R2_SM2_GranMensual,R2_SM3_GranMensual)
)

ResEvolMensual %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")


# MASE: Mean absolute error
# RMSE: root mean scuare error. Diferencia entre los valores predichos y los observados.


```


El RMSE del modelo con mejor coeficiente de determinación es el más alto. Pero no hay que olvidar que el consumo eléctrico para el submedidor correspondiente al AC y termo eléctrico es el que más energía consume de todos con una diferencia muy grande.



## Forecasting descomponiendo la serie (así ok)

Descomponer la serie temporal: identificar y calcular las componentes tendencia, estacionalidad y ruido.

- Tendencia de una serie temporal: Consiste en la evolución a largo plazo de la serie. En nuestro caso, puede haber una tendencia al aumento del consumo energético o una tendencia decreciente.
- Estacionalidad: Movimientos oscilatorios alrededor de la tendencia que se repiten de forma periódica y con amplitud inferior al año
- Componente irregular: es aleatoria y no se puede predecir (ruido)



### Descomposición de la serie y visualización

#### Cocina: Submetering 1


```{r}
Componentes_SM1_MensualSTL<- tsSM1_Mensual %>%stl( t.window=12,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM1_MensualSTL, ts.colour = 'red', main="Descomposición de componentes")
```

Se aprecia una gran influencia de la componente estacional: oscilaciones que se repiten cada año, por ejemplo, en el mes de agosto, el consumo energético de la cocina decrece consuderablemente y es mucho menor que el resto de meses. Por el contrario, es en el mes de Junio cuando se registra el mayor consumo energético de los aparatos submeterizados de la cocina.

Tambien se aprecia una tendencia creciente de consumo, cada año se consume más.

Como remainder no es un muelle, gráficamente, parece que la componente irregular no es del todo aleatoria.



```{r}
plot.ts(tsSM1_Mensual, col = 'gray',
         xlab = "Mes del año", 
        ylab = "Energía (Varios-hora)", 
        main = "Evolución mensual del consumo energético de la cocina \n y la tendencia del consumo")
lines(Componentes_SM1_MensualSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```

Como ya habíamos comentado, existe una tendencia creciente del consumo energético de la cocina.

#### Lavadero: Submetering 2



```{r}
Componentes_SM2_MensualSTL<- tsSM2_Mensual %>%stl( #t.window=13,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_MensualSTL, ts.colour = 'blue')
```
Por el contrario que en la cocina, se observa como existe una considerable tendencia decreciente del consumo en el lavadero.

Tambien se observa claramente la estacionalidad, donde podemos apreciar que en los meses de verano el consumo energético es mucho menor que el resto de meses del año.

Parece que la componente irregular podría ser aleatoria, sin embargo, esto es únicamente a modo gráfico y por tanto deberíamos comprobarlo con un test de hipótesis.



```{r}
plot.ts(tsSM2_Mensual, col = 'gray', main="Evolución mensual del consumo energético del lavadero")
lines(Componentes_SM2_MensualSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2
      )
```






#### Termo eléctrico y aire acondicionado: Submetering 3



```{r}
tsSM3_Mensual %>%
  stl( t.window=12,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```




```{r}
Componentes_SM3_MensualSTL<- tsSM3_Mensual %>%
  stl( t.window=12, s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_MensualSTL, ts.colour = 'blue')
```

Tendencia creciente al consumo energético. Se observa fuerte componente estacional, donde el consumo energético baja considerablemente en los meses de verano, y alcanza niveles máximos en los últimos meses del año (Noviembre y Diciembre)

Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia creciente


```{r}
plot.ts(tsSM3_Mensual, col = 'gray',
        main="Evolución del consumo energético mensual del aire acondicionado y termo eléctrico")
lines(Componentes_SM3_MensualSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```










### Predicción con Holt-Winters (suavizado exponencial) para el año 2010

Vamos a aplicar suavizado exponencial para realizar un pronóstico del comportamiento de consumo energético.
Veremos esta predicción para datos:

- Sin estacionalidad
- Con estacionalidad, para ver si se mantiene o no la tendencia.

Tendencia de predicción (crecimiento o decrecimiento del consumo) y predicción teniendo en cuenta las componentes

#### Evolución mensual del consumo (sin estacionalidad). Años 2007-2009

##### Cocina




```{r}
tsSM1_Mensual_detrended <- tsSM1_Mensual - Componentes_SM1_MensualSTL$time.series[,1]
# Elimino la componente estacional
plot.ts(tsSM1_Mensual_detrended, 
        ylab = "Energía (Vatios-hora)", xlab="Mes del año", #ylim=c(0,3000),
        main = 'Evolución del consumo energético de la cocina sin estacionalidad',
        cex.main = 0.85, col="gray")
```

Vamos a estudiar como se comporta la componente irregular.

```{r}
par(mfrow = c(1,2))
plot(Componentes_SM1_MensualSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM1_MensualSTL$time.series[,3])
qqline(Componentes_SM1_MensualSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM1_MensualSTL$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad.

Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_Mensual_detrended ,s.window = "periodic",robust = TRUE),colour = 'red', main="Descomposición de la serie desestacionalizada")
```

Podríamos a sumir que se ha eliminado la estacionalidad, ya que los resíduos se comportan de manera irregular.


###### Suavizado exponencial de HoltWinters

- Primera iteracción: Solo con $\alpha$, voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_detrended , seasonal = "additive",
#   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM1_HW_Mensual$fitted)

# optimiza
plot(tsSM1_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo será en el rango: 7683-88889 vatios-hora de energía consumida.


- Segunda iteracción: Añadiendo $\beta$ podré averiguar la tendencia del consumo para las predicciones 

```{r}
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM1_HW_Mensual$fitted)

# optimiza
plot(tsSM1_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Tendencia al consumo decreciente, es decir, se pronosticará un descenso del consumo par meses siguientes.

- Tercera iteracción: Si añado $\gamma$ podré ver la estacionalidad.

```{r}
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
 # gamma=TRUE,
   alpha=TRUE
)

summary(tsSM1_HW_Mensual$fitted)

# optimiza
plot(tsSM1_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


```{r}
# Rstudio optimiza los coeficientes
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_detrended , seasonal = "additive",
 # beta=TRUE, 
 # gamma=TRUE,
 #  alpha=TRUE
)

summary(tsSM1_HW_Mensual$fitted)

# optimiza
plot(tsSM1_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```




###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Mensual_for <- forecast(tsSM1_HW_Mensual, h=12)
plot(tsSM1_HW_Mensual_for ,
     ylab= "Vatios-Hora",
     xlab="Fecha - AireAcondicionado y termo eléctrico",
     main="Predicción del consumo energético de la cocina \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Mensual_forC <- forecast(tsSM1_HW_Mensual, h=12
                                  , 
                                  level=c(10,25)
                                  )
## Plot only the forecasted area
plot(tsSM1_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha",
     main="Pronóstico del consumo de la cocina. Año 2010 \n (sin estacionalidad)", start(2010))
```







##### Lavadero



```{r}
tsSM2_Mensual_detrended <- tsSM2_Mensual - Componentes_SM2_MensualSTL$time.series[,2]
plot.ts(tsSM2_Mensual_detrended, 
        ylab = "Energía (Vatios-hora)", col="gray",
        main = 'Variabilidad del consumo energético del lavadero \n para datos sin estacionalidad',
        cex.main = 0.85)
```
Vamos a estudiar como se comporta la componente irregular.


```{r}
par(mfrow = c(1,2))
plot(Componentes_SM2_MensualSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_MensualSTL$time.series[,3])
qqline(Componentes_SM2_MensualSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_MensualSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena, por tanto, tenemos que vovler a descomponer la serie.




```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_Mensual_detrended ,s.window = "periodic",
         robust = TRUE,
         t.window = 12))
```

Ahora si que parece que los resíduos se comportan de manera aleatoria.
Comportamiento de consumo: Hay una tendencia decreciente al consumo los 5 primeros meses del año 2007, sin embargo, posteriormente este comportamiento cambia y existe una tendencia al consumo hasta principios del año 2008, donde vuelve a cambiar la tendencia y pasa a haber un comportamiento decreciente hasya finales del año 2008. Al parecer, desde final del año 2008 se ha observado una tendencia creciente del consumo energético del lavadero.



###### Suavizado exponencial de HoltWinters

- Primera iteracción: Solo con $\alpha$, voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_detrended , seasonal = "additive",
#   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM2_HW_Mensual$fitted)

# optimiza
plot(tsSM2_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo será en el rango: 0-27452.5 vatios-hora de energía consumida, ya que no puede haber un consumo energético negativo.


- Segunda iteracción: Añadiendo $\beta$ podré averiguar la tendencia del consumo para las predicciones 

```{r}
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM2_HW_Mensual$fitted)

# optimiza
plot(tsSM2_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Tendencia al consumo cambiante como ya hemos comentado antes

- Tercera iteracción: Si añado $\gamma$ podré ver la estacionalidad.

```{r}
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
  gamma=TRUE,
   alpha=TRUE
)

summary(tsSM2_HW_Mensual$fitted)

# optimiza
plot(tsSM2_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


```{r}
# Rstudio optimiza los coeficientes
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_detrended , seasonal = "additive",
  beta=TRUE, 
  gamma=TRUE,
 #  alpha=TRUE
)

summary(tsSM2_HW_Mensual$fitted)

# optimiza
plot(tsSM2_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```







###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_Mensual_for <- forecast(tsSM2_HW_Mensual, h=12)
plot(tsSM2_HW_Mensual_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Mensual_forC <- forecast(tsSM2_HW_Mensual, h=12, level=95)
## Plot only the forecasted area
plot(tsSM2_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción del consumo energético del lavadero. Año 2010", start(2010))
```




##### AC y termo eléctrico


```{r}
tsSM3_Mensual_detrended <- tsSM3_Mensual - Componentes_SM3_MensualSTL$time.series[,2]
plot.ts(tsSM3_Mensual_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución el consumo energético del aire acondicionado y termo ele´ctrico \n Datos sin estacionalidad',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM3_MensualSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_MensualSTL$time.series[,3])
qqline(Componentes_SM3_MensualSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_MensualSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.


Hay que volver a descomponer la serie.

```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_Mensual_detrended ,s.window = "periodic",robust = TRUE))
```

Parece que la componente irregular es aleatoria.
La tendencia del consumo energético es creciente, aunque durante el año 2008 hubo períodos con tendencia decreciente, al igual que los 5 primeros meses del año 2007.


###### Suavizado exponencial de HoltWinters



- Primera iteracción: Solo con $\alpha$, voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_detrended , seasonal = "additive",
#   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM3_HW_Mensual$fitted)

# optimiza
plot(tsSM3_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo será en el rango: 0-80208 vatios-hora de energía consumida, ya que no puede haber un consumo energético negativo.


- Segunda iteracción: Añadiendo $\beta$ podré averiguar la tendencia del consumo para las predicciones 

```{r}
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM3_HW_Mensual$fitted)

# optimiza
plot(tsSM3_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Tendencia al consumo cambiante como ya hemos comentado antes.

- Tercera iteracción: Si añado $\gamma$ podré ver la estacionalidad.

```{r}
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_detrended , seasonal = "additive",
   beta=TRUE, 
  gamma=TRUE,
   alpha=TRUE
)

summary(tsSM3_HW_Mensual$fitted)

# optimiza
plot(tsSM3_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
El ajuste podría ser mejorable, ya que hay gran influencia de los valores extremos.




```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_detrended ,
                              # tsSM3_Mensual_Adjusted,
                                beta=TRUE, gamma=TRUE)
plot(tsSM3_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Mensual_for <- forecast(tsSM3_HW_Mensual, h=12)
plot(tsSM3_HW_Mensual_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Mensual_forC <- forecast(tsSM3_HW_Mensual, h=12, level=95)
## Plot only the forecasted area
plot(tsSM3_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción el consumo energético del lavadero y termo eléctrico para el año 2010", start(2010),
     ylim=c(0,80000))
```



##### Comparación de los coeficientes y resultados de cada predicción. Datos sin estacionalidad


En las gráficas de predicción, hemos observado que el ajuste no mantiene la tendencia de consumo energético de la serie.


```{r}
RMSE_SM1_GranMensualFor<-accuracy(tsSM1_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
RMSE_SM2_GranMensualFor<-accuracy(tsSM2_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
RMSE_SM3_GranMensualFor<-accuracy(tsSM3_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_3)[4]


ResEvolMensual2_SinEstacionalidadConTendencia <-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensualFor,
               RMSE_SM2_GranMensualFor,
               RMSE_SM3_GranMensualFor)
)
ResEvolMensual2_SinEstacionalidadConTendencia %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```










#### Evolución mensual del consumo (con estacionalidad). Años 2007-2009

Vamos a ver una predicción del consumo enegético de cada submedidor con el método de HW. En este caso, no eliminaremos la estacionalidad, para ver así si se mantiene la tendencia de consumo.

##### Cocina



```{r}
tsSM1_Mensual_AdjustedII <- tsSM1_Mensual # - Componentes_SM1_Mensual$seasonal
autoplot(tsSM1_Mensual_AdjustedII)
```



```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_Mensual_AdjustedII,s.window = "periodic",robust = TRUE,t.window = 12))
```

Tendencia creciente del consumo.


###### Suavizado exponencial de HoltWinters


- Primera interacción: para observar el rango de la predicción.

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_MensualII <- HoltWinters(tsSM1_Mensual_AdjustedII, alpha=TRUE,
                                #  beta=TRUE, gamma=TRUE
                                  )
# optimiza
plot(tsSM1_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
- Segunda interacción: añado $\beta$ para observar la tendencia del consumo:

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_MensualII <- HoltWinters(tsSM1_Mensual_AdjustedII, alpha=TRUE,
                                  beta=TRUE # , gamma=TRUE
                                  )
# optimiza
plot(tsSM1_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
- Tercera iteracción: Añado $\gamma$

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_MensualII <- HoltWinters(tsSM1_Mensual_AdjustedII
                                  , 
                                  alpha=TRUE,
                                  beta=TRUE  , gamma=TRUE
                                  )
# optimiza
plot(tsSM1_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_MensualII <- HoltWinters(tsSM1_Mensual_AdjustedII, 
                                 #  alpha=TRUE,
                                   beta=TRUE  ,
                                  gamma=TRUE
                                  )
# optimiza
plot(tsSM1_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Si dejamos que la propia función optimice los valores de beta y gamma, la predicción se ajusta mejor y por tanto, obtendremos mejores resultados.


###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Mensual_forII <- forecast(tsSM1_HW_MensualII, h=12)
plot(tsSM1_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico",
     main="Predicción del consumo energético de la cocina \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Mensual_forCII <- forecast(tsSM1_HW_MensualII, h=12, level=95)
## Plot only the forecasted area
plot(tsSM1_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha", main="Pronóstico para el año 2010 (con estacionalidad)", start(2010))
```










##### Lavadero

```{r}
tsSM2_Mensual_AdjustedII <- tsSM2_Mensual ## - Componentes_SM2_Mensual$seasonal
autoplot(tsSM2_Mensual_AdjustedII)
```

```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_Mensual_AdjustedII,s.window = "periodic",
         robust = TRUE,t.window = 12))

```
LA tendencia de consumo es claramente creciente, y parece que la componente irregular se ha eliminado.


###### Suavizado exponencial de HoltWinters

- Primera interacción: componente alpha para ver el rango de predicciones

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_MensualII <- HoltWinters(tsSM2_Mensual_AdjustedII, 
                                  # beta=TRUE, 
                                  # gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM2_HW_MensualII$fitted)
plot(tsSM2_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Parece que la predicción del consumo energético del lavadero estará entre 10670 y 80481 vatios-hora de energía.

- Segunda interaccióm: añado beta para ver la tendencia del consumo:

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_MensualII <- HoltWinters(tsSM2_Mensual_AdjustedII, 
                                   beta=TRUE, 
                                  # gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM2_HW_MensualII$fitted)
plot(tsSM2_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Como ya habíamos avanzado, tendencia creciente

- Tercera interacción: añadimos gamma


```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_MensualII <- HoltWinters(tsSM2_Mensual_AdjustedII, 
                                   beta=TRUE, 
                                   gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM2_HW_MensualII$fitted)
plot(tsSM2_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_MensualII <- HoltWinters(tsSM2_Mensual_AdjustedII, 
                                   beta=TRUE, 
                                   gamma=TRUE #,
                                 #  alpha = TRUE
                                  )

```


###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_Mensual_forII <- forecast(tsSM2_HW_MensualII, h=12)
plot(tsSM2_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Mensual_forCII <- forecast(tsSM2_HW_MensualII, h=12, level=95)
## Plot only the forecasted area
plot(tsSM2_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```


##### AC y termo eléctrico

```{r}
tsSM3_Mensual_AdjustedII <- tsSM3_Mensual # - Componentes_SM3_Mensual$seasonal
autoplot(tsSM3_Mensual_AdjustedII)
```




```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_Mensual_AdjustedII,s.window = "periodic",robust = TRUE, 
         t.window = 12))
```

Tendencia creciente del consumo de este submedidor.

###### Suavizado exponencial de HoltWinters

- Primera interacción: alpha para ver el margen de predicción


```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_MensualII <- HoltWinters(tsSM3_Mensual_AdjustedII,
                                #  beta=TRUE, 
                                #  gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM3_HW_MensualII$fitted)
plot(tsSM3_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Rrango de predicciónes: 80833-392694 vatios hora.

- Segunda interacción: añado beta para ver la tendencia del consumo


```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_MensualII <- HoltWinters(tsSM3_Mensual_AdjustedII,
                                  beta=TRUE, 
                                #  gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM3_HW_MensualII$fitted)
plot(tsSM3_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Parece que los valores extremos influirán en las predicciones 

- Tercera interacción

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_MensualII <- HoltWinters(tsSM3_Mensual_AdjustedII,
                                  beta=TRUE, 
                                  gamma=TRUE,
                                  alpha = TRUE
                                  )
summary(tsSM3_HW_MensualII$fitted)
plot(tsSM3_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Mensual_forII <- forecast(tsSM3_HW_MensualII, h=12)
plot(tsSM3_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Mensual_forCII <- forecast(tsSM3_HW_MensualII, h=12, level=95)
## Plot only the forecasted area
plot(tsSM3_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción del consumo energético del aire acondicionado \n  y termo eléctrico  para el año 2010", start(2010), 
     ylim=c(0,400000))
```






##### Comparación de los coeficientes y resultados de cada predicción. Datos con estacionalidad


```{r}
RMSE_SM1_GranMensualForII<-accuracy(tsSM1_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
RMSE_SM2_GranMensualForII<-accuracy(tsSM2_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
RMSE_SM3_GranMensualForII<-accuracy(tsSM3_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_3)[4]


ResEvolMensual2SinTendenciaConEstacionalidad<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensualForII,
               RMSE_SM2_GranMensualForII,
               RMSE_SM3_GranMensualForII)
   
    
)

ResEvolMensual2SinTendenciaConEstacionalidad %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```





#### Comparación de resultados. Predicción antes y despues de eliminar estacionalidad


```{r}
Comparacion<-cbind.data.frame(
  ResEvolMensual2_SinEstacionalidadConTendencia,
  ResEvolMensual2SinTendenciaConEstacionalidad[,2])

colnames(Comparacion) <- c("Submedidor","RMSE Con Estacionalidad","RMSE Sin estacionalidad")
Comparacion %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


Resultados más fiables y con menor error trás haber eliminado la estacionalidad de la serie. También así podemos ver la tendencia.





## Comparación de resultados. Predicción antes y despues de eliminar la tendencia (descomponer)

En las gráficas de predicción de suaviazado exponencial, hemos observado que el ajuste cuando eliminamos la estacionalidad, no mantiene la tendencia de consumo energético de la serie. Sin embargo, al mantener la estacionalidad
se puede apreciar como las predicciones ajustan la tendencia de la serie original


```{r}
# Predicción antes y despues de eliminar estacionalidad:
Comparacion

# Sin descomponer


ComparacionII<-cbind.data.frame(ResEvolMensual,
                              Comparacion[-1]
                              )
colnames(ComparacionII) <- c("Submedidor","RMSE","R^2","Con estacionalidad","Sin estacionalidad")
ComparacionII %>% kable(booktabs=TRUE) %>% 
  kable_styling(latex_options = "striped") %>% 
  add_header_above( c("", "Serie sin descomponer" = 2, "Descomponiendo la serie" = 2)) %>% 
  add_header_above( c("", "RMSE" = 4))
```



Por tanto, nos quedaremos con los modelos correspondientes a la serie sin estacionalidad, que son los que mejores resultados nos ha dado.



## Pronóstico de consumo para los próximos 12 meses

### Cocina

```{r}
# Definición de serie temporal
seriesMensualesCompletas <- Granularidad_meses 
## Creamos un objeto TS
tsSM1_Mensual<- ts(seriesMensualesCompletas$Sub_metering_1, frequency=12, start=c(2006,12))
tsSM2_Mensual<- ts(seriesMensualesCompletas$Sub_metering_2, frequency=12, start=c(2006,12))
tsSM3_Mensual<- ts(seriesMensualesCompletas$Sub_metering_3, frequency=12, start=c(2006,12))
tsSM_GAP_Mensual<- ts(seriesMensualesCompletas$Global_active_power, frequency=12, start=c(2006,12))
```

```{r}
# Descomposición de la serie
Componentes_SM1_MensualSTL<-  tsSM1_Mensual %>%
  stl( t.window=12,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM1_Mensual_detrended <- tsSM1_Mensual - Componentes_SM1_MensualSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_detrended , 
                                seasonal = "additive",
 # beta=TRUE, 
 # gamma=TRUE,
 #  alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalCocinaAnual <- forecast(tsSM1_HW_Mensual, h=13)
## Plot only the forecasted area
plot(PrediccionFinalCocinaAnual, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  de la cocina para los próximos 12 meses", start(2010,12),
     ylim=c(0,80000))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalCocinaAnual[["mean"]] 
```






```{r}
PrediccionFinalCocinaAnual[["mean"]]
```


### Lavadero


```{r}
# Descomposición de la serie
Componentes_SM2_MensualSTL<-  tsSM2_Mensual %>%
  stl( t.window=12,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM2_Mensual_detrended <- tsSM2_Mensual - Componentes_SM2_MensualSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_detrended , 
                                seasonal = "additive",
 # beta=TRUE, 
 # gamma=TRUE,
 #  alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalLavaderoAnual <- forecast(tsSM2_HW_Mensual, h=13)
## Plot only the forecasted area
plot(PrediccionFinalLavaderoAnual, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  del lavadero para los próximos 12 meses", start(2010,12),
     ylim=c(0,80000))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalLavaderoAnual[["mean"]] 
```










### Aire acondicionado y termo eléctrico


```{r}
# Descomposición de la serie
Componentes_SM3_MensualSTL<-  tsSM3_Mensual %>%
  stl( t.window=12,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM3_Mensual_detrended <- tsSM3_Mensual - Componentes_SM3_MensualSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_detrended , 
                                seasonal = "additive",
 # beta=TRUE, 
 # gamma=TRUE,
 #  alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalAcTAnual <- forecast(tsSM3_HW_Mensual, h=13)
## Plot only the forecasted area
plot(PrediccionFinalAcTAnual, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  del aire y termo eléctricopara los próximos 12 meses", start(2010,12))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalLavaderoAnual[["mean"]] 
```




















### Datos y gráficas de las predicciones para el cliente


```{r}
df<-data.frame(
  Fecha=rep(c("2010-12-01"	,"2011-1-01"	,"2011-2-01"	,"2011-3-01"	,"2011-4-01"	,"2011-5-01"	,"2011-6-01"	,"2011-7-01"	,"2011-8-01"	,"2011-9-01","2011-10-01"	,"2011-11-01"	,"2011-12-01"),3) ,
           Consumo=c(as.vector(PrediccionFinalCocinaAnual[["mean"]]),
                     as.vector(PrediccionFinalLavaderoAnual[["mean"]]),
                     as.vector(PrediccionFinalAcTAnual[["mean"]])
                     )   ,
          SM = c(rep("Cocina",13),rep("Lavadero",13),rep("AC y termo",13) ) )

df$Fecha<- as.Date(df$Fecha, format = "%Y-%m-%d")

F=as.character(
as.Date(c("2010-12-01"	,"2011-1-01"	,"2011-2-01"	,"2011-3-01"	,"2011-4-01"	,"2011-5-01"	,"2011-6-01"	,"2011-7-01"	,"2011-8-01"	,"2011-9-01","2011-10-01"	,"2011-11-01"	,"2011-12-01"),format="%Y-%m-%d"))

ggplot(df,aes(x = as.character(Fecha), y = Consumo, group=SM,colour=SM)) +
          geom_line()+
          theme_minimal()+
  labs(
    title = "Pronóstico del consumo energético de la cocina para el año 2011",
    ylab="Consumo (Vatios-hora)",xlab="Mes del año")+
  theme(axis.text = element_text(angle = 45))+
   scale_x_discrete(breaks = F,
                   labels = c("Dec 2010"	,"Jan 2011"	,"Feb 2011"	,"Mar 2011"	,"Apr 2011"	,"May 2011"	,"Jun 2011"	,"Jul 2011"	,"Aug 2011"	,"Sep 2011","Oct 2011","Nov 2011","Dec 2011"))
```

```{r}
dfPlotlyPronosticoMensual<-data.frame(
  Fecha=c("2010-12-01"	,"2011-1-01"	,"2011-2-01"	,"2011-3-01"	,"2011-4-01"	,"2011-5-01"	,"2011-6-01"	,"2011-7-01"	,"2011-8-01"	,"2011-9-01","2011-10-01"	,"2011-11-01"	,"2011-12-01") )
df$Fecha<- as.Date(df$Fecha, format = "%Y-%m-%d")

dfPlotlyPronosticoMensual$Cocina <- as.vector(PrediccionFinalCocinaAnual[["mean"]])
dfPlotlyPronosticoMensual$Lavadero<-as.vector(PrediccionFinalLavaderoAnual[["mean"]])
dfPlotlyPronosticoMensual$AireTermo<-as.vector(PrediccionFinalAcTAnual[["mean"]])

# save(dfPlotlyPronosticoMensual, file = # "Datos/Pronostico/DF_Energia_PronosticoMensual_01.RData")
```



```{r}
plot_ly(dfPlotlyPronosticoMensual,
       x = ~Fecha, 
       y = ~Cocina,
             name = "Cocina" , type='scatter',  mode='lines'  ) %>% 
    add_trace( y = ~dfPlotlyPronosticoMensual$Lavadero,name = "Lavadero" , mode='lines')%>%
    add_trace( y = ~dfPlotlyPronosticoMensual$AireTermo, name = "Aire acondicionado y termo" , mode='lines') %>%
    layout(title = "Pronóstico del consumo energético de la cocina para el año 2011",
           xaxis = list(title = "Mes",
                        ticktext = c("Dec 2010"	,"Jan 2011"	,"Feb 2011"	,"Mar 2011"	,"Apr 2011"	 ,"May 2011"	,"Jun 2011"	,"Jul 2011"	,"Aug 2011"	,"Sep 2011","Oct 2011","Nov 2011","Dec # 2011"), tickvals = dfPlotlyPronosticoMensual$Fecha)
           , yaxis = list (title = "Energía (Varios-hora)"))
```






# Evolución semanal del consumo. Años 2007-2009

## Serie temporal y visualización

Vamos a representar la serie por semanas. Es decir, para cada submedidor vamos a representar el consumo total semanal. En este caso, la frecuencia será de 7 días por año, tenemos una observación para cada día de la semana para los años 2007,8 y 2009.


```{r}
Granularidad_semanas <- Granularidad_horas %>% group_by(year, weekday) %>% 
   summarize(
      Sub_metering_1 = sum (Sub_metering_1),
      Sub_metering_2 = sum (Sub_metering_2),
      Sub_metering_3 = sum (Sub_metering_3),
      Global_active_power = sum (Global_active_power),
      energia2 = sum (energia2)
   )
seriesSemanales <- rbind.data.frame(
   filter(Granularidad_semanas, year== 2007  ),
   filter(Granularidad_semanas, year== 2008  ),
   filter(Granularidad_semanas, year== 2009  )
)

## Creamos un objeto TS
 tsSM1_Semanal<- ts(seriesSemanales$Sub_metering_1,frequency=7, start=c(2007,1))
 tsSM2_Semanal<- ts(seriesSemanales$Sub_metering_2,frequency=7, start=c(2007,1))
 tsSM3_Semanal<- ts(seriesSemanales$Sub_metering_3,frequency=7, start=c(2007,1))
```






```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Semanal, ts.colour = 'red', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la cocina \n Años 2007-2009")
autoplot(tsSM2_Semanal, xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Semanal, ts.colour = 'blue', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
```





## Forecasting descomponiendo la serie 



### Descomposición de la serie y visualización

#### Cocina: Submetering 1






```{r}
Componentes_SM1_SemanalSTL<- tsSM1_Semanal %>%
  stl( t.window=7, s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM1_SemanalSTL, ts.colour = 'blue')
```



Se aprecia componente estacional: oscilaciones que se repiten cada año, es decir, cada 7 días. Vemos como la tendencia de consumo es creciente para los años 2007 y 2009 pero sin embargo, en el año 2008 hubo tendencia de consumo decreciente.




```{r}
plot.ts(tsSM1_Semanal, col = 'gray',main="Evolución del consumo energético de cada día de la semana de la cocina \n con la tendencia")
lines(Componentes_SM1_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```



#### Lavadero: Submetering 2







```{r}
Componentes_SM2_SemanalSTL<- tsSM2_Semanal %>%stl( t.window=7,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_SemanalSTL, ts.colour = 'blue')
```

Se observa una tendencia al consumo que es decreciente respecto de los últimos años, aunque a partir del año 2009 se puede apreciar cierta tendencia creciente del consumo energético del lavadero.

Tambien se obserca componente estacional, donde hay un pico de menor consumo energético los jueves y domingos, y los sábados son lso días donde hay un mayor registro del consumo energético del lavadero.


```{r}
plot.ts(tsSM2_Semanal, col = 'gray' , main = 'Evolución del consumo energético del lavadero \n por día de la semana. Años 2007-2009')
lines(Componentes_SM2_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```




#### Aire acondicionado y termo eléctrico: Submetering 3




```{r}
Componentes_SM3_SemanalSTL<- tsSM3_Semanal %>%stl( t.window=7, 
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_SemanalSTL, ts.colour = 'blue')
```

Se observa una fuerte componente estacional, con patrones que se repiten para cada año los mismos días de la semana. Por ejemplo, los Martes y Viernes son los días donde el consumo energético es mayor y los sábados y Miércoles son los días donde el consumo energético es menor.

La tendencia general del consumo energético es creciente.


```{r}
plot.ts(tsSM3_Semanal, col = 'gray' , main = 'Evolución del consumo energético del AC y termo \n  según día de la semana. Años 2007-2009',)
lines(Componentes_SM3_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```

Tendencia creciente del consumo energético del aire acondicionado y termo eléctrico


### Predicción con Holt-Winters (suavizado exponencial) para el año 2010

#### Evolución semanal del consumo (sin estacionalidad). Años 2007-2009

##### Cocina



```{r}
tsSM1_Semanal_detrended <- tsSM1_Semanal - Componentes_SM1_SemanalSTL$time.series[,1]
plot.ts(tsSM1_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución semanal del consumo de la cocina. Años 2007-2009',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM1_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM1_SemanalSTL$time.series[,3])
qqline(Componentes_SM1_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM1_SemanalSTL$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad. Volvemos a descomponer la serie desestacionalizada una vez para tratar de eliminar la componente estacional.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_Semanal_detrended ,
         s.window = "periodic",robust = TRUE,t.window = 7))
```

Parece que la componente irregular no sigue ningún patrón determinado.


###### Suavizado exponencial de HoltWinters

- Primera iteracción: Solo con \(\alpha\), voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM1_HW_Semanal <- HoltWinters(tsSM1_Semanal_detrended ,
                                alpha=TRUE
                               # beta=TRUE, 
                               # gamma=TRUE
                                )
summary(tsSM1_HW_Semanal$fitted)
# optimiza
plot(tsSM1_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
El pronóstico de consumo de la cocina variará con un pronóstico de 47685 vatios hora como mínimo y 105496   como máximo.


- Segunda iteracción: Añadiendo \(\beta\) podré averiguar la tendencia del consumo para las predicciones

```{r}

tsSM1_HW_Semanal <- HoltWinters(tsSM1_Semanal_detrended ,
                                alpha=TRUE,
                                beta=TRUE
                               # gamma=TRUE
                                )
summary(tsSM1_HW_Semanal$fitted)
# optimiza
plot(tsSM1_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Parece que los valores extremos tienen gran influencia y se pronosticará un aumento del consumo.


- Tercera iteracción: Si añado \(\gamma\) podré ver la estacionalidad

```{r}

tsSM1_HW_Semanal <- HoltWinters(tsSM1_Semanal_detrended ,
                                alpha=TRUE,
                                beta=TRUE,
                                gamma=TRUE
                                )
summary(tsSM1_HW_Semanal$fitted)
# optimiza
plot(tsSM1_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```





###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 7 observaciones, es decir, la predicción del consumo energético semanal total para el año 2010.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Semanal_for <- forecast(tsSM1_HW_Semanal, h=7)
plot(tsSM1_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha ",
     main="Predicción del consumo energético semanal de la cocina \n Año 2010" ) 
```
Vemos como hay un pronóstico de consumo energético mucho mayor que para los años anteriores.


```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Semanal_forC <- forecast(tsSM1_HW_Semanal, h=7, level = c(95))
## Plot only the forecasted area

plot(tsSM1_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción del consumo energético semanal para el año 2010", start(2010))
```




##### Lavadero

```{r}
tsSM2_Semanal_detrended <- tsSM2_Semanal - Componentes_SM2_SemanalSTL$time.series[,1]
plot.ts(tsSM2_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución del consumo energético según día de la semana \n del lavadero',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM2_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_SemanalSTL$time.series[,3])
qqline(Componentes_SM2_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_SemanalSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.






```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_Semanal_detrended ,s.window = "periodic",robust = TRUE,t.window = 7))
```

Tendencia decreciente del consumo.


###### Suavizado exponencial de HoltWinters

- Primera interacción: rango de predicción

```{r}
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended ,
                               alpha = TRUE
                                )
summary(tsSM2_HW_Semanal$fitted)
plot(tsSM2_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo energético para el lavadero es de 5231 a 161540  vatios hora.

- Segunda interacción: tendencia

```{r}
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended ,
                               alpha = TRUE, beta=TRUE
                                )
summary(tsSM2_HW_Semanal$fitted)
plot(tsSM2_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Serie muy afectada por valores extremos, pero se aprecia una tendencia decreciente del consumo energético.

- Tercera interacción



```{r}
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended ,
                               alpha = TRUE,
                               beta=TRUE , gamma=TRUE
                                )
summary(tsSM2_HW_Semanal$fitted)
plot(tsSM2_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


```{r}
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended ,
                             #  alpha = TRUE,
                               beta=TRUE , gamma=TRUE
                                )
summary(tsSM2_HW_Semanal$fitted)
plot(tsSM2_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Parece que esta configuración se ajuste mejor.

###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir el consumo energético de los próximos 7 días, es decir, el consumo energético de cada día de la semana del año 2010

```{r}
## HoltWinters forecast & plot
     tsSM2_HW_Semanal_for <- forecast(tsSM2_HW_Semanal, h=7)
plot(tsSM2_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético del lavadero \ según día de la semana del año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Semanal_forC <- forecast(tsSM2_HW_Semanal, h=7, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha ", main="Predicción semanal para el año 2010", start(2010))
```




##### AC y termo eléctrico


```{r}
tsSM3_Semanal_detrended <- tsSM3_Semanal - Componentes_SM3_SemanalSTL$time.series[,1]
plot.ts(tsSM3_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución según día de la semana del consumo energético del AC y termo \n Serie sin componente estacional',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM3_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_SemanalSTL$time.series[,3])
qqline(Componentes_SM3_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_SemanalSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena. Vamos a volver a descomponer la serie.




```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_Semanal_detrended ,s.window = "periodic",robust = TRUE,t.window = 7))
```


###### Suavizado exponencial de HoltWinters

- Primera interacción: rango de pronóstico

```{r}
tsSM3_HW_Semanal <- HoltWinters(tsSM3_Semanal_detrended ,
                             alpha = TRUE)
summary(tsSM3_HW_Semanal$fitted)
plot(tsSM3_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Predicción del consumo para el termo eléctrico y aire acondicionado entre 430345 y 566292 vatios hora.

- Segunda interacción: tendencia de consumo

```{r}
tsSM3_HW_Semanal <- HoltWinters(tsSM3_Semanal_detrended ,
                             alpha = TRUE,beta=TRUE)
summary(tsSM3_HW_Semanal$fitted)
plot(tsSM3_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Se observa una tendencia creciente.

- Tercera iteracción

```{r}
tsSM3_HW_Semanal <- HoltWinters(tsSM3_Semanal_detrended ,
                             alpha = TRUE,
                             beta=TRUE, gamma = TRUE)
summary(tsSM3_HW_Semanal$fitted)
plot(tsSM3_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 7 observaciones, es decir, el consumo energético de cada día de la semana para el año 2010.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Semanal_for <- forecast(tsSM3_HW_Semanal, h=7)
plot(tsSM3_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético semanal \n del AC y termo eléctrico. Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Semanal_forC <- forecast(tsSM3_HW_Semanal, h=7, level=c(95))
## Plot only the forecasted area
plot(tsSM3_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción semanal del consumo energético para el año 2010", start(2010), ylim=c(0,450000))
```






##### Comparación de los coeficientes y resultados de cada predicción. Datos sin estacionalidad


En las gráficas de predicción, hemos observado que el ajuste no mantiene la tendencia de consumo energético de la serie.


```{r}
DatosRealesSeriesSemanales<-Granularidad_semanas  %>% filter(year==2010)
```


```{r}
RMSE_SM1_GranSemanalFor<-accuracy(tsSM1_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_1)[4]
RMSE_SM2_GranSemanalFor<-accuracy(tsSM2_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_2)[4]
RMSE_SM3_GranSemanalFor<-accuracy(tsSM3_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_3)[4]


ResEvolSemanal2_SinEstacionalidadConTendencia <-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranSemanalFor,
               RMSE_SM2_GranSemanalFor,
               RMSE_SM3_GranSemanalFor)
)
ResEvolSemanal2_SinEstacionalidadConTendencia %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```



Los errores son demasiado altos, las predicciones no serán del todo fiables y por tanto no podemos ofrecerlas al cliente.





## Análisis de series temporales con metodología Box-Jenkis

### Paso 1. Lectura y representación gráfica de los datos

```{r}
# tsSM3_Semanal<- ts(seriesSemanales$Sub_metering_3,         frequency=7, start=c(2007,1))
autoplot(tsSM3_Semanal, ts.colour = 'blue', 
         xlab = "Semana del año",
         ylab = "Energía (Varios-hora)", 
         main = "Evolución semanal del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
```


### Paso 2. Transformaciones para que la varianza sea estable en el tiempo

```{r}
library(TSA)
bc=BoxCox.ar(y=tsSM3_Semanal);

bc$mle
bc$ci # El 1 no está en el intervalo, hay que transformar los datos
# El 0 no está en el intervalo, no es transformación logarítmica
```


Usando la familia de transformaciones BoxCox, nos sugiere un valor de lambda = 2. 
El valor 1 (no transformar) está en el intervalo, por lo que no hay que hacer una transformación de los datos, podemos asumir que la varianza es constante en el tiempo




```{r}
# TransftsSM3_Semanal<- tsSM3_Semanal^2
```




### Paso 3. Transformaciones para que la media sea estable en el tiempo




```{r}
acf(tsSM3_Semanal, main="FAS del consumo de Energía del AC y Termo", lag.max=50)
ndiffs( tsSM3_Semanal) # Necesito una diferencia regular
nsdiffs(tsSM3_Semanal)
```


Diferencia estacional:

```{r}
tsSM3_SemanalDif=diff(tsSM3_Semanal, lag=1, diff=1)
acf(tsSM3_SemanalDif, main="FAS de primera diferencia regular del consumo energético", lag=50)
ndiffs(tsSM3_SemanalDif) 
```

Parece la FAS de un Ruido Blanco.

### Paso 4. Contrastar la estacionariedad

Test de raiz unitaria.

```{r}
library(tseries)
adf.test(tsSM3_SemanalDif)
```


No existen evidencias significativas para afirmar que los datos no sean estacionarios. La media es estable en el tiempo.


```{r}
autoplot(tsSM3_SemanalDif, ts.colour = 'blue', 
         xlab = "Semana del año",
         ylab = "Energía (Varios-hora)", 
         main = "Evolución semanal del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
```

### Paso 5. Identificar la estructura ARIMA

```{r}
acf(tsSM3_SemanalDif, main="FAS tras una diferencia regular", lag=50)
```
Ruido blanco

```{r}
pacf(tsSM3_SemanalDif, main="FAP tras una diferencia regular", lag=50)
```

 AR(1).

### Pasos 6 y 7. Estimación de parámetros y diagnóstico


modelo ARIMA(1,1,0)xARIMA(0,0,0)



```{r}
ajuste1=arima(tsSM3_Semanal, order=c(1,1,0), seasonal=list(order=c(0,0,0), period=7)); ajuste1
```




```{r}
checkresiduals(ajuste1)
```


No pasa la diagnosis:  p-value =  0.002445. El modelo no es válido.


```{r}
ajuste2=auto.arima(tsSM3_Semanal, d = 1,D = 0); ajuste2
```

Modelo propuesto: ARIMA(3,1,0)




aicAutoArima = 496.21
AICModelo1=484.31




```{r}
checkresiduals(ajuste2)
```

El modelo pasa la diagnosis, p-valor=0.422, por tanto es válido. No existen evidencias significativas en contra de que los resíduos sigan un proceso de ruido blanco.



Nos quedamos con el modelo 2.



### Paso 8. Predicción de los resultados

```{r}

pred=forecast(ajuste2,h = 7)# predicción del año 2010
plot(tsSM3_Semanal, xlim=c(2007, 2011), ylim=c(350000,600000))
lines(pred$mean, col="red")



# plot((forecast(ajuste.bueno,h=7))) #muy similar al anterior
```





Vamos a calcular el error: `r accuracy(pred  ,DatosRealesSeriesSemanales$Sub_metering_1)[4]`, que es mucho mayor que por el otro método.

















## Pronóstico de consumo para los próximos 12 meses 

Lo haremos con el modelo conseguido primero, no con la metodología de Box-Jenkis, que es peor.

### Cocina

```{r}
# Definición de serie temporal

Granularidad_semanas <- Granularidad_horas %>% group_by(year, weekday) %>% 
   summarize(
      Sub_metering_1 = sum (Sub_metering_1),
      Sub_metering_2 = sum (Sub_metering_2),
      Sub_metering_3 = sum (Sub_metering_3),
      Global_active_power = sum (Global_active_power),
      energia2 = sum (energia2)
   )
seriesSemanalesCompletas <- Granularidad_semanas

## Creamos un objeto TS
 tsSM1_Semanal<- ts(seriesSemanalesCompletas$Sub_metering_1,frequency=7, start=c(2007,1))
 tsSM2_Semanal<- ts(seriesSemanalesCompletas$Sub_metering_2,frequency=7, start=c(2007,1))
 tsSM3_Semanal<- ts(seriesSemanalesCompletas$Sub_metering_3,frequency=7, start=c(2007,1))
```

```{r}
# Descomposición de la serie
Componentes_SM1_SemanalSTL<-  tsSM1_Semanal %>%
  stl( t.window=7,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM1_Semanal_detrended <- tsSM1_Semanal- Componentes_SM1_SemanalSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM1_HW_Semanal <- HoltWinters(tsSM1_Semanal_detrended , 
                                seasonal = "additive",
  beta=TRUE, 
  gamma=TRUE,
   alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalCocinaSemanal <- forecast(tsSM1_HW_Semanal, h=7)
## Plot only the forecasted area
plot(PrediccionFinalCocinaSemanal, 
     ylab= "Vatios-Hora", xlab="Fecha", 
     main="Predicción el consumo energético de la cocina \n según día de para año 2011", start(2010,12), ylim = c(100000,200000))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalCocinaSemanal[["mean"]] 
```


Según el pronóstico, el día de la semana que más consumo energético total de energía habrá, será el Viernes. Y por el contrario, el día de la semana en que se registrará el menor consumo energético es el Domingo. 




### Lavadero


```{r}
# Descomposición de la serie
Componentes_SM2_SemanalSTL<-  
  tsSM2_Semanal %>%
  stl( t.window=7,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM2_Semanal_detrended <- tsSM2_Semanal - Componentes_SM2_SemanalSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended , 
                                seasonal = "additive",
  beta=TRUE, 
  gamma=TRUE
 #  alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalLavaderoSemanal <- forecast(tsSM2_HW_Semanal, h=7)
## Plot only the forecasted area
plot(PrediccionFinalLavaderoSemanal, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético del lavadero \n  Según el día de la semana para los próximos 12 meses", start(2010,12), ylim = c(50000,450000))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalLavaderoSemanal[["mean"]] 
```










### Aire acondicionado y termo eléctrico


```{r}
# Descomposición de la serie
Componentes_SM3_SemanalSTL<-  tsSM3_Semanal %>%
  stl( t.window=7,s.window="periodic",  robust=TRUE)
# Eliminación de la estacionalidad
tsSM3_Semanal_detrended <- tsSM3_Semanal - Componentes_SM3_SemanalSTL$time.series[,1]
```


```{r}
# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM3_HW_Semanal <- HoltWinters(tsSM3_Semanal_detrended , 
                                seasonal = "additive",
  beta=TRUE, 
  gamma=TRUE,
   alpha=TRUE
)
```


```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalAcTSemanal <- forecast(tsSM3_HW_Semanal, h=13)
## Plot only the forecasted area
plot(PrediccionFinalAcTSemanal, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético del aire y termo \n para cada día de la semana", start(2010,12), ylim = c(350000,850000))
```

Las predicciones son las siguientes: 

```{r}
PrediccionFinalLavaderoSemanal[["mean"]] 
```



















# Evolución del consumo energético por semana del año.

## Serie temporal y visualización

Vamos a representar la serie por meses para cada submedidor y tambien para la energía global co granularidad mensual. En este caso, la frecuencia será 12, tenemos una observación por mes para los años 2007,8 y 2009.


```{r}
Granularidad_semanas <- Granularidad_horas %>% group_by(year, week) %>% 
   summarize(
      Sub_metering_1 = sum (Sub_metering_1),
      Sub_metering_2 = sum (Sub_metering_2),
      Sub_metering_3 = sum (Sub_metering_3),
      Global_active_power = sum (Global_active_power),
      energia2 = sum (energia2)
   )
```


```{r}
seriesSemanales <- rbind.data.frame(
   filter(Granularidad_semanas, year== 2007  ),
   filter(Granularidad_semanas, year== 2008  ),
   filter(Granularidad_semanas, year== 2009  )
)

## Creamos un objeto TS
   tsSM1_Semanal<- ts(seriesSemanales$Sub_metering_1,         frequency=53, start=c(2007,1))
   tsSM2_Semanal<- ts(seriesSemanales$Sub_metering_2,         frequency=53, start=c(2007,1))
   tsSM3_Semanal<- ts(seriesSemanales$Sub_metering_3,         frequency=53, start=c(2007,1))
tsSM_GAP_Semanal<- ts(seriesSemanales$Global_active_power,    frequency=53, start=c(2007,1))
```






```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Semanal, ts.colour = 'red', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la cocina \n Años 2007-2009")
autoplot(tsSM2_Semanal, xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Semanal, ts.colour = 'blue', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
autoplot(tsSM_GAP_Semanal, ts.colour = 'green', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía \n Años 2007-2009")
```


AC y Termo: podría apreciarse cierta estacionalidad
Energía total: muelle


## Predicción del año 2010 antes de descomponer la serie


Vamos a plicar regresión lineal a cada serie temporal, y veremos el valor de $R^2$ y del error cuadrático medio.



### SM1. Cocina

#### Modelo

```{r}
fitSM1_Semanal <- tslm(tsSM1_Semanal ~ trend + season) 
summary(fitSM1_Semanal)
```

Resultados:

- Valor del coeficiente de determinación: 0.4836. Es un valor bajo, el modelo únicamente explica el 48%  de la variabilidad total.

- Hay un coeficiente significativamente no nulo.

#### Predicción IC

Predicción para los próximos 20 días

```{r}
forecastfitSM1_Semanal <- forecast(fitSM1_Semanal, h=53, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM1_Semanal, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético semanal total del año 2010 \n  a través de un modelo de regresión")
```








### SM2. Lavadero

#### Modelo

```{r}
fitSM2_Semanal <- tslm(tsSM2_Semanal ~ trend + season) 
summary(fitSM2_Semanal)
```

Resultados:

- Valor del coeficiente de determinación:  0.5326. Es un valor aceptable, el modelo únicamente explica el 53% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

#### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM2_Semanal <- forecast(fitSM2_Semanal, h=53, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM2_Semanal, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo










### SM3. AC y termo
#### Modelo

```{r}
fitSM3_Semanal <- tslm(tsSM3_Semanal ~ trend + season) 
summary(fitSM3_Semanal)
```

Resultados:

- Valor del coeficiente de determinación: 0.7153. Es un valor que podría ser aceptable, el modelo únicamente explica el 71% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

#### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM3_Semanal <- forecast(fitSM3_Semanal, h=53, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM3_Semanal, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo







### Comparación de los coeficientes y resultados de cada modelo



```{r}
###  DatosRealesSeriesSemanales <- Granularidad_semanas %>% filter(year == 2010 ###  )
###  
###  RMSE_SM1_GranSemanal<-accuracy(forecastfitSM1_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_1)[4]
###    R2_SM1_GranSemanal<-0.975
###  MASE_SM1_GranSemanal<-accuracy(forecastfitSM1_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_1)[12]
###  RMSE_SM2_GranSemanal<-accuracy(forecastfitSM2_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_2)[4]
###    R2_SM2_GranSemanal<-0.7717
###  MASE_SM2_GranSemanal<-accuracy(forecastfitSM2_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_2)[12]
###  RMSE_SM3_GranSemanal<-accuracy(forecastfitSM3_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_3)[4]
###    R2_SM3_GranSemanal<-0.7601
###  MASE_SM3_GranSemanal<-accuracy(forecastfitSM3_Semanal  ###  ,DatosRealesSeriesSemanales$Sub_metering_3)[12]
###  
###  ResEvolSemanal<-
###  cbind.data.frame(
###        Submedidor=c("Cocina","Lavadero","AC y TermoE"),
###        RMSE = c(RMSE_SM1_GranSemanal,
###                 RMSE_SM2_GranSemanal,
###                 RMSE_SM3_GranSemanal),
###       # MASE = c(MASE_SM1_GranMensual,MASE_SM2_GranMensual,MASE_SM3_GranMen###  sual),
###        R2 = c(R2_SM1_GranSemanal,
###               R2_SM2_GranSemanal,
###               R2_SM3_GranSemanal))
###  ResEvolSemanal %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = ###  "striped")
###  
###  # MASE: Mean absolute error
###  # RMSE: root mean scuare error. Diferencia entre los valores predichos y ###  los observados.
```


El RMSE del modelo con mejor coeficiente de determinación es el más alto. Pero no hay que olvidar que el consumo eléctrico para el submedidor correspondiente al AC y termo eléctrico es el que más energía consume de todos con una diferencia muy grande.











## Forecasting descomponiendo la serie (así ok)

Descomponer: quitar tendencia

### Descomposición de la serie y visualización

#### Submetering 1


```{r}
 tsSM1_Semanal %>%
  stl( #t.window=13,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
#tsSM1_Semanal %>%
#  stl(t.window=13, s.window="periodic", robust=TRUE) %>%
#  autoplot()
```


Remainder no es un muelle. Observamos tendencia creciente y fuerte componente estacional

Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.


```{r}
Componentes_SM1_SemanalSTL<- tsSM1_Semanal %>%stl( #t.window=13,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM1_SemanalSTL, ts.colour = 'blue')
plot.ts(tsSM1_Semanal, col = 'gray')
lines(Componentes_SM1_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```



#### Submetering 2





```{r}
 tsSM2_Semanal %>%
  stl( #t.window=13,
      s.window="periodic", 
      robust=TRUE) %>% summary()

#tsSM2_Semanal %>%
#  stl(t.window=13, s.window="periodic", robust=TRUE) %>%
#  autoplot()
```


```{r}
Componentes_SM2_SemanalSTL<- tsSM2_Semanal %>%stl( #t.window=13,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_SemanalSTL, ts.colour = 'blue')
plot.ts(tsSM2_Semanal, col = 'gray')
lines(Componentes_SM2_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```



Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.





#### Submetering 3



Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia creciente


```{r}
tsSM3_Semanal %>%
  stl( #t.window=13,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```




```{r}
Componentes_SM3_SemanalSTL<- tsSM3_Semanal %>%stl( #t.window=13,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_SemanalSTL, ts.colour = 'blue')
plot.ts(tsSM3_Semanal, col = 'gray')
lines(Componentes_SM3_SemanalSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```

Tendencia creciente del consumo energético


### Predicción con Holt-Winters (suavizado exponencial) para el año 2010

Sin estacionalidad 

Sería interesante verlo también con estacionalidad, para ver si se mantiene o no la tendencia.

Tendencia de predicción (crecimiento o decrecimiento del consumo) y predicción teniendo en cuenta las componentes

#### Evolución mensual del consumo (sin estacionalidad). Años 2007-2009

##### Cocina






```{r}
#tsSM1_Mensual_Adjusted <- tsSM1_Mensual - Componentes_SM1_Mensual$seasonal
#autoplot(tsSM1_Mensual_Adjusted)
```


```{r}
tsSM1_Semanal_detrended <- tsSM1_Semanal - Componentes_SM1_SemanalSTL$time.series[,2]
plot.ts(tsSM1_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Seasonal variability of energy comsumption',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM1_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM1_SemanalSTL$time.series[,3])
qqline(Componentes_SM1_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM1_SemanalSTL$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad

Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_Semanal_detrended ,s.window = "periodic",robust = TRUE))
```

La componente estacional se mueve en un ranfo de $10^{-11}$, podemos asumir que se ha eliminado esta componente.







###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_Semanal <- HoltWinters(tsSM1_Semanal_detrended ,
                              #  tsSM1_Mensual_Adjusted, 
  beta=TRUE, gamma=TRUE)
# optimiza
plot(tsSM1_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 53 observaciones, es decir, el consumo energético semanal de cada submedidor para las 53 semanas del año 2010.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Semanal_for <- forecast(tsSM1_HW_Semanal, h=53)
plot(tsSM1_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico",
     main="Predicción del consumo energético semanal de la cocina \n Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Semanal_forC <- forecast(tsSM1_HW_Semanal, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM1_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción del consumo energético semanal para el año 2010", start(2010))
```









##### Lavadero

```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
# tsSM2_Mensual_Adjusted <- tsSM2_Mensual - Componentes_SM2_Mensual$seasonal
# autoplot(tsSM2_Mensual_Adjusted)
```




```{r}
tsSM2_Semanal_detrended <- tsSM2_Semanal - Componentes_SM2_SemanalSTL$time.series[,2]
plot.ts(tsSM2_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Seasonal variability of energy comsumption',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM2_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_SemanalSTL$time.series[,3])
qqline(Componentes_SM2_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_SemanalSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.






```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_Semanal_detrended ,s.window = "periodic",robust = TRUE))
```

La componente estacional se mueve en un rango de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_Semanal <- HoltWinters(tsSM2_Semanal_detrended ,
                                # tsSM2_Mensual_Adjusted,
                                beta=TRUE, gamma=TRUE)
plot(tsSM2_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 7 observaciones.

```{r}
## HoltWinters forecast & plot
     tsSM2_HW_Semanal_for <- forecast(tsSM2_HW_Semanal, h=53)
plot(tsSM2_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción semanal del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Semanal_forC <- forecast(tsSM2_HW_Semanal, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción semanal para el año 2010", start(2010))
```




##### AC y termo eléctrico

```{r}
# ## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
# tsSM3_Mensual_Adjusted <- tsSM3_Mensual - Componentes_SM3_Mensual$seasonal
# autoplot(tsSM3_Mensual_Adjusted)
```



```{r}
tsSM3_Semanal_detrended <- tsSM3_Semanal - Componentes_SM3_SemanalSTL$time.series[,2]
plot.ts(tsSM3_Semanal_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Seasonal variability of energy comsumption',
        cex.main = 0.85)
```



```{r}
par(mfrow = c(1,2))
plot(Componentes_SM3_SemanalSTL$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_SemanalSTL$time.series[,3])
qqline(Componentes_SM3_SemanalSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_SemanalSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.




```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_Semanal_detrended ,s.window = "periodic",robust = TRUE))
```

La componente estacional se mueve en un ranfo de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_Semanal <- HoltWinters(tsSM3_Semanal_detrended ,
                              # tsSM3_Mensual_Adjusted,
                                beta=TRUE, gamma=TRUE)
plot(tsSM3_HW_Semanal,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Semanal_for <- forecast(tsSM3_HW_Semanal, h=53)
plot(tsSM3_HW_Semanal_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético semanal del AC y termo eléctrico \n Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Semanal_forC <- forecast(tsSM3_HW_Semanal, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM3_HW_Semanal_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción semanal del consumo energético para el año 2010", start(2010))
```






##### Comparación de los coeficientes y resultados de cada predicción. Datos sin estacionalidad


En las gráficas de predicción, hemos observado que el ajuste no mantiene la tendencia de consumo energético de la serie.


```{r}
RMSE_SM1_GranSemanalFor<-accuracy(tsSM1_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_1)[4]
RMSE_SM2_GranSemanalFor<-accuracy(tsSM2_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_2)[4]
RMSE_SM3_GranSemanalFor<-accuracy(tsSM3_HW_Semanal_forC   ,DatosRealesSeriesSemanales$Sub_metering_3)[4]


ResEvolSemanal2_SinEstacionalidadConTendencia <-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranSemanalFor,
               RMSE_SM2_GranSemanalFor,
               RMSE_SM3_GranSemanalFor)
)
ResEvolSemanal2_SinEstacionalidadConTendencia %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```









#### Evolución mensual del consumo (con estacionalidad). Años 2007-2009

Vamos a ver una predicción del consumo enegético de cada submedidor con el método de HW. En este caso, no eliminaremos la estacionalidad, para ver así si se mantiene la tendencia de consumo.

##### Cocina



```{r}
tsSM1_Mensual_AdjustedII <- tsSM1_Mensual # - Componentes_SM1_Mensual$seasonal
autoplot(tsSM1_Mensual_AdjustedII)
```

Parece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM1_Mensual_AdjustedII))
```

La componente estacional se mueve en un rango de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_MensualII <- HoltWinters(tsSM1_Mensual_AdjustedII, beta=TRUE, gamma=TRUE)
# optimiza
plot(tsSM1_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```




###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Mensual_forII <- forecast(tsSM1_HW_MensualII, h=12)
plot(tsSM1_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico",
     main="Predicción del consumo energético de la cocina \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Mensual_forCII <- forecast(tsSM1_HW_MensualII, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM1_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```










##### Lavadero

```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
tsSM2_Mensual_AdjustedII <- tsSM2_Mensual ## - Componentes_SM2_Mensual$seasonal
autoplot(tsSM2_Mensual_AdjustedII)
```

No arece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM2_Mensual_AdjustedII)) 
```

TENDENCIA CLARAMENTE DECRECIENTE. Tambien observamos esacionalidad


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_MensualII <- HoltWinters(tsSM2_Mensual_AdjustedII, beta=TRUE, gamma=TRUE)
plot(tsSM2_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_Mensual_forII <- forecast(tsSM2_HW_MensualII, h=53)
plot(tsSM2_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Mensual_forCII <- forecast(tsSM2_HW_MensualII, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```
















##### AC y termo eléctrico

```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
tsSM3_Mensual_AdjustedII <- tsSM3_Mensual # - Componentes_SM3_Mensual$seasonal
autoplot(tsSM3_Mensual_AdjustedII)
```

No parece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM3_Mensual_AdjustedII))
```



###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_MensualII <- HoltWinters(tsSM3_Mensual_AdjustedII, beta=TRUE, gamma=TRUE)
plot(tsSM3_HW_MensualII,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Mensual_forII <- forecast(tsSM3_HW_MensualII, h=53)
plot(tsSM3_HW_Mensual_forII , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Mensual_forCII <- forecast(tsSM3_HW_MensualII, h=53, level=c(10,25))
## Plot only the forecasted area
plot(tsSM3_HW_Mensual_forCII, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```






##### Comparación de los coeficientes y resultados de cada predicción. Datos con estacionalidad


```{r}
RMSE_SM1_GranMensualForII<-accuracy(tsSM1_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
RMSE_SM2_GranMensualForII<-accuracy(tsSM2_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
RMSE_SM3_GranMensualForII<-accuracy(tsSM3_HW_Mensual_forCII   ,DatosRealesSeriesMensuales$Sub_metering_3)[4]


ResEvolMensual2SinTendenciaConEstacionalidad<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensualForII,
               RMSE_SM2_GranMensualForII,
               RMSE_SM3_GranMensualForII)
   
    
)

ResEvolMensual2SinTendenciaConEstacionalidad %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```





#### Comparación de resultados. Predicción antes y despues de eliminar estacionalidad


```{r}
Comparacion<-cbind.data.frame(
  ResEvolMensual2_SinEstacionalidadConTendencia,
  ResEvolMensual2SinTendenciaConEstacionalidad[,2])

colnames(Comparacion) <- c("Submedidor","RMSE Con Estacionalidad","RMSE Sin estacionalidad")
Comparacion %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


Resultados más fiables y con menor error trás haber eliminado la estacionalidad de la serie. También así podemos ver la tendencia.


```{r}
#p1<-autoplot(tsSM1_Mensual_Adjusted)
#p2<-autoplot(tsSM1_Mensual_AdjustedII)
#grid.arrange(
#             grobs = list(p1,p2),
#           nrow = 2,
#             top="Sin estacionalidad",bottom="Con estacionalidad"
#             )
```
















# Evolución diaria del consumo por meses. Mes de Enero

## Serie temporal y visualización

En este caso, crearemos una serie para cada mes, ya que la frecuencia de los datos no será la misma, al tener cada mes un número de días diferente.




```{r}
par(mfrow=c(2,2))
seriesDiariasEnero <- Granularidad_dias %>% filter(year != 2006 & year != 2010 & month == 1)
## Creamos un objeto TS
   tsSM1_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_1, frequency=31, start=c(2007,1))
   
   tsSM2_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_2, frequency=31, start=c(2007,1))
   
   tsSM3_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_3, frequency=31, start=c(2007,1))
   
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_DiariaEnero, ts.colour = 'red', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la cocina en el mes de Enero \n Años 2007-2009")
autoplot(tsSM2_DiariaEnero, xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la lavandería en el mes de Enero \n Años 2007-2009")
autoplot(tsSM3_DiariaEnero, ts.colour = 'blue', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo energético del aire acondicionado y termo en el mes de Enero \n Años 2007-2009")

```

Parece que no existen muchos patrones que nos podrían ayudar a hacer predicciones, no serían muy fiables. (gráfica muelle)










## Forecasting descomponiendo la serie (así ok)



### Descomposición de la serie y visualización

#### Cocina: Submetering 1

Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.

```{r}
 tsSM1_DiariaEnero %>%
  stl( #t.window=13,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```

La componente irregular tiene bastante peso, al igual que la estacional.


```{r}
Componentes_SM1_DiariaEneroSTL<-
  tsSM1_DiariaEnero %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM1_DiariaEneroSTL, ts.colour = 'blue')
```

La tendencia del consumo energético de la cocina para los meses de Enero es creciente. Se observa una fuerte componenete estacional.



```{r}
plot.ts( tsSM1_DiariaEnero, col = 'gray',main="Evolución del consumo energético del lavadero \n  de los meses de Enero")
lines(Componentes_SM1_DiariaEneroSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```



#### Lavadero: Submetering 2


```{r}
 tsSM2_DiariaEnero %>%
  stl( #t.window=13,
      s.window="periodic", 
      robust=TRUE) %>% summary()
```


```{r}
Componentes_SM2_DiariaEneroSTL<- tsSM2_DiariaEnero %>%
  stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_DiariaEneroSTL, ts.colour = 'blue')
```
No hay una única tendecia, los primeros días del mes de Enero del año 2007 se aprecia un aumento del consumo energético, al ogual que ocurre desde la segunda mitad del mes de enero del año 2008 hasta finales de 2009. Sin embargo, hay un descenso del consumo desde la segunda mitad del año 2007 hasta la misma fecha del año 2008

```{r}
plot.ts(tsSM2_DiariaEnero, col = 'gray', main="Evolución del consumo energético \n  del lavadero el mes de Enero")
lines(Componentes_SM2_DiariaEneroSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```






#### Aire acondicionado y termo eléctrico: Submetering 3


```{r}
tsSM3_DiariaEnero %>%
  stl( t.window=31,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```




La componente estacional tiene mucho peso.



```{r}
Componentes_SM3_DiariaEneroSTL<- tsSM3_DiariaEnero %>%
  stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_DiariaEneroSTL, ts.colour = 'blue')
```

Se observa un aumento del consumo energético del lavadero a lo largo de los meses de Enero desde los 8000 vatios hasta los 11000.

```{r}
plot.ts(tsSM3_DiariaEnero, col = 'gray', main="Evolución del consumo energético del AC y termo \n para el mes de Enero")
lines(Componentes_SM3_DiariaEneroSTL$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```




### Predicción con Holt-Winters (suavizado exponencial) para el año 2010



#### Evolución mensual del consumo (sin estacionalidad). Años 2007-2009

##### Cocina




```{r}
# LE quito la estacionalidad
tsSM1_DiariaEnero_detrended <- tsSM1_DiariaEnero - Componentes_SM1_DiariaEneroSTL$time.series[,1]
plot.ts(tsSM1_DiariaEnero_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución diaria del consumo energético de la cocina \n En el mes de Enero',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos:

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM1_DiariaEneroSTL$time.series[,3], col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM1_DiariaEneroSTL$time.series[,3])
qqline(Componentes_SM1_DiariaEneroSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM1_DiariaEneroSTL$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad. Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_DiariaEnero_detrended ,s.window = "periodic",robust = TRUE, t.window = 31))
```

Parece que la componente irregular no sigue ningún patrón.







###### Suavizado exponencial de HoltWinters

- Primera interacción

```{r}
tsSM1_HW_DiariaEnero<- HoltWinters(tsSM1_DiariaEnero_detrended ,
                                   alpha=TRUE)
summary(tsSM1_HW_DiariaEnero$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo variará en el rango: 0-10897 vatios.hora.

- Segunda interacción:

```{r}
tsSM1_HW_DiariaEnero<- HoltWinters(tsSM1_DiariaEnero_detrended ,
                                   alpha=TRUE, beta=TRUE)
summary(tsSM1_HW_DiariaEnero$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


Tendencia del consumo creciente.

- Tercera iteracción

```{r}

tsSM1_HW_DiariaEnero<- HoltWinters(tsSM1_DiariaEnero_detrended ,
                                   alpha=TRUE,
                                   beta=TRUE, gamma=TRUE)
summary(tsSM1_HW_DiariaEnero$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")

```


###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_DiariaEnero_for <- forecast(tsSM1_HW_DiariaEnero, h=31)
plot(tsSM1_HW_DiariaEnero_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético de la cocina \n Enero Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_DiariaEnero_forC <- forecast(tsSM1_HW_DiariaEnero, h=31, level=c(10,25))
## Plot only the forecasted area
plot(tsSM1_HW_DiariaEnero_forC, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción del consumo energético de la cocina \n  Enero del 2010", start(2010))
```




##### Lavadero




```{r}
tsSM2_DiariaEnero_detrended <- tsSM2_DiariaEnero - Componentes_SM2_DiariaEneroSTL$time.series[,1]
plot.ts(tsSM2_DiariaEnero_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución ',
        cex.main = 0.85)
```

Estudio de los resíduos.

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM2_DiariaEneroSTL$time.series[,3], col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_DiariaEneroSTL$time.series[,3])
qqline(Componentes_SM2_DiariaEneroSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_DiariaEneroSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena, por lo que volvemos a descomponer la serie.






```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_DiariaEnero_detrended ,s.window = "periodic",
         robust = TRUE,t.window = 31))
```


###### Suavizado exponencial de HoltWinters

- Primera interacción

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_DiariaEnero <- HoltWinters(tsSM2_DiariaEnero_detrended ,
                              alpha=TRUE)

summary(tsSM2_HW_DiariaEnero$fitted)

plot(tsSM2_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Rango de pronóstico del consumo energético del lavadero: 0-11795 vatios-hora.

- Segunda interacción: tendencia

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_DiariaEnero <- HoltWinters(tsSM2_DiariaEnero_detrended ,
                              alpha=TRUE,beta=TRUE)

summary(tsSM2_HW_DiariaEnero$fitted)

plot(tsSM2_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Aumento del consumo

- Tercera interacción


```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_DiariaEnero <- HoltWinters(tsSM2_DiariaEnero_detrended ,
                              alpha=TRUE,
                              beta=TRUE, gamma=TRUE)

summary(tsSM2_HW_DiariaEnero$fitted)

plot(tsSM2_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones, es decir, el consumo energético del mes de enero del año 2010.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_DiariaEnero_for <- forecast(tsSM2_HW_DiariaEnero, h=31)
plot(tsSM2_HW_DiariaEnero_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del lavadero \n Enero del año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_DiariaEnero_forC <- forecast(tsSM2_HW_DiariaEnero, h=31, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_DiariaEnero_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción del consumo energético del lavadero \n Enero del año 2010", start(2010))
```




##### AC y termo eléctrico


```{r}
tsSM3_DiariaEnero_detrended <- tsSM3_DiariaEnero - Componentes_SM3_DiariaEneroSTL$time.series[,1]
plot.ts(tsSM3_DiariaEnero_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Variación el consumo energético del mes de Enero',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos:

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM3_DiariaEneroSTL$time.series[,3], col = "blue",
       main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_DiariaEneroSTL$time.series[,3])
qqline(Componentes_SM3_DiariaEneroSTL$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_DiariaEneroSTL$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena, por lo que vamos a volver a descomponer la serie:




```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_DiariaEnero_detrended ,s.window = "periodic",robust = TRUE,t.window = 31))
```

La componente irregular no presenta ningún patrón. Además, observamos una fuerte tendencia creciente del consumo.


###### Suavizado exponencial de HoltWinters

- Primera interacción: rango del pronóstico de consumo.

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_DiariaEnero <- HoltWinters(tsSM3_DiariaEnero_detrended ,
                             alpha=TRUE)
summary(tsSM3_HW_DiariaEnero$fitted)
plot(tsSM3_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo energético del termo eléctrico y el aire acondicionado variará en torno al siguiente rango: 0-22353 vatios-hora

###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_DiariaEnero_for <- forecast(tsSM3_HW_DiariaEnero, h=31)
plot(tsSM3_HW_DiariaEnero_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \n Mes de enero del año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_DiariaEnero_forC <- forecast( object = tsSM3_HW_DiariaEnero_for, h=31)
## Plot only the forecasted area
plot(tsSM3_HW_DiariaEnero_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el mes de Enero del año 2010", start(2010), ylim=c(0,15000))
```









#### Comparación de resultados. Predicción despues de eliminar estacionalidad

```{r}
seriesDiariasEnero <- Granularidad_dias %>% 
  filter( year == 2010 & month == 1)


RMSE_SM1_Enero<-accuracy(tsSM1_HW_DiariaEnero_forC ,seriesDiariasEnero $Sub_metering_1)[4]
RMSE_SM2_Enero<-accuracy(tsSM2_HW_DiariaEnero_forC  ,seriesDiariasEnero $Sub_metering_2)[4]
RMSE_SM3_Enero<-accuracy(tsSM3_HW_DiariaEnero_forC  ,seriesDiariasEnero $Sub_metering_3)[4]



Error<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_Enero,
               RMSE_SM2_Enero,
               RMSE_SM3_Enero)
   
    
)

Error %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```

El error para la cocina es extremadamente alto, sin embargo para el lavadero podría ser aceptable y para el termo eléctrico y aire acondicionado es bastante bajo, el resultado es bueno.












## Pronóstico del consumo para los siguientes meses de Enero

### Cocina

```{r}
# Creamos la serie temporal con los datos completos
seriesDiariasEnero <- Granularidad_dias %>% filter( month == 1)
## Creamos un objeto TS
   tsSM1_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_1, frequency=31, start=c(2007,1))
   
   tsSM2_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_2, frequency=31, start=c(2007,1))
   
   tsSM3_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_3, frequency=31, start=c(2007,1))
```


```{r}
# Descomponemos la serie
Componentes_SM1_DiariaEneroSTL<-
  tsSM1_DiariaEnero %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)
# autoplot(Componentes_SM1_DiariaEneroSTL, ts.colour = 'blue')

# Eliminación de la estacionalidad
tsSM1_DiariaEnero_detrended <- tsSM1_DiariaEnero - Componentes_SM1_DiariaEneroSTL$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM1_HW_DiariaEnero <- HoltWinters(tsSM1_DiariaEnero_detrended   , 
                                seasonal = "additive",
  beta=TRUE, 
  gamma=TRUE,
   alpha=TRUE
)

```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalCocinaEnero <- forecast(tsSM1_HW_DiariaEnero, h=31)
## Plot only the forecasted area
plot(PrediccionFinalCocinaEnero, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  de la cocina para Enero del 2011", start(2011), ylim = c(0,5000))
```

Las predicciones son las siguientes:



```{r}
PrediccionFinalCocinaEnero[["mean"]] 
```

Vimos que estas predicciones tenían un error muy grande por lo que no son muy fiables.





### Lavadero



```{r}
# Descomponemos la serie
Componentes_SM2_DiariaEneroSTL<-
  tsSM2_DiariaEnero %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)
# autoplot(Componentes_SM2_DiariaEneroSTL, ts.colour = 'blue')

# Eliminación de la estacionalidad
tsSM2_DiariaEnero_detrended <- tsSM2_DiariaEnero - Componentes_SM2_DiariaEneroSTL$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM2_HW_DiariaEnero <- HoltWinters(tsSM2_DiariaEnero_detrended   , 
                                seasonal = "additive",
   beta=TRUE,
 gamma=TRUE
#alpha=TRUE
)

```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalLavaderoEnero <- forecast(tsSM2_HW_DiariaEnero , h=31)
## Plot only the forecasted area
plot(PrediccionFinalLavaderoEnero, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  del lavadero para Enero del 2011", start(2011), ylim=c(0,10000))
```

Las predicciones son las siguientes:



```{r}
PrediccionFinalLavaderoEnero[["mean"]] 
```

Predicciones negativas.
















### Aire acondicionado y termo eléctrico



```{r}
# Descomponemos la serie
Componentes_SM3_DiariaEneroSTL<-
  tsSM3_DiariaEnero %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)
# autoplot(Componentes_SM3_DiariaEneroSTL, ts.colour = 'blue')

# Eliminación de la estacionalidad
tsSM3_DiariaEnero_detrended <- tsSM3_DiariaEnero - Componentes_SM3_DiariaEneroSTL$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM3_HW_DiariaEnero <- HoltWinters(tsSM3_DiariaEnero_detrended   , 
        seasonal = "additive",
 #  beta=TRUE
  #gamma=TRUE
  alpha=TRUE
)
plot(tsSM3_HW_DiariaEnero)
```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalACTermoEnero <- forecast(tsSM3_HW_DiariaEnero , h=31)
## Plot only the forecasted area
plot(PrediccionFinalACTermoEnero, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  del AC y Termo para Enero del 2011", start(2011), ylim = c(0,20000))
```

Las predicciones son las siguientes:



```{r}
PrediccionFinalACTermoEnero[["mean"]] 
```

Predicciones negativas.


















# Evolución diaria del consumo por meses. Mes de Agosto

## Serie temporal y visualización

En este caso, crearemos una serie para cada mes, ya que la frecuencia de los datos no será la misma, al tener cada mes un número de días diferente.



```{r}
par(mfrow=c(2,2))
seriesDiariasAgosto <- Granularidad_dias %>% filter(year != 2006 & year != 2010 & month == 8)
## Creamos un objeto TS
   tsSM1_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_1, frequency=31, start=c(2007,1))
   
   tsSM2_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_2, frequency=31, start=c(2007,1))
   
   tsSM3_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_3, frequency=31, start=c(2007,1))
   
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_DiariaAgosto, ts.colour = 'red', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la cocina \n en el mes de Agosto. Años 2007-2009")
autoplot(tsSM2_DiariaAgosto, xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la lavandería \n  en el mes de Agosto. Años 2007-2009")
autoplot(tsSM3_DiariaAgosto, ts.colour = 'blue', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo energético del aire \n  y termo en el mes de Agosto. Años 2007-2009")

```

Vemos que el año 2008, el consumo energético en este mes disminuyó considerablemente. Para la cocina, el consumo fué de 0 en este mes.



## Descomposición de la serie y visualización

### Cocina: Submetering 1

Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.

```{r}
 tsSM1_DiariaAgosto %>%
  stl( t.window=31,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```

La componente irregular tiene bastante peso, al igual que la estacional.


```{r}
Componentes_SM1_DiariaAgosto<-
  tsSM1_DiariaAgosto %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM1_DiariaAgosto, ts.colour = 'blue')
```

La tendencia del consumo energético de la cocina para el mes de agosto es decreciente en el año 2008, pero apra el resto de años parece que la tendencia del consumo es prácticamente constante.

Se observa una fuerte componenete estacional, donde los últimos días de mes se consume mucho más que el resto.



```{r}
plot.ts( tsSM1_DiariaAgosto, col = 'gray',main="Evolución del consumo energético del lavadero \n  el mes de Agosto")
lines(Componentes_SM1_DiariaAgosto$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```



### Lavadero: Submetering 2


```{r}
tsSM2_DiariaAgosto %>%
  stl( t.window=31,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```

La componente que más peso tiene es la tendencia.


```{r}
Componentes_SM2_DiariaAgosto<- tsSM2_DiariaAgosto %>%
  stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_DiariaAgosto, ts.colour = 'blue')
```


La tendencia del consumo es creciente.

Respecto a la estacionalidad, parece que se consume más energía del lavadero los primeros días de Agosto que a final de este mes.

```{r}
plot.ts(tsSM2_DiariaAgosto, col = 'gray', main="Evolución del consumo energético \n  del lavadero el mes de Agosto")
lines(Componentes_SM2_DiariaAgosto$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```






### Aire acondicionado y termo eléctrico: Submetering 3


```{r}
tsSM3_DiariaAgosto %>%
  stl( t.window=31,
      s.window="periodic", 
      robust=TRUE)  %>% summary()
```




La componente de la tendencia es la que más peso tiene. Sin embargo, la componente regualr tiene más peso que la estacional.



```{r}
Componentes_SM3_DiariaAgosto<- tsSM3_DiariaAgosto %>%
  stl( t.window=31,
  s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_DiariaAgosto, ts.colour = 'blue')
```

La tendencia del consumo energético del termo eléctrico y aire acondicionado es creciente, aunque en el año 2008 el consumo fué decreciente.




```{r}
plot.ts(tsSM3_DiariaAgosto, col = 'gray', main="Evolución del consumo energético del AC y termo \n para el mes de Agosto")
lines(Componentes_SM3_DiariaAgosto$time.series[,2], 
      col = "red", lwd = 1, lty = 2)
```




## Predicción con Holt-Winters (suavizado exponencial) para el año 2010




### Cocina




```{r}
# LE quito la estacionalidad
tsSM1_DiariaAgosto_detrended <- tsSM1_DiariaAgosto - Componentes_SM1_DiariaAgosto$time.series[,1]
plot.ts(tsSM1_DiariaAgosto_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución diaria del consumo energético de la cocina \n En el mes de Agosto',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos:

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM1_DiariaAgosto$time.series[,3], col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM1_DiariaAgosto$time.series[,3])
qqline(Componentes_SM1_DiariaAgosto$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM1_DiariaAgosto$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad. Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM1_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31))

Componentes_SM1_DiariaAgosto<-stl(tsSM1_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31)
```

Parece que la componente irregular no sigue ningún patrón y que la componente estacional se mueve en un orden tan pequeño que es insignificante







#### Suavizado exponencial de HoltWinters

- Primera interacción

```{r}
tsSM1_HW_DiariaAgosto<- HoltWinters(tsSM1_DiariaAgosto_detrended ,
                                   alpha=TRUE)
summary(tsSM1_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo variará en el rango: 0-4303 vatios.hora.

- Segunda interacción:

```{r}
tsSM1_HW_DiariaAgosto<- HoltWinters(tsSM1_DiariaAgosto_detrended ,
                                   alpha=TRUE,beta=TRUE)
summary(tsSM1_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


Tendencia del consumo creciente.

- Tercera iteracción

```{r}
tsSM1_HW_DiariaAgosto<- HoltWinters(tsSM1_DiariaAgosto_detrended ,
                                   alpha=TRUE,
                                   beta=TRUE,gamma=TRUE)
summary(tsSM1_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_DiariaAgosto_for <- forecast(tsSM1_HW_DiariaAgosto, h=31)
plot(tsSM1_HW_DiariaAgosto_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético de la cocina \n Agosto Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_DiariaAgosto_forC <- forecast(tsSM1_HW_DiariaAgosto, h=31, level=c(10,25))
## Plot only the forecasted area
plot(tsSM1_HW_DiariaAgosto_forC, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción del consumo energético de la cocina \n  Agosto del 2010", start(2010), ylim=c(0,3500))
```

La predicción del consumo para los últimos días del mes de agosto es mucho mayor que el resto de los días.



### Lavadero




```{r}
# LE quito la estacionalidad
tsSM2_DiariaAgosto_detrended <- tsSM2_DiariaAgosto - Componentes_SM2_DiariaAgosto$time.series[,1]
plot.ts(tsSM2_DiariaAgosto_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución diaria del consumo energético del lavadero \n En el mes de Agosto',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos:

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM2_DiariaAgosto$time.series[,3], col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_DiariaAgosto$time.series[,3])
qqline(Componentes_SM2_DiariaAgosto$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_DiariaAgosto$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad. Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31))

Componentes_SM2_DiariaAgosto<-stl(tsSM2_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31)
```

Parece que la componente irregular no sigue ningún patrón y que la componente estacional se mueve en un orden tan pequeño ($10^{-7}$) que es insignificante.







#### Suavizado exponencial de HoltWinters

- Primera interacción

```{r}
tsSM2_HW_DiariaAgosto<- HoltWinters(tsSM2_DiariaAgosto_detrended ,
                                   alpha=TRUE)
summary(tsSM2_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM2_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo variará en el rango: 0-10571 vatios.hora.

- Segunda interacción:

```{r}
tsSM2_HW_DiariaAgosto<- HoltWinters(tsSM2_DiariaAgosto_detrended ,
                                   alpha=TRUE,beta=TRUE)
summary(tsSM2_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM1_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


Tendencia del consumo creciente.

- Tercera iteracción

```{r}
tsSM2_HW_DiariaAgosto<- HoltWinters(tsSM2_DiariaAgosto_detrended ,
                                   alpha=TRUE,
                                   beta=TRUE,gamma=TRUE)
summary(tsSM2_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM2_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Las predicciones van al revés, no van a ser buenas con esta configuración, dejamos alpha y beta correspondiente a la iteracción 2.



```{r}
tsSM2_HW_DiariaAgosto<- HoltWinters(tsSM2_DiariaAgosto_detrended ,
                                   alpha=TRUE
                                   ,beta=TRUE )

```

#### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_DiariaAgosto_for <- forecast(tsSM2_HW_DiariaAgosto, h=31)
plot(tsSM2_HW_DiariaAgosto_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético del lavadero \n Agosto Año 2010" ) 
```
Predice un consumo energético negativo


```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_DiariaAgosto_forC <- forecast(tsSM2_HW_DiariaAgosto, h=31, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_DiariaAgosto_forC, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción del consumo energético del lavadero \n  Agosto del 2010", start(2010))
```




### Aire acondicionado y termo eléctrico




```{r}
# LE quito la estacionalidad
tsSM3_DiariaAgosto_detrended <- tsSM3_DiariaAgosto - Componentes_SM3_DiariaAgosto$time.series[,1]
plot.ts(tsSM3_DiariaAgosto_detrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución diaria del consumo energético del AC y termo \n En el mes de Agosto',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos:

```{r}
par(mfrow = c(1,2))
  plot(Componentes_SM3_DiariaAgosto$time.series[,3], col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_DiariaAgosto$time.series[,3])
qqline(Componentes_SM3_DiariaAgosto$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_DiariaAgosto$time.series[,3])
```

Los resíduos no son solo ruido. Aún hay estacionalidad. Volvemos a descomponer la serie desestacionalizada una vez.


```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31))

Componentes_SM3_DiariaAgosto<-stl(tsSM3_DiariaAgosto_detrended ,s.window = "periodic",robust = TRUE, t.window = 31)
```

Parece que la componente irregular no sigue ningún patrón y que la componente estacional se mueve en un orden tan pequeño ($10^{-6}$) que es insignificante.







#### Suavizado exponencial de HoltWinters

- Primera interacción

```{r}
tsSM3_HW_DiariaAgosto<- HoltWinters(tsSM3_DiariaAgosto_detrended ,
                                   alpha=TRUE)
summary(tsSM3_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM3_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo variará en el rango: 0-11828 vatios-hora.

- Segunda interacción:

```{r}
tsSM3_HW_DiariaAgosto<- HoltWinters(tsSM3_DiariaAgosto_detrended ,
                                   alpha=TRUE,beta=TRUE)
summary(tsSM3_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM3_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


Tendencia del consumo creciente.

- Tercera iteracción

```{r}
tsSM3_HW_DiariaAgosto<- HoltWinters(tsSM3_DiariaAgosto_detrended ,
                                   alpha=TRUE,
                                   beta=TRUE,gamma=TRUE)
summary(tsSM3_HW_DiariaAgosto$fitted)
# optimiza
plot(tsSM3_HW_DiariaEnero,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```
Las predicciones van al revés, no van a ser buenas con esta configuración, dejamos alpha y beta correspondiente a la iteracción 2.


```{r}
tsSM3_HW_DiariaAgosto<- HoltWinters(tsSM3_DiariaAgosto_detrended
                                 # ,alpha=TRUE
                                 # ,beta=TRUE
                                 # ,gamma=TRUE
                                   )
```


#### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_DiariaAgosto_for <- forecast(tsSM3_HW_DiariaAgosto, h=31)
plot(tsSM3_HW_DiariaAgosto_for , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético del AC y termo \n Agosto Año 2010" ) 
```
Predice un consumo energético negativo


```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_DiariaAgosto_forC <- forecast(tsSM3_HW_DiariaAgosto, h=31, level=c(10,25))
## Plot only the forecasted area
plot(tsSM3_HW_DiariaAgosto_forC, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción del consumo energético del lavadero \n  Agosto del 2010", start(2010))
```


### Comparación de resultados. Predicción despues de eliminar estacionalidad

```{r}
seriesDiariasAgosto <- Granularidad_dias %>% 
  filter( year == 2010 & month == 8)


RMSE_SM1_Agosto<-accuracy(tsSM1_HW_DiariaAgosto_forC,
                          seriesDiariasAgosto$Sub_metering_1)[4]
RMSE_SM2_Agosto<-accuracy(tsSM2_HW_DiariaAgosto_forC,
                          seriesDiariasAgosto$Sub_metering_2)[4]
RMSE_SM3_Agosto<-accuracy(tsSM3_HW_DiariaAgosto_forC,
                          seriesDiariasAgosto$Sub_metering_3)[4]

ErrorAgosto<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_Agosto,
               RMSE_SM2_Agosto,
               RMSE_SM3_Agosto)
   
    
)

ErrorAgosto %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```

El error para el lavadero es extremadamente alto, sin embargo para la cocina y el termo el ajuste es bastabte mejor y el error es muy bajo.



## Pronóstico del consumo para los siguientes meses de Agosto



### Cocina

```{r}
# Creamos la serie temporal con los datos completos
seriesDiariasAgosto <- Granularidad_dias %>% filter( month == 8)
## Creamos un objeto TS
   tsSM1_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_1, frequency=31, start=c(2007,1))
   
   tsSM2_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_2, frequency=31, start=c(2007,1))
   
   tsSM3_DiariaAgosto<- ts(seriesDiariasAgosto$Sub_metering_3, frequency=31, start=c(2007,1))
```


```{r}
# Descomponemos la serie
Componentes_SM1_DiariaAgosto<-
  tsSM1_DiariaAgosto %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)

# Eliminación de la estacionalidad
tsSM1_DiariaAgosto_detrended <- tsSM1_DiariaAgosto - Componentes_SM1_DiariaAgosto$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM1_HW_DiariaAgosto <- HoltWinters(tsSM1_DiariaAgosto_detrended   ,  seasonal = "additive",beta=TRUE, gamma=TRUE, alpha=TRUE)

```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalCocinaAgosto <- forecast(tsSM1_HW_DiariaAgosto, h=31)
## Plot only the forecasted area
plot(PrediccionFinalCocinaAgosto, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  de la cocina para Agosto del 2011", start(2011),ylim = c(0,25000))
```

El consumo es claramente creciente.


Las predicciones son las siguientes:



```{r}
PrediccionFinalCocinaAgosto[["mean"]] 
```






### Lavadero

Las predicciones no serán del todo fiables, por lo que no tienen mucho sentido y no lo pondremos en la web.



```{r}
# Descomponemos la serie
Componentes_SM2_DiariaAgosto<-
  tsSM2_DiariaAgosto %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)

# Eliminación de la estacionalidad
tsSM2_DiariaAgosto_detrended <- tsSM2_DiariaAgosto - Componentes_SM2_DiariaAgosto$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM2_HW_DiariaAgosto <- HoltWinters(tsSM2_DiariaAgosto_detrended   ,  seasonal = "additive",beta=TRUE,  alpha=TRUE)

```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalLavaderoAgosto <- forecast(tsSM2_HW_DiariaAgosto, h=31)
## Plot only the forecasted area
plot(PrediccionFinalLavaderoAgosto, ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético \n  del lavadero para Agosto del 2011", start(2011),ylim = c(0,35000))
```




Las predicciones son las siguientes:



```{r}
PrediccionFinalLavaderoAgosto[["mean"]] 
```





### Aire acondicionado y termo eléctrico



```{r}
# Descomponemos la serie
Componentes_SM3_DiariaAgosto<-
  tsSM3_DiariaAgosto %>%stl( t.window=31,
  s.window="periodic",  robust=TRUE)

# Eliminación de la estacionalidad
tsSM3_DiariaAgosto_detrended <- tsSM3_DiariaAgosto - Componentes_SM3_DiariaAgosto$time.series[,1]

# Suavizado exponencial tal y como hemos obtenido el mejor modelo
tsSM3_HW_DiariaAgosto <- 
  HoltWinters(tsSM3_DiariaAgosto_detrended,  seasonal = "additive")

```

```{r}
# Pronóstico para los siguientes 13 meses 
PrediccionFinalTermoAcAgosto <- forecast(tsSM3_HW_DiariaAgosto, h=31)
## Plot only the forecasted area
plot(PrediccionFinalTermoAcAgosto , ylab= "Vatios-Hora", xlab="Fecha", main="Pronóstico el consumo energético \n  del AC y Termo para Agosto del 2011", start(2011),ylim = c(0,20000))
```




Las predicciones son las siguientes:



```{r}
PrediccionFinalTermoAcAgosto[["mean"]] 
```





### Datos y gráficas de las predicciones para el cliente


```{r}
# PAra ggplot 2

Fecha=c("2011-08-1"	 ,"2011-08-2"	 ,"2011-08-3"	 ,"2011-08-4"	 ,"2011-08-5"	 ,"2011-08-6"	 ,"2011-08-7"	 ,"2011-08-8"	 ,"2011-08-9"	 ,"2011-08-10","2011-08-11"	,"2011-08-12"	,"2011-08-13",
        "2011-08-14"	,"2011-08-15"	,"2011-08-16"	,"2011-08-17"	,"2011-08-18"	,"2011-08-19"	,"2011-08-20", "2011-08-21"	,"2011-08-22"	,"2011-08-23"	,"2011-08-24"	,"2011-08-25"	,"2011-08-26"	,"2011-08-27"	,"2011-08-28"	,"2011-08-29"	,"2011-08-30","2011-08-31"	) 

Fecha<- as.Date(Fecha, format = "%Y-%m-%d")
```

```{r}
dfPlotlyPronosticoAgosto<-data.frame(
  Fecha=Fecha )
dfPlotlyPronosticoAgosto$Cocina <- as.vector(PrediccionFinalCocinaAgosto[["mean"]] )
dfPlotlyPronosticoAgosto$Lavadero<-as.vector(PrediccionFinalLavaderoAgosto[["mean"]])
dfPlotlyPronosticoAgosto$AireTermo<-as.vector(PrediccionFinalTermoAcAgosto[["mean"]])

#   save(dfPlotlyPronosticoAgosto, file =    # "Datos/Pronostico/DF_Energia_PronosticoAgosto_11.RData")
```



```{r}
plot_ly(dfPlotlyPronosticoAgosto,
       x = ~dfPlotlyPronosticoAgosto$Fecha, 
       y = ~dfPlotlyPronosticoAgosto$Cocina,
             name = "Cocina" , type='scatter',  mode='lines'  ) %>% 
    add_trace( y = ~dfPlotlyPronosticoAgosto$Lavadero,name = "Lavadero" , mode='lines')%>%
    add_trace( y = ~dfPlotlyPronosticoAgosto$AireTermo, name = "Aire acondicionado y termo" , mode='lines') %>%
    layout(title = "Pronóstico del consumo energético para Agosto del año 2011",
           xaxis = list(title = "Mes")
           , yaxis = list (title = "Energía (Varios-hora)"))
```



```{r}

```





# Evolución del diaria del consumo los Lunes a las 20h para el AC y Termo eléctrico

Vamos a analizar la serie temporal del submedidor 3, aire acondicionado y termo eléctrico. Vamos a extraer 52 observaciones por año, esto es igual a una observación diaria. Lunes a las 20h.
Años 2007, 2008 y 2009

## Aire acondicionado y termo eléctrico

### Definicicón y representación de la serie temporal

```{r}
## Subset
house070809weekly <- filter(DatosCompletos, weekday == 2 & hour == 20 & minute == 1 & year != 2006 & year != 2010 )
## Creamos un objeto TS
tsSM3_070809weekly <- ts(house070809weekly$Sub_metering_3, frequency=52, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM3_070809weekly, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Serie Temporal del aire acondicionado y termo eléctrico")
```

### Modelo de regresión lineal

```{r}
## Apply time series linear regression to the sub-meter 3 ts object and use summary to obtain R2 and RMSE from the model you built

fitSM3 <- tslm(tsSM3_070809weekly ~ trend + season) 
summary(fitSM3)
```

El valor de $R^2$ es 0.2639, es decir, el modelo explica un 26% de la variabilidad total del experimento. Se trata de un valor muy pobre y las predicciones no serán nada fiables, por lo que ni las vamos a hacer.

### Descomposición de la serie temporal



```{r}
Componentes_SM3_070809weekly<- tsSM3_070809weekly %>%
  stl( t.window=52,s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM3_070809weekly, ts.colour = 'red', main="Descomposición de componentes")
```

Se aprecia una gran influencia de la componente estacional: oscilaciones que se repiten cada año, por ejemplo, vemos que hay días en los que el consumo es mucho más elevado que el resto.

Tambien se aprecia una tendencia creciente de consumo, cada año se consume más que el anterior.

Remainder no es un muelle, gráficamente, parece que la componente irregular no es del todo aleatoria.


### Evolución del consumo para los datos sin estacionalidad
#### ELiminación de la estacionalidad del AC y termo eléctrico


```{r}
tsSM3_070809weeklyDetrended <- tsSM3_070809weekly - Componentes_SM3_070809weekly$time.series[,1]
plot.ts(tsSM3_070809weeklyDetrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución el consumo energético del aire acondicionado y termo eléctrico \n Datos sin estacionalidad',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos.

```{r}
par(mfrow = c(1,2))
plot(Componentes_SM3_070809weekly$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM3_070809weekly$time.series[,3])
qqline(Componentes_SM3_070809weekly$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM3_070809weekly$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.


Hay que volver a descomponer la serie.

```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM3_070809weeklyDetrended ,s.window = "periodic",
         robust = TRUE,t.window = 52))
```

Parece que la componente irregular es aleatoria y que la componente estacional se mueve en unos intervalos de energía pequeños en comparafción al consumo de este submedidor.



#### Suavizado exponencial de HoltWinters



- Primera iteracción: Solo con $\alpha$, voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM3_HW_weekly <- HoltWinters(tsSM3_070809weeklyDetrended , seasonal = "additive",
#   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM3_HW_weekly$fitted)

# optimiza
plot(tsSM3_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo será en el rango: 0-40 vatios-hora de energía consumida, ya que no puede haber un consumo energético negativo.


- Segunda iteracción: Añadiendo $\beta$ podré averiguar la tendencia del consumo para las predicciones 

```{r}
tsSM3_HW_weekly <- HoltWinters(tsSM3_070809weeklyDetrended , 
                               seasonal = "additive",
   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM3_HW_weekly$fitted)

# optimiza
plot(tsSM3_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

Tendencia al consumo creciente como ya hemos comentado antes.

- Tercera iteracción: Si añado $\gamma$ podré ver la estacionalidad.

```{r}
tsSM3_HW_weekly <- HoltWinters(tsSM3_070809weeklyDetrended, seasonal = "additive",
   beta=TRUE, 
  gamma=TRUE
  ,
   alpha=TRUE
)

summary(tsSM3_HW_weekly$fitted)

# optimiza
plot(tsSM3_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_weekly <- HoltWinters(tsSM3_070809weeklyDetrended,
                              # tsSM3_Mensual_Adjusted,
                                beta=TRUE, gamma=TRUE)
plot(tsSM3_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



#### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_weekly_for <- forecast(tsSM3_HW_weekly , h=52)
plot(tsSM3_HW_weekly_for  , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_weekly_forC <- forecast(tsSM3_HW_weekly , h=52, level=c(10,25))
## Plot only the forecasted area
plot(tsSM3_HW_weekly_forC , ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético del lavadero y termo eléctrico \n  Lunes a las 20h del año 2010", start(2010), ylim=c(0,200))
```
### Análisis del error


```{r}

DatosRealesLunes <- filter(DatosCompletos, weekday == 2 & hour == 20 & minute == 1 &  year == 2010 )

RMSE_SM3<-accuracy(tsSM3_HW_weekly_forC,DatosRealesLunes$Sub_metering_3)[4]


ResEvo <-
cbind.data.frame(
      Submedidor=c("AC y TermoE"),
      RMSE = c(RMSE_SM3_GranMensualFor)
)
ResEvo%>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


El error comentido en la predicción es muy grande.







## Lavadero

### Definicicón y representación de la serie temporal

```{r}
## Creamos un objeto TS
tsSM2_070809weekly <- ts(house070809weekly$Sub_metering_2, frequency=52, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM2_070809weekly, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución del consumo energético del lavadero")
```

### Modelo de regresión lineal

```{r}
## Apply time series linear regression to the sub-meter 3 ts object and use summary to obtain R2 and RMSE from the model you built

fitSM2 <- tslm(tsSM2_070809weekly ~ trend + season) 
summary(fitSM2)
```

El valor de $R^2$ es 0.3253, es decir, el modelo explica un 26% de la variabilidad total del experimento. Se trata de un valor muy pobre y las predicciones no serán nada fiables, por lo que ni las vamos a hacer.

### Descomposición de la serie temporal



```{r}
Componentes_SM2_070809weekly<- tsSM2_070809weekly %>%
  stl( t.window=52,s.window="periodic",  robust=TRUE)
autoplot(Componentes_SM2_070809weekly, ts.colour = 'red', main="Descomposición de componentes")
```

Se aprecia una gran influencia de la componente estacional: oscilaciones que se repiten cada año, por ejemplo, vemos que hay días en los que el consumo es mucho más elevado que el resto.

Tambien se aprecia una tendencia decreciente de consumo, cada año se consume menos energía debido al uso del lavadero que el anterior.

Remainder no es un muelle, pero no se observa patrón, gráficamente, parece que la componente irregular podría ser aleatoia.


### Evolución del consumo para los datos sin estacionalidad
#### ELiminación de la estacionalidad del AC y termo eléctrico


```{r}
tsSM2_070809weeklyDetrended <- tsSM2_070809weekly - Componentes_SM2_070809weekly$time.series[,1]
plot.ts(tsSM2_070809weeklyDetrended, 
        ylab = "Energía (Vatios-hora)", 
        main = 'Evolución el consumo energético del lavadero \n Datos sin estacionalidad',
        cex.main = 0.85)
```

Vamos a estudiar los resíduos.

```{r}
par(mfrow = c(1,2))
plot(Componentes_SM2_070809weekly$time.series[,3], 
     col = "blue", main = 'Remainder', ylab = "")
qqnorm(Componentes_SM2_070809weekly$time.series[,3])
qqline(Componentes_SM2_070809weekly$time.series[,3])
```


```{r}
shapiro.test(Componentes_SM2_070809weekly$time.series[,3])
```

Los resíduos no siguen una distribución normal. La descomposición no es buena.


Hay que volver a descomponer la serie.

```{r}
## Volvemos a descomponer la serie
plot(stl(tsSM2_070809weeklyDetrended ,s.window = "periodic",
         robust = TRUE,t.window = 52))
```

Parece que la componente irregular es aleatoria y que la componente estacional se mueve en unos intervalos de energía pequeños en comparación al consumo de este submedidor.



#### Suavizado exponencial de HoltWinters



- Primera iteracción: Solo con $\alpha$, voy a averiguar en que margen se va a mover la predicción


```{r}
tsSM2_HW_weekly <- HoltWinters(tsSM2_070809weeklyDetrended , 
                               seasonal = "additive",
#   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM2_HW_weekly$fitted)

# optimiza
plot(tsSM2_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```

El pronóstico de consumo será en el rango: 0-70 vatios-hora de energía consumida, ya que no puede haber un consumo energético negativo.


- Segunda iteracción: Añadiendo $\beta$ podré averiguar la tendencia del consumo para las predicciones 

```{r}
tsSM2_HW_weekly <- HoltWinters(tsSM2_070809weeklyDetrended , 
                               seasonal = "additive",
   beta=TRUE, 
#   gamma=TRUE,
   alpha=TRUE
)

summary(tsSM2_HW_weekly$fitted)

# optimiza
plot(tsSM2_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



- Tercera iteracción: Si añado $\gamma$ podré ver la estacionalidad.

```{r}
tsSM2_HW_weekly <- HoltWinters(tsSM2_070809weeklyDetrended,
                               seasonal = "additive",
   beta=TRUE, 
  gamma=TRUE
  ,
   alpha=TRUE
)

summary(tsSM2_HW_weekly$fitted)

# optimiza
plot(tsSM2_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```


Los valores extremos afectan mucho.

```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_weekly <- HoltWinters(tsSM2_070809weeklyDetrended,
                              # tsSM3_Mensual_Adjusted,
                                beta=TRUE, gamma=TRUE)
plot(tsSM2_HW_weekly,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



#### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_weekly_for <- forecast(tsSM2_HW_weekly , h=52)
plot(tsSM2_HW_weekly_for  , ylab= "Vatios-Hora", xlab="Fecha",
     main="Predicción del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_weekly_forC <- forecast(tsSM2_HW_weekly , h=52, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_weekly_forC , ylab= "Vatios-Hora", xlab="Fecha", main="Predicción el consumo energético del lavadero \n  Lunes a las 20h del año 2010", start(2010), ylim=c(0,1000))
```
### Análisis del error


```{r}

DatosRealesLunes <- filter(DatosCompletos, weekday == 2 & hour == 20 & minute == 1 &  year == 2010 )

RMSE_SM2<-accuracy(tsSM2_HW_weekly_forC,DatosRealesLunes$Sub_metering_2)[4]


ResEvo <-
cbind.data.frame(
      Submedidor=c("AC y TermoE"),
      RMSE = c(RMSE_SM2_GranMensualFor)
)
ResEvo%>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


El error comentido en la predicción es grande, pero vamos a hacer un pronóstico del consumo.

## Pronóstico del consumo enerétido del Lavadero para los Lunes del año 2011

```{r}
## Forecast HoltWinters with diminished confidence levels
PronosticoLunesSM2_2011<- forecast(tsSM2_HW_weekly , h=104, level=c(10,25))
## Plot only the forecasted area
plot(PronosticoLunesSM2_2011 , ylab= "Vatios-Hora", xlab="Fecha", main="Pronóstico del consumo energético del lavadero \n  Lunes a las 20h del año 2011", xlim=c(2011,2012), ylim=c(0,2000))
```

El pronóstico de consumo energético es el siguiente:

```{r}
PronosticoLunesSM2_2011[["mean"]][52:104]
```

Son prediccionesm uy grandes, y la tendencia era decreciente.



El pronóstico es un consumo muy grande, a pesar de que la tendencia de consumo era decreciente, por eso no son buenas predicciones.






