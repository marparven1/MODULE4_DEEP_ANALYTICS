---
title: "Análisis de Series Temporales"
subtitle: "IOT Analytics"
author: "Marta Venegas Pardo"
date: "2/9/2022"
output: 
  rmdformats::readthedown:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
pkgdown:
  as_is: true    
---



```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "80")
knitr::opts_chunk$set(
  echo = FALSE, cache = FALSE, prompt = FALSE,
  tidy = FALSE, comment = NA,
  message = FALSE, warning = FALSE
)
opts_knit$set(width = 80)
setwd("~/Desktop/UBIQUM/Advanced Data Analytics and Machine Learning/MODULE4_DEEP_ANALYTICS")
```



```{r librerias ,message=FALSE}
library(dplyr)
library(tidyverse)
library(kableExtra)
library(DT) # DataTables



library(imputeTS) # Tratamiento de datos faltantes

library(plotly)   # Gráficas
library(ggplot2)  # Gráficas
library(ggfortify)

library(forecast) # Tratamiento de series temporales
```



```{r , cargaDatos}
load(file="Datos/DF_Energia_GMinutos.RData")
load(file="Datos/DF_Energia_GHoras.RData")
load(file="Datos/DF_Energia_GDiaria.RData")
load(file="Datos/DF_Energia_GMensual.RData")
```



# Preparación para analizar los datos. Series temporales



## Objetivo

Proyección del consumo energético a través de series temporales.

## Procedimiento

Estudiaremos los datos de consumo energético correspondientes a los años 2007 a 2009 a través de series temporales. 

Haremos proyección de futuro para el año 2010 y compararemos los resultados con los datos reales de este último año (serie real).


## Preparación para analizar los datos. Primera visualización

### Evolución mensual del consumo. Años 2007-2009


Vamos a representar la serie por meses para cada submedidor y tambien para la energía global co granularidad mensual. En este caso, la frecuencia será 12, tenemos una observación por mes para los años 2007,8 y 2009.


```{r}
seriesMensuales <- Granularidad_meses %>% filter(year != 2006 & year != 2010)
## Creamos un objeto TS
tsSM1_Mensual<- ts(seriesMensuales$Sub_metering_1, frequency=12, start=c(2007,1))
tsSM2_Mensual<- ts(seriesMensuales$Sub_metering_2, frequency=12, start=c(2007,1))
tsSM3_Mensual<- ts(seriesMensuales$Sub_metering_3, frequency=12, start=c(2007,1))
tsSM_GAP_Mensual<- ts(seriesMensuales$Global_active_power, frequency=12, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Mensual, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la cocina \n Años 2007-2009")
autoplot(tsSM2_Mensual, xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Mensual, ts.colour = 'blue', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
autoplot(tsSM_GAP_Mensual, ts.colour = 'green', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía \n Años 2007-2009")
```


Parece que los datos tienen estacionariedad (movimientos que se repiten cada año), esto ocurre para todas las variables.






## Forecasting antes de descomponer la serie


Vamos a plicar regresión lineal a cada serie temporal, y veremos el valor de $R^2$ y del error cuadrático medio.



### Evolución mensual del consumo. Años 2007-2009

#### SM1. Cocina

##### Modelo

```{r}
fitSM1_Mensual <- tslm(tsSM1_Mensual ~ trend + season) 
summary(fitSM1_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.5796. Es un valor bajo, el modelo únicamente explica el 58% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

##### Predicción IC

Predicción para los próximos 20 días

```{r}
forecastfitSM1_Mensual <- forecast(fitSM1_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM1_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```








#### SM2. Lavadero

##### Modelo

```{r}
fitSM2_Mensual <- tslm(tsSM2_Mensual ~ trend + season) 
summary(fitSM2_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.6541. Es un valor bajo, el modelo únicamente explica el 65% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

##### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM2_Mensual <- forecast(fitSM2_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM2_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo










#### SM3. AC y termo

##### Modelo

```{r}
fitSM3_Mensual <- tslm(tsSM3_Mensual ~ trend + season) 
summary(fitSM3_Mensual)
```

Resultados:

- Valor del coeficiente de determinación: 0.7577. Es un valor que podría ser aceptable, el modelo únicamente explica el 76% de la variabilidad total.

- Hay tres coeficientes significativamente no nulos.

##### Predicción IC

Predicción para los próximos 12 meses (año 2010) 

```{r}
forecastfitSM3_Mensual <- forecast(fitSM3_Mensual, h=12, level=c(80,90))
## h=12 para predecir el año 2010
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM3_Mensual, ylab= "Watt-Hours", xlab="Fecha",
     main="Predicción del consumo energético del año 2010 \n  a través de un modelo de regresión")
```


Se prevee una bajada del consumo







#### Comparación de los coeficientes y resultados de cada modelo



```{r}
DatosRealesSeriesMensuales <- Granularidad_meses %>% filter(year == 2010 )

RMSE_SM1_GranMensual<-accuracy(forecastfitSM1_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
R2_SM1_GranMensual<-0.5796
MASE_SM1_GranMensual<-accuracy(forecastfitSM1_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_1)[12]

RMSE_SM2_GranMensual<-accuracy(forecastfitSM2_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
R2_SM2_GranMensual<-0.6541
MASE_SM2_GranMensual<-accuracy(forecastfitSM2_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_2)[12]



RMSE_SM3_GranMensual<-accuracy(forecastfitSM3_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_3)[4]
R2_SM3_GranMensual<-0.7577
MASE_SM3_GranMensual<-accuracy(forecastfitSM3_Mensual  ,DatosRealesSeriesMensuales$Sub_metering_3)[12]

ResEvolMensual<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensual,RMSE_SM2_GranMensual,RMSE_SM3_GranMensual),
     # MASE = c(MASE_SM1_GranMensual,MASE_SM2_GranMensual,MASE_SM3_GranMensual),
      R2 = c(R2_SM1_GranMensual,R2_SM2_GranMensual,R2_SM3_GranMensual)
)

ResEvolMensual %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")


# MASE: Mean absolute error
# RMSE: root mean scuare error. Diferencia entre los valores predichos y los observados.


```


El RMSE del modelo con mejor coeficiente de determinación es el más alto. Pero no hay que olvidar que el consumo eléctrico para el submedidor correspondiente al AC y termo eléctrico es el que más energía consume de todos con una diferencia muy grande.













## Forecasting descomponiendo la serie (así ok)



Descomponer: quitar tendencia


### Descomposición y visualización


#### Evolución mensual del consumo. Años 2007-2009

##### Submetering 1

```{r}
## Descomponer la serie
Componentes_SM1_Mensual <- decompose(tsSM1_Mensual)
## Plot
plot(Componentes_SM1_Mensual )
# stl(tsSM1_Mensual)
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM1_Mensual )
```


Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.



##### Submetering 2

```{r}
## Descomponer la serie
Componentes_SM2_Mensual <- decompose(tsSM2_Mensual)
## Plot
plot(Componentes_SM2_Mensual )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM2_Mensual )
```

Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia decreciente.




##### Submetering 3

```{r}
## Descomponer la serie
Componentes_SM3_Mensual <- decompose(tsSM3_Mensual)
## Plot
plot(Componentes_SM3_Mensual )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM3_Mensual )
```


Se aprecia componente estacional: oscilacione que se repiten cada año.
La componente tendencia tambien se aprecia. Tendencia creciente






















### Predicción con Holt-Winters (suavizado exponencial)

Sin estacionalidad 

Sería interesante verlo también con estacionalidad, para ver si se mantiene o no la tendencia.

Tendencia de predicción (crecimiento o decrecimiento del consumo) y predicción teniendo en cuenta las componentes




#### Evolución mensual del consumo. Años 2007-2009


##### Cocina






```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
tsSM1_Mensual_Adjusted <- tsSM1_Mensual - Componentes_SM1_Mensual$seasonal
autoplot(tsSM1_Mensual_Adjusted)
```

Parece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM1_Mensual_Adjusted))
```

La componente estacional se mueve en un ranfo de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM1_HW_Mensual <- HoltWinters(tsSM1_Mensual_Adjusted, beta=TRUE, gamma=TRUE)
# optimiza
plot(tsSM1_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM1_HW_Mensual_for <- forecast(tsSM1_HW_Mensual, h=12)
plot(tsSM1_HW_Mensual_for , ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico",
     main="Predicción del consumo energético de la cocina \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM1_HW_Mensual_forC <- forecast(tsSM1_HW_Mensual, h=12, level=c(10,25))
## Plot only the forecasted area
plot(tsSM1_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```









##### Lavadero

```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
tsSM2_Mensual_Adjusted <- tsSM2_Mensual - Componentes_SM2_Mensual$seasonal
autoplot(tsSM2_Mensual_Adjusted)
```

No arece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM2_Mensual_Adjusted))
```

La componente estacional se mueve en un ranfo de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM2_HW_Mensual <- HoltWinters(tsSM2_Mensual_Adjusted, beta=TRUE, gamma=TRUE)
plot(tsSM2_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM2_HW_Mensual_for <- forecast(tsSM2_HW_Mensual, h=12)
plot(tsSM2_HW_Mensual_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del lavadero \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM2_HW_Mensual_forC <- forecast(tsSM2_HW_Mensual, h=12, level=c(10,25))
## Plot only the forecasted area
plot(tsSM2_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```















##### AC y termo eléctrico

```{r}
## Seasonal adjusting sub-meter 3 by subtracting the seasonal component & plot
tsSM3_Mensual_Adjusted <- tsSM3_Mensual - Componentes_SM3_Mensual$seasonal
autoplot(tsSM3_Mensual_Adjusted)
```

No parece un muelle.


```{r}
## Volvemos a descomponer la serie
plot(decompose(tsSM3_Mensual_Adjusted))
```

La componente estacional se mueve en un ranfo de $10^{-11}$, podemos asumir que se ha eliminado esta componente.


###### Suavizado exponencial de HoltWinters



```{r}
## Holt Winters Exponential Smoothing & Plot
tsSM3_HW_Mensual <- HoltWinters(tsSM3_Mensual_Adjusted, beta=TRUE, gamma=TRUE)
plot(tsSM3_HW_Mensual,
     xlab="Fecha",
     ylab="Valores observados y ajustados",
     main="Suavizado exponencial de Holt-Winters")
```



###### Pronóstico de HoltWinters para el año 2010

Vamos a predecir las próximas 12 observaciones.

```{r}
## HoltWinters forecast & plot
tsSM3_HW_Mensual_for <- forecast(tsSM3_HW_Mensual, h=12)
plot(tsSM3_HW_Mensual_for , ylab= "Vatios-Hora", xlab="Fecha - Lavadero",
     main="Predicción del consumo energético del AC y termo eléctrico \ Año 2010" ) 
```



```{r}
## Forecast HoltWinters with diminished confidence levels
tsSM3_HW_Mensual_forC <- forecast(tsSM3_HW_Mensual, h=12, level=c(10,25))
## Plot only the forecasted area
plot(tsSM3_HW_Mensual_forC, ylab= "Vatios-Hora", xlab="Fecha - AireAcondicionado y termo eléctrico", main="Predicción para el año 2010", start(2010))
```






##### Comparación de los coeficientes y resultados de cada predicción


```{r}
RMSE_SM1_GranMensualFor<-accuracy(tsSM1_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_1)[4]
RMSE_SM2_GranMensualFor<-accuracy(tsSM2_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_2)[4]
RMSE_SM3_GranMensualFor<-accuracy(tsSM3_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_3)[4]


ResEvolMensual2<-
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranMensualFor,
               RMSE_SM2_GranMensualFor,
               RMSE_SM3_GranMensualFor)
   
    
)

ResEvolMensual2 %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
```


```{r}
accuracy(tsSM2_HW_Mensual_forC   ,DatosRealesSeriesMensuales$Sub_metering_1)
```
























## Comparación de resultados. Predicción antes y despues de eliminar estacionalidad


```{r}

Comparacion<-cbind.data.frame(ResEvolMensual2,ResEvolMensual[,2])

colnames(Comparacion) <- c("Submedidor","RMSE","RMSEDeco")
Comparacion %>% kable(booktabs=TRUE) %>% kable_styling(latex_options = "striped")
         

```


Resultados más fiables y con menor error trás haber descompuesto la serie






