---
title: "Análisis de Series Temporales"
subtitle: "IOT Analytics"
author: "Marta Venegas Pardo"
date: "2/9/2022"
output: 
  rmdformats::readthedown:
    code_folding: show
    self_contained: true
    thumbnails: false
    lightbox: false
pkgdown:
  as_is: true    
---



```{r setup, include=FALSE}
library(knitr)
library(rmdformats)
## Global options
options(max.print = "80")
knitr::opts_chunk$set(
  echo = FALSE, cache = FALSE, prompt = FALSE,
  tidy = FALSE, comment = NA,
  message = FALSE, warning = FALSE
)
opts_knit$set(width = 80)
setwd("~/Desktop/UBIQUM/Advanced Data Analytics and Machine Learning/MODULE4_DEEP_ANALYTICS")
```



```{r librerias ,message=FALSE}
library(dplyr)
library(tidyverse)
library(kableExtra)
library(DT) # DataTables



library(imputeTS) # Tratamiento de datos faltantes

library(plotly)   # Gráficas
library(ggplot2)  # Gráficas
library(ggfortify)

library(forecast) # Tratamiento de series temporales
```



```{r , cargaDatos}
load(file="Datos/DF_Energia_GMinutos.RData")
load(file="Datos/DF_Energia_GHoras.RData")
load(file="Datos/DF_Energia_GDiaria.RData")
load(file="Datos/DF_Energia_GMensual.RData")
```



# Preparación para analizar los datos. Series temporales



## Objetivo

Proyección del consumo energético a través de series temporales.

## Procedimiento

Estudiaremos los datos de consumo energético correspondientes a los años 2007 a 2009 a través de series temporales. 

Haremos proyección de futuro para el año 2010 y compararemos los resultados con los datos reales de este último año (serie real).

## Plot POA


Vamos a analizar la serie temporal del submedidor 3, aire acondicionado y termo eléctrico. Vamos a extraer 52 observaciones opr año, esto es igual a una observación diaria. Lunes a las 20h.
Años 2007, 2008 y 2009



```{r}
## Subset
house070809weekly <- filter(DatosCompletos, weekday == 2 & hour == 20 & minute == 1 & year != 2006 & year != 2010 )
## Creamos un objeto TS
tsSM3_070809weekly <- ts(house070809weekly$Sub_metering_3, frequency=52, start=c(2007,1))


```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM3_070809weekly, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Serie Temporal del aire acondicionado y termo eléctrico")
```


## Evolución mensual del consumo. Años 2007-2009


Vamos a representar la serie por meses para cada submedidor y tambien para la energía global co granularidad mensual. En este caso, la frecuencia será 12, tenemos una observación por mes para los años 2007,8 y 2009.


```{r}
seriesMensuales <- Granularidad_meses %>% filter(year != 2006 & year != 2010)
## Creamos un objeto TS
tsSM1_Mensual<- ts(seriesMensuales$Sub_metering_1, frequency=12, start=c(2007,1))
tsSM2_Mensual<- ts(seriesMensuales$Sub_metering_2, frequency=12, start=c(2007,1))
tsSM3_Mensual<- ts(seriesMensuales$Sub_metering_3, frequency=12, start=c(2007,1))
tsSM_GAP_Mensual<- ts(seriesMensuales$Global_active_power, frequency=12, start=c(2007,1))
```

```{r}
par(mfrow=c(2,2))
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Mensual, ts.colour = 'red', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la cocina \n Años 2007-2009")
autoplot(tsSM2_Mensual, xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Mensual, ts.colour = 'blue', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
autoplot(tsSM_GAP_Mensual, ts.colour = 'green', xlab = "Año", ylab = "Energía (Varios-hora)", main = "Evolución mensual del consumo de energía \n Años 2007-2009")
```


Parece que los datos tienen estacionariedad (movimientos que se repiten cada año), esto ocurre para todas las variables.


## Evolución diaria del consumo por meses

En este caso, crearemos una serie para cada mes, ya que la frecuencia de los datos no será la misma, al tener cada mes un número de días diferente.

### Mes de Enero

```{r}
par(mfrow=c(2,2))
seriesDiariasEnero <- Granularidad_dias %>% filter(year != 2006 & year != 2010 & month == 1)
## Creamos un objeto TS
   tsSM1_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_1, frequency=31, start=c(2007,1))
   
   tsSM2_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_2, frequency=31, start=c(2007,1))
   
   tsSM3_DiariaEnero<- ts(seriesDiariasEnero$Sub_metering_3, frequency=31, start=c(2007,1))
   
tsSM_GAP_DiariaEnero<- ts(seriesDiariasEnero$Global_active_power, frequency=31, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_DiariaEnero, ts.colour = 'red', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la cocina en el mes de Enero \n Años 2007-2009")
autoplot(tsSM2_DiariaEnero, xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la lavandería en el mes de Enero \n Años 2007-2009")
autoplot(tsSM3_DiariaEnero, ts.colour = 'blue', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía del aire acondicionado y termo eléctrico en el mes de Enero \n Años 2007-2009")
autoplot(tsSM_GAP_DiariaEnero, ts.colour = 'green', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía en el mes de Enero \n Años 2007-2009")
```

Parece que no existen muchos patrones que nos podrían ayudar a hacer predicciones, no serían muy fiables. (gráfica muelle)








### Mes de Febrero

```{r}
seriesDiariasFebrero <- Granularidad_dias %>% filter(year != 2006 & year != 2010 & month == 2)
## Creamos un objeto TS
   tsSM1_DiariaFebrero<- ts(seriesDiariasFebrero$Sub_metering_1, frequency=28, start=c(2007,1))
   tsSM2_DiariaFebrero<- ts(seriesDiariasFebrero$Sub_metering_2, frequency=28, start=c(2007,1))
   tsSM3_DiariaFebrero<- ts(seriesDiariasFebrero$Sub_metering_3, frequency=28, start=c(2007,1))
tsSM_GAP_DiariaFebrero<- ts(seriesDiariasFebrero$Global_active_power, frequency=28, start=c(2007,1))
```

```{r}
par(mfrow=c(2,2))
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_DiariaFebrero, ts.colour = 'red', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la cocina en el mes de Febrero \n Años 2007-2009")
autoplot(tsSM2_DiariaFebrero, xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la lavandería en el mes de Febrero \n Años 2007-2009")
autoplot(tsSM3_DiariaFebrero, ts.colour = 'blue', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía del aire acondicionado y termo eléctrico en el mes de Febrero \n Años 2007-2009")
autoplot(tsSM_GAP_DiariaFebrero, ts.colour = 'green', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía en el mes de Febrero \n Años 2007-2009")
```











### Mes de Marzo

```{r}
par(mfrow=c(2,2))
seriesDiariasMarzo <- Granularidad_dias %>% filter(year != 2006 & year != 2010 & month == 3)
## Creamos un objeto TS
   tsSM1_DiariaMarzo<- ts(seriesDiariasMarzo$Sub_metering_1, frequency=31, start=c(2007,1))
   tsSM2_DiariaMarzo<- ts(seriesDiariasMarzo$Sub_metering_2, frequency=31, start=c(2007,1))
   tsSM3_DiariaMarzo<- ts(seriesDiariasMarzo$Sub_metering_3, frequency=31, start=c(2007,1))
tsSM_GAP_DiariaMarzo<- ts(seriesDiariasMarzo$Global_active_power, frequency=28, start=c(2007,1))
```

```{r}
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_DiariaMarzo, ts.colour = 'red', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la cocina en el mes de Marzo \n Años 2007-2009")
autoplot(tsSM2_DiariaMarzo, xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía de la lavandería en el mes de Marzo \n Años 2007-2009")
autoplot(tsSM3_DiariaMarzo, ts.colour = 'blue', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía del aire acondicionado y termo eléctrico en el mes de Marzo \n Años 2007-2009")
autoplot(tsSM_GAP_DiariaMarzo, ts.colour = 'green', xlab = "Día", ylab = "Energía (Varios-hora)", main = "Evolución diaria del consumo de energía en el mes de Marzo \n Años 2007-2009")
```




















## Evolución semanal del consumo. Años 2007-2009


Vamos a representar la serie por meses para cada submedidor y tambien para la energía global co granularidad mensual. En este caso, la frecuencia será 12, tenemos una observación por mes para los años 2007,8 y 2009.


```{r}
Granularidad_semanas <- Granularidad_horas %>% group_by(year, week) %>% 
   summarize(
      Sub_metering_1 = sum (Sub_metering_1),
      Sub_metering_2 = sum (Sub_metering_2),
      Sub_metering_3 = sum (Sub_metering_3),
      Global_active_power = sum (Global_active_power),
      energia2 = sum (energia2)
   ) 



seriesSemanales <- Granularidad_semanas %>% filter(year != 2006 & year != 2010)
## Creamos un objeto TS
   tsSM1_Semanal<- ts(seriesSemanales$Sub_metering_1,         frequency=7, start=c(2007,1))
   tsSM2_Semanal<- ts(seriesSemanales$Sub_metering_2,         frequency=7, start=c(2007,1))
   tsSM3_Semanal<- ts(seriesSemanales$Sub_metering_3,         frequency=7, start=c(2007,1))
tsSM_GAP_Semanal<- ts(seriesSemanales$Global_active_power, frequency=7, start=c(2007,1))
```

```{r}
par(mfrow=c(2,2))
## Plot sub-meter 3 with autoplot - add labels, color
autoplot(tsSM1_Semanal, ts.colour = 'red', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la cocina \n Años 2007-2009")
autoplot(tsSM2_Semanal, xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía de la lavandería \n Años 2007-2009")
autoplot(tsSM3_Semanal, ts.colour = 'blue', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía del aire acondicionado y termo eléctrico \n Años 2007-2009")
autoplot(tsSM_GAP_Semanal, ts.colour = 'green', xlab = "Semana del año", ylab = "Energía (Varios-hora)", main = "Evolución semanal del consumo de energía \n Años 2007-2009")
```


Muelle




## Forecasting antes de descomponer la serie


Vamos a plicar regresión lineal a cada serie temporal, y veremos el valor de $R^2$ y del error cuadrático medio.


### Evolución mensual del consumo. Años 2007-2009


#### Modelo

```{r}
fitSM3 <- tslm(tsSM3_070809weekly ~ trend + season) 
summary(fitSM3)
```

Resultados:

- Valor del coeficiente de determinación: 0.2639. Es un valor muy bajo, el modelo únicamente explica el 28% de la variabilidad total.

- No hay coeficientes significativamente no nulos (p.valores > 0.05). El modelo los supone todos nulos (significativamente)

#### Predicción IC

Predicción para los próximos 20 días

```{r}
## Create sub-meter 3 forecast with confidence levels 80 and 90
forecastfitSM3c <- forecast(fitSM3, h=20, level=c(80,90))
## Plot sub-meter 3 forecast, limit y and add labels
plot(forecastfitSM3c, ylim = c(0, 20), ylab= "Watt-Hours", xlab="Time",
     main="Predicción del consumo energético a través de un modelo de regresión")
```


Había predicciones negativas, esto es muy grave. No puede haber un consumo negativo de energía.


### Evolución diaria del consumo por meses



#### Modelo

```{r}
fitSM3_DiariaEnero <- tslm(tsSM3_DiariaEnero ~ trend + season) 
summary(fitSM3_DiariaEnero)
```

Resultados:

- Valor del coeficiente de determinación: 0.3269. Es un valor muy bajo, el modelo únicamente explica el 28% de la variabilidad total.

- Solo hay tres coeficientes significativamente no nulos

#### Predicción IC

```{r}
## Create sub-meter 3 forecast with confidence levels 80 and 90
PrediccionSM3_DiariaEnero <- forecast(fitSM3_DiariaEnero,h = 31)
## Plot sub-meter 3 forecast, limit y and add labels
plot(PrediccionSM3_DiariaEnero , ylab= "Watt-Hours", xlab="Time",
     main="Predicción del consumo energético \n a través de un modelo de regresión")
```




### Evolución semanal del consumo. Años 2007-2009

#### Submetering 1

##### Modelo

```{r}
fitSM1_Semanal <- tslm(tsSM1_Semanal ~ trend + season) 
summary(fitSM1_Semanal)
```

Resultados:

- Valor del coeficiente de determinación:  0.04277. Es un valor extremadamente bajo, el modelo únicamente explica el 4.8% de la variabilidad total. Las predicciones no serán nada fiables

- Solo hay un coeficiente significativamente no nulo

##### Predicción IC

```{r}
## Create sub-meter 3 forecast with confidence levels 80 and 90
PrediccionSM1_Semanal <- forecast(fitSM1_Semanal,h = 48)
## Plot sub-meter 3 forecast, limit y and add labels
plot(PrediccionSM1_Semanal, ylab= "Watt-Hours", xlab="Time", 
     main="Predicción del consumo energético \n a través de un modelo de regresión")
```
Predicciones nada fiables, además de los gigantes IC



#### Submetering 2

##### Modelo

```{r}
fitSM2_Semanal <- tslm(tsSM2_Semanal ~ trend + season) 
summary(fitSM2_Semanal)
```

Resultados:

- Valor del coeficiente de determinación:  0.04866. Es un valor extremadamente bajo, el modelo únicamente explica el 4.8% de la variabilidad total. Las predicciones no serán nada fiables

- Solo hay dos coeficientes significativamente no nulos

##### Predicción IC

```{r}
## Create sub-meter 3 forecast with confidence levels 80 and 90
PrediccionSM2_Semanal <- forecast(fitSM2_Semanal,h = 48)
## Plot sub-meter 3 forecast, limit y and add labels
plot(PrediccionSM2_Semanal, ylab= "Watt-Hours", xlab="Time", 
     main="Predicción del consumo energético \n a través de un modelo de regresión")
```
Predicciones nada fiables, además de los gigantes IC








#### Submetering 3

##### Modelo

```{r}
fitSM3_Semanal <- tslm(tsSM3_Semanal ~ trend + season) 
summary(fitSM3_Semanal)
```

Resultados:

- Valor del coeficiente de determinación:  0.04866. Es un valor extremadamente bajo, el modelo únicamente explica el 4.8% de la variabilidad total. Las predicciones no serán nada fiables

- Solo hay dos coeficientes significativamente no nulos

##### Predicción IC

```{r}
## Create sub-meter 3 forecast with confidence levels 80 and 90
PrediccionSM3_Semanal <- forecast(fitSM3_Semanal,h = 48)
## Plot sub-meter 3 forecast, limit y and add labels
plot(PrediccionSM3_Semanal, ylab= "Watt-Hours", xlab="Time", 
     main="Predicción del consumo energético \n a través de un modelo de regresión")
```
Predicciones nada fiables, además de los gigantes IC










### Comparación de los coeficientes de cada modelo





```{r}
DatosRealesMensualSM3_Enero<-
as.data.frame(Granularidad_dias %>% filter( year == 2010 & month == 1)%>% select('Sub_metering_3') )[,3]
RMSE_SM3_GranMensual_Enero<-accuracy(PrediccionSM3_DiariaEnero  ,DatosRealesMensualSM3_Enero)[4]
R2_SM3_GranMensual_Enero<-0.3269
```



```{r}
DatosRealesSemanasSM1<-as.data.frame(Granularidad_semanas %>% filter(year == 2010) %>% select('Sub_metering_1') )[,2]
RMSE_SM1_GranSemanas<-accuracy(PrediccionSM1_Semanal ,DatosRealesSemanasSM1)[4]
R2_SM1_GranSemanas<-0.04277
```



```{r}
DatosRealesSemanasSM2<-as.data.frame(Granularidad_semanas %>% filter(year == 2010) %>% select('Sub_metering_2') )[,2]
RMSE_SM2_GranSemanas<-accuracy(PrediccionSM2_Semanal ,DatosRealesSemanasSM2)[4]
R2_SM2_GranSemanas<-0.1839
```




```{r}
DatosRealesSemanasSM3<-as.data.frame(Granularidad_semanas %>% filter(year == 2010) %>% select('Sub_metering_3') )[,2]
RMSE_SM3_GranSemanas<-accuracy(PrediccionSM3_Semanal ,DatosRealesSemanasSM3)[4]
R2_SM3_GranSemanas<-0.04866
```



```{r}
cbind.data.frame(
      Submedidor=c("Cocina","Lavadero","AC y TermoE"),
      RMSE = c(RMSE_SM1_GranSemanas,RMSE_SM2_GranSemanas,RMSE_SM3_GranSemanas),
      R2 = c(R2_SM1_GranSemanas,R2_SM2_GranSemanas,R2_SM3_GranSemanas)
)
```



## Forecasting descomponiendo la serie (así ok)



Descomponer: quitar tendencia




### Descomposición y visualización

```{r}
## Descomponer la serie
components070809SM3weekly <- decompose(tsSM3_070809weekly)
## Plot
plot(components070809SM3weekly)
## Check summary statistics for decomposed sub-meter 3 
summary(components070809SM3weekly)
```

#### Evolución semanal del consumo. Años 2007-2009

##### Submetering 1

```{r}
## Descomponer la serie
Componentes_SM1_Semanal <- decompose(tsSM1_Semanal)
## Plot
plot(Componentes_SM1_Semanal )
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM1_Semanal )
```


Componente estacional muy fuerte, tendencia no.



##### Submetering 2

```{r}
## Descomponer la serie
Componentes_SM2_Semanal <- decompose(tsSM2_Semanal)
## Plot
plot(Componentes_SM2_Semanal )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM2_Semanal )
```


##### Submetering 3

```{r}
## Descomponer la serie
Componentes_SM3_Semanal <- decompose(tsSM3_Semanal)
## Plot
plot(Componentes_SM3_Semanal )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM3_Semanal )
```















#### Evolución mensual del consumo. Años 2007-2009

##### Submetering 1

```{r}
## Descomponer la serie
Componentes_SM1_Mensual <- decompose(tsSM1_Mensual)
## Plot
plot(Componentes_SM1_Mensual )
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM1_Mensual )
```


Componente estacional muy fuerte, tendencia no.



##### Submetering 2

```{r}
## Descomponer la serie
Componentes_SM2_Mensual <- decompose(tsSM2_Mensual)
## Plot
plot(Componentes_SM2_Mensual )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM2_Mensual )
```


##### Submetering 3

```{r}
## Descomponer la serie
Componentes_SM3_Mensual <- decompose(tsSM3_Mensual)
## Plot
plot(Componentes_SM3_Mensual )
## Check summary statistics for decomposed sub-meter 2
summary(Componentes_SM3_Mensual )
```
















#### Evolución diaria del consumo por meses para los años 2007-2009

##### Submetering 1

```{r}
## Descomponer la serie
Componentes_SM1_DiariaEnero <- decompose(tsSM1_DiariaEnero)
## Plot
plot(Componentes_SM1_DiariaEnero  )
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM1_DiariaEnero  )
```


Tendencia creciente, parece que no hay mucha estacionalidad.



##### Submetering 2

```{r}
## Descomponer la serie
Componentes_SM2_DiariaEnero <- decompose(tsSM2_DiariaEnero)
## Plot
plot(Componentes_SM2_DiariaEnero  )
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM2_DiariaEnero  )
```


##### Submetering 3

```{r}
## Descomponer la serie
Componentes_SM3_DiariaEnero <- decompose(tsSM3_DiariaEnero)
## Plot
plot(Componentes_SM3_DiariaEnero  )
## Check summary statistics for decomposed sub-meter 1
summary(Componentes_SM3_DiariaEnero  )
```














